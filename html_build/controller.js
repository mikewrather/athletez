define(["facade","collections","models","utils"],function(e,t,n,r){var i,s=t.ApplicationStates,o=n.EventModel,u=e._,a=e.$,f=r.lib.Channel,l=e.Backbone.Model.extend;return i=function(e){e=e||{},this.route=e.route,i.prototype.appStates?e.appStates&&(i.prototype.appStates=e.appStates):i.prototype.appStates=new s,this.route&&i.prototype.appStates&&this.getStoredState(),this.initialize(e)},i.extend=l,i.prototype={initialize:function(e){return this.triggerPublishers(),u.bindAll(this),this.handleOptions(e),this.addSubscribers(),this.handleDeferreds(),this},generateRandomNumber:function(){var e=(new Date).getTime();return e+=Math.floor(Math.random()*200+1),e},setupSections:function(){},setupScheme:function(){},setupLayout:function(){var e;return this.layout=e,this.layout},handleDeferreds:function(){var e=this;a.when(null).then(function(){})},addSubscribers:function(){},removeSubscribers:function(){},triggerPublishers:function(){},meta:{activeViews:[],viewNames:[]},handleOptions:function(e){i.prototype.handleOptions(e)},routeChange:function(e){i.prototype.routeChange(options)},addStateChangeSubscriber:null},i.prototype.data=null,i.prototype.layout=null,i.prototype.scheme=[],i.prototype.sections={},i.prototype.route=null,i.prototype.handleOptions=function(e){e&&e.useFixtures&&this.useFixturesForWebServices()},i.prototype.transitionActiveViews=function(e){var t,n=this.layout,r=this.meta.sectionName,i=this.meta.activeViews=[];e=e||this.meta.presentation,t=function(t,s){s===e&&(t.state()==="not-rendered"&&t.render(),n.transition(r,t),i.push(s))},this.iterateOverLayoutViews(t)},i.prototype.renderInActiveViews=function(){var e;e=function(e){e.state()==="not-rendered"&&(e.callbacks.add(function(){e.state("not-displayed")}),e.render())},this.iterateOverLayoutViews(e)},i.prototype.iterateOverLayoutViews=function(e){var t=this.meta.activeViews,n=this.sections,r=this.meta.viewNames,i,s,o;for(o=0;o<r.length;o++)i=r[o],u.contains(t,i)||(s=n[i],e&&u.isFunction(e)&&e(s,i))},i.prototype.routeChange=function(e,t,n){var r={data:{}},s;if(e&&!u.isString(e))throw s="Controller routeChange expects string as 1st argument.",new Error(s);this.route=e,this.layout&&(this.layout.state({route:e}),r.data=this.layout.state(),u.extend(r,t||{}),i.prototype.appStates.add(r),this.data=r.data,debug.log(r),i.prototype.appStates.save(e)),n&&u.isFunction(n)&&n(this.data),debug.log("Controller routeChange method called with: "+e)},i.prototype.getStoredState=function(){var e;if(!this.route)throw new Error("Controller does not have route property.");return e=i.prototype.appStates.findInCollectionOrStorage(this.route),this.data=e&&e.data?e.data:e,this.data},i.prototype.addStateChangeSubscriber=function(e,t){function s(r,s){var o=e,a=t,f=n,l;f.layout&&(l=f.layout.state(),l&&i.prototype.appStates.add({name:f.route,data:l,expires:new Date(Date.now()+4032e4),storage:"localStorage"})),a&&u.isFunction(a)&&a(r,s)}var n=this,r;if(!e||!u.isString(e))throw r="controller method addStateChangeSubscriber expected string as 1st argument.",new Error(r);f(e+":stateChanged").subscribe(s)},i.prototype.remove=function(){var e;this.layout&&this.layout.remove();for(e in this)delete this[e]},i.prototype.webServices={},i.prototype.useFixturesForWebServices=function(){},i});