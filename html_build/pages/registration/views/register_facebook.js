define(["require","text!registration/templates/register_facebook.html","backbone","facade","views","utils","vendor","jquery.pstrength","registration/collections/fbimages","registration/views/fbimage-list"],function(e,t){var n,r=e("facade"),i=e("views"),s=e("vendor"),o=s.Mustache,u=e("utils"),a=u.lib.Channel,f=i.SectionView,l=e("registration/collections/fbimages"),c=e("registration/views/fbimage-list");return n=f.extend({id:"main-content",events:{keypress:"stopSubmit"},template:t,initialize:function(e){function s(e){i.$(".picture").attr("src",e)}function o(){i.initFBPictures()}function u(){i.initUploadImage()}this.callback=e.callback;var t=$.parseJSON(this.model.request.responseText);if(t.exec_data.exec_error){var n=!0,r=t.exec_data.error_array[0].error;this.model.set("errorDisplay",!0),this.model.set("errorValue",r)}var i=this;if(!this.model)throw new Error("RegistrationFacebookView expected options.model.");i.parseFBData(this.model.get("payload")),f.prototype.initialize.call(this,e),a("registration-change-picture").subscribe(s),a("registration-diff-fbpicture").subscribe(o),a("registration-upload-image").subscribe(u)},childViews:{},render:function(e,t,n){var r={};r.height="500px",r.width="650px",r.title="Register With Facebook - "+this.model.get("payload").name,r.id="fb-reg-pop",r.html=o.to_html(this.template,this.model.toJSON()),routing.trigger("common-popup-open",r),$("#fb-reg-pop .next").bind("click",this.nextStep),$("#fb-reg-pop div.edit").bind("click",this.changeField),$("#fb-reg-pop .diff_fb_pic").bind("click",this.diffFBPicture),$("#fb-reg-pop .upload_new_image").bind("click",this.uploadNewImage)},stopSubmit:function(e){var t=e.keyCode?e.keyCode:e.which;t==13&&e.preventDefault()},diffFBPicture:function(e){e.preventDefault(),this.initFBPictures()},uploadNewImage:function(e){e.preventDefault(),this.initUploadImage()},parseFBData:function(e){e.hs_exists=e.high_school?!0:!1,e.dob_exists=e.birthday?!0:!1,e.email_exists=e.email?!0:!1,this.model.set("payload",e)},initFBPictures:function(){var e=this;this.fbimages?(debug.log(e.fbimages.toJSON(),"else"),this.fbImageListView=new c({collection:e.fbimages.toJSON()})):(this.fbimages=new l,this.fbimages.fetch(),$.when(this.fbimages.request).done(function(){debug.log("this.fbimages are as follows"),debug.log(e.fbimages.toJSON()),this.fbImageListView=new c({collection:e.fbimages.toJSON()})}))},setupFBPictures:function(){var e=this;this.fbImageListView=new c({collection:this.fbimages});var t=this.addChildView(this.fbImageListView);this.childViews.fbImageListView=this.fbImageListView,this.callbacks.add(function(){t()}),this.fbImageListView.render(),this.$el.append(e.fbImageListView.el),$("#"+this.fbImageListView.id).dialog({width:"80%",close:e.removeListView})},removeListView:function(){this.childViews.fbImageListView.removeCropView()},initUploadImage:function(){alert("Upload Image")},changeField:function(e){e.preventDefault(),$(e.target).fadeOut();var t=$(e.target).parent().find("input");t.removeAttr("disabled").focus()},nextStep:function(e){e.preventDefault();var t=this,n=$("#fb-reg-pop :input").serializeArray(),r=this.model.get("payload");$.each(n,function(e,t){r[t.name]=t.value});if(r["password"]==""||r["password-again"]==""){alert("Please input a password");return}if(r["password"]!=r["password-again"]){alert("Please input a password correctly");return}if(r["agree"]==null){alert("Please agree to the Terms of Service");return}this.model.attributes.id=!1,this.model.set({payload:r,id:1}),this.model.url=function(){return testpath?testpath+"/user/basics":"/api/user/basics/"+r.users_id},this.model.save({callback:"true"},{success:function(e){$("#RegModal").modal("hide"),t.callback&&_.isFunction(t.callback)?(routing.trigger("common-popup-close"),t.callback(function(){window.location.reload()})):window.location.href="#usersettings"}})}}),n});