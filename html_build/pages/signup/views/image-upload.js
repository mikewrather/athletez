define(["require","text!signup/templates/imageupload.html","backbone","underscore","views","facade","utils","jquery.jrac"],function(e,t,n,r){var i,s=e("facade"),o=e("views"),u=e("utils"),a=u.lib.Channel,f=n.View;return i=f.extend({initialize:function(e){this.template=r.template(t),this.$el=$(e.destination),this.render()},render:function(){this.$el.html(this.template),this.userinfo(this.options.attr)},events:{"change input":"preview","click #crpimgup":"imageupload","click #skip":"skip"},skip:function(e){e.preventDefault(),window.location.href="#usersettings"},userinfo:function(e){},preview:function(e){this.removeCropView();var t=window.URL||window.webkitURL;window.fileURL=t.createObjectURL(e.target.files[0]),this.srcimg=window.fileURL,$("#image-select").attr({src:window.fileURL}),this.initCropView()},initCropView:function(){$("#image-select").jrac({crop_width:200,crop_height:240,crop_aspect_ratio:"1:1",crop_x:0,crop_y:0,crop_resize:!1,viewport_resize:!1,viewport_onload:function(){var e=this,t=e.$container.parent(".pane").find(".coords input:hidden"),n=["jrac_crop_x","jrac_crop_y","jrac_crop_width","jrac_crop_height","jrac_image_width","jrac_image_height"];for(var r=0;r<n.length;r++){var i=n[r];e.observator.register(i,t.eq(r)),t.eq(r).bind(i,function(e,t,n){$(this).val(n)}).change(i,function(t){var n=t.data;e.$image.scale_proportion_locked=e.$container.parent(".pane").find(".coords input:checkbox").is(":checked"),e.observator.set_property(n,$(this).val())})}e.$container.append('<div class="natual-size">Image natual size: '+e.$image.originalWidth+" x "+e.$image.originalHeight+"</div>")}}).bind("jrac_events",function(e,t){var n=$(this).parents(".pane").find(".coords input");n.css("background-color",t.observator.crop_consistent()?"chartreuse":"salmon")})},imageupload:function(e){e.preventDefault(),this.getImageInfo()},removeCropView:function(){$("#image-select").jrac("destroy"),$("#image-select").parent().find(".natual-size").remove()},getImageInfo:function(){var e=[],t=this.$(".coords :input").serializeArray();e.image_url=this.srcimg,$.each(t,function(t,n){e[n.name]=n.value}),this.model.save(e,{success:function(e){a("upload-user-image").publish(e)},error:function(){}})}}),i});