define(["require","text!game/templates/header.html","facade","views","game/models/score","game/models/basics","votes/models/vote","votes/models/follow","usercontrols/location/views/location","usercontrols/location/models/verify-adress","usercontrols/location/models/save"],function(e,t){var n,r=e("facade"),i=e("views"),s=e("game/models/score"),o=e("game/models/basics"),u=e("votes/models/vote"),a=e("votes/models/follow"),f=e("usercontrols/location/views/location"),l=e("usercontrols/location/models/verify-adress"),c=e("usercontrols/location/models/save"),h=i.SectionView;return n=h.extend({id:"main-header",template:t,events:{"click .edit-score-h":"editScore","blur .edit-score-input-h":"resumeEditScore","click .vote":"vote","click .follow":"follow","click .object-edit-h":"editObject","click .object-delete-h":"deleteObject","submit .update-date-time-h":"updateDateTime","click .game-edit-btn-h":"openEditPopup","click .verify-address-h":"verifyAddress","blur .address-h":"verifyAddress"},location:{lat:undefined,lon:undefined},initialize:function(e){h.prototype.initialize.call(this,e);var t=this.model.get("payload"),n;t.teams.length?(n=t.teams[0].org_name+" VS "+t.teams[1].org_name,n+=" "+t.shared.complevel):n=t.event_name,n+=" | "+t.shared.sport+" | "+t.game_day,document.title=n},checkForUser:function(){return!_.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},openEditPopup:function(){if(!this.checkForUser()){$(".signup-email").trigger("click");return}$("#modalPopupGameEdit").modal(),this.location.lon=this.model.get("payload").location.lon,this.location.lat=this.model.get("payload").location.lat,this.showLocation()},showLocation:function(){routing.trigger("show_location",this.location.lat,this.location.lon,".view-map-h",function(){})},setLocation:function(e){var t=confirm("Are you sure want to set new address?");if(t&&this.locationId){var n=new c;n.id=this.game_id,n.set({locations_id:this.locationId,id:this.game_id}),n.save(),$.when(n.request).done(function(){routing.trigger("popup-close")})}},verifyAddress:function(){var e=this,t=e.$el.find(".address-h").val();e.adressModel=new l,e.adressModel.address=t,e.adressModel.url(),e.adressModel.set({address:t}),e.adressModel.showError=function(t,n){try{e.$el.find(".set-address-h").addClass("link-disabled"),e.$el.find(".address-error-status-h").removeClass("hide").html(n.responseJSON.exec_data.error_array[0].error)}catch(r){}e.$el.find(".address-h").addClass("address-field-error").removeClass("address-verified")},e.adressModel.save({dataType:"json"}),e.$el.find(".address-h").removeClass("address-verified"),$.when(e.adressModel.request).done(function(){console.log(e.adressModel.toJSON()),e.locationId=e.adressModel.get("payload").id,e.locationId&&(e.$el.find(".address-error-status-h").addClass("hide"),e.$el.find(".address-h").removeClass("address-field-error").addClass("address-verified"),e.location.lon=e.adressModel.get("payload").lon,e.location.lat=e.adressModel.get("payload").lat,e.showLocation(),e.$el.find(".set-address-h").removeClass("link-disabled"))})},editObject:function(){alert("Coming soon")},deleteObject:function(){alert("Coming soon")},gameEditBtn:function(){this.$el.find(".update-date-time-h").removeClass("hide")},updateDateTime:function(e){e.preventDefault();var t=this,n=this.$el.find(".date-time-h").val(),r=new c;r.id=this.model.id,r.set({game_datetime:n,locations_id:this.locationId,id:this.model.id}),r.save(),$.when(r.request).done(function(){t.updateHeaderData(r.id)})},updateHeaderData:function(e){var t=this;t.model.id=e,t.model.fetch(),$.when(t.model.request).done(function(){console.error(t.model.toJSON()),$("#modalPopupGameEdit").modal("hide"),t.render()})},cancelDateTimeBtn:function(){this.$el.find(".update-date-time-h").addClass("hide")},afterRender:function(){this.$el.find(".image-outer-h").mouseover(function(){$(this).find(".action-block").css({opacity:90})}).mouseout(function(){$(this).find(".action-block").css({opacity:0})}),this.$el.find(".date-time-h").datetimepicker({timeFormat:"hh:mm:ss",dateFormat:"yy-mm-dd",showTimezone:!0,changeMonth:!0,changeYear:!0})},vote:function(e){e.preventDefault(),console.log(this.model);var t=new u;t.userId=this.model.id,t.entity_id=this.model.get("payload").enttypes_id,t.setData(),t.save()},follow:function(e){e.preventDefault(),console.log(e.target);var t=new a;t.userId=this.model.id,t.entity_id=this.model.get("payload").enttypes_id,t.save()},editScore:function(e){$(e.currentTarget).hide(),$(e.currentTarget).parents(".score-box-h").find(".edit-score-input-h").attr("type","text").focus()},resumeEditScore:function(e){var t=new s;t.teams_id=$(e.currentTarget).data("id"),t.score=$(e.target).val(),t.gameId=this.model.id,t.set({id:$(e.target).data("id"),games_teams_link_id:$(e.target).data("id"),score:$(e.target).val()}),t.save(),this.$el.find(".edit-score-input-h").attr("type","hidden"),this.$el.find(".edit-score-h").show(),$.when(t.request).done(function(){$(e.currentTarget).parents(".score-box-h").find(".edit-score-h span").html(t.get("score"))})},childViews:{},render:function(e,t,n){h.prototype.render.call(this,e,t,n)}}),n});