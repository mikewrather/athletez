define(["require","text!imageup/templates/uploader.html","text!imageup/templates/select_all.html","text!usercontrols/tag/templates/layout.html","facade","views","utils","vendor","imageup/models/basic","imageup/views/errors","usercontrols/tag/views/main"],function(e,t,n,r){var i,s=e("facade"),o=e("views"),u=e("utils"),a=u.lib.Channel,f=e("vendor"),l=o.SectionView,c=e("imageup/models/basic"),h=e("imageup/views/errors"),p=s.$,d=s._,v=u.debug,m=e("usercontrols/tag/views/main");return v.log("SectionView: ",l),i=l.extend({id:"imageuploadForm",events:{"click #imageup":"imageUploadClick","change #image_file":"imagePreview","dragover #imageholder":"drag","drop #imageholder":"drop","click #btn_select_all_h":"selectAllImages"},template:t,data:t,tagCollection:[],initialize:function(e,t){p("#errormsg, #preview").html(""),l.prototype.initialize.call(this,e),v.log("Image upload basic view"),this.attr=t,this.files_drag=[],this.scheme=e.scheme,this.layout=e.layout,this.dropedImage=e.dropedImage,a("tag-team-image-success").empty(),a("tag-team-image-success","nomemory").subscribe(this.tagFunction),a("tag-team-image-success").unsubscribe(this.tagFunction),a("tag-team-image-success").subscribe(this.tagFunction),this.setUpBottomView(),p("#imgUploadModal").modal("show"),p("#imgUploadModal").on("hidden",function(){routing.trigger("refresh-onImageUpload")}),p("#imgUploadModal").on("hide",function(){routing.trigger("refresh-onImageUpload")}),console.log(p(".modal-body").html())},drag:function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"},drop:function(e){var t=this;e.stopPropagation(),e.preventDefault(),p("#errormsg").hide();var n=e.originalEvent.dataTransfer.files;this.files_drag=e.originalEvent.dataTransfer.files,n.length>0&&t.showLoader(t);var r=[],i=[],s=0;for(var o=0,u;u=n[o];o++){if(!u.type.match("image.*"))continue;var a=new FileReader;a.onload=function(e){return function(r){var o="preview_"+s;s++,i.push({preview_id:o,width:"250",height:"250",filesrc:r.target.result,title:escape(e.name)}),s==n.length&&(data={data:i},p("#image_file").attr("disabled","disabled"),routing.trigger("imageup-preview",data)),t.hideLoader()}}(u),t.showSelectAllImages(),a.readAsDataURL(u)}},imagePreview:function(e){var t=this;v.log("Image preview view"),p("#preview").hide(),p("#errormsg").hide();var n=p("#image_file")[0].files;console.log(n.length),n.length>0&&t.showLoader(t);var r=[],i=0,s,o=0;for(;s=n[i];i++){if(!s.type.match("image.*"))continue;var u=new FileReader;u.onload=function(e){return function(i){var s="preview_"+o;o++,r.push({preview_id:s,width:"250",height:"250",filesrc:i.target.result,title:escape(e.name)}),o==n.length&&(data={data:r},routing.trigger("imageup-preview",data),t.hideLoader())}}(s),u.readAsDataURL(s)}t.showSelectAllImages()},imageUploadClick:function(e){e.preventDefault();var t=this;p("#errormsg").hide(),p("#imageup").attr("disabled","disabled"),p(".closepreview").attr("disabled","disabled"),p(".rotate").attr("disabled","disabled");if(p(".previewimg").length==0){var n={msg:"Image Field Empty",color:"alert-error"};routing.trigger("imageup-msg",n),p("#imageup").removeAttr("disabled")}else if(this.dropedImage)jQuery.each(this.dropedImage.data[0].drag_info,function(e,n){var i=new FormData;if(p("#preview_"+e+"group").length>0){i.append("image_file",n),p("#preview_"+e+"rotang").val()>0?i.append("rotate",p("#preview_"+e+"rotang").val()):i.append("rotate","false");for(var s in t.attr)i.append(s,t.attr[s]);var o={dataum:i,id:e,len:r};routing.trigger("imageup-add-image",o)}}),this.files_drag=[],p("#imageup").removeAttr("disabled");else if(this.files_drag.length>=1){var r=this.files_drag.length;jQuery.each(this.files_drag,function(e,n){var i=new FormData;if(p("#preview_"+e+"group").length>0){i.append("image_file",n),p("#preview_"+e+"rotang").val()>0?i.append("rotate",p("#preview_"+e+"rotang").val()):i.append("rotate","false");for(var s in t.attr)i.append(s,t.attr[s]);var o=p("#preview_"+e+"group").attr("tagIndex");o!=null&&o>-1&&(tagData=t.tagCollection[o]||{},i.append("tag",JSON.stringify(tagData)));var u={dataum:i,id:e,len:r};routing.trigger("imageup-add-image",u)}}),this.files_drag=[],p("#imageup").removeAttr("disabled")}else console.log(p("#image_file")[0].files.length+"=file prasobh"),jQuery.each(p("#image_file")[0].files,function(e,n){var r=new FormData;if(p("#preview_"+e+"group").length>0){r.append("image_file",n),p("#preview_"+e+"rotang").val()>0?r.append("rotate",p("#preview_"+e+"rotang").val()):r.append("rotate","false");for(var i in t.attr)r.append(i,t.attr[i]);var s=p("#preview_"+e+"group").attr("tagIndex");s!=null&&s>-1&&(tagData=t.tagCollection[s]||{},r.append("tag",JSON.stringify(tagData)));var o={dataum:r,id:e,len:p("#image_file")[0].files.length};routing.trigger("imageup-add-image",o)}}),p("#imageup").removeAttr("disabled")},setUpBottomView:function(){p("#main-content-tag-section").fadeIn(),this.setUpSelectAllView(),this.setUpTagView()},setUpSelectAllView:function(){var e=this;p("#select-allup").html(n)},setUpTagView:function(){var e=this;this.tagView=new m({model:this.model,template:r,name:"tag-image "+(new Date).toString(),destination:"#image-tagging",user_id:e.user_id||null,channel:"tag-team-image-success"}),this.scheme.push(this.tagView),this.layout.render()},tagFunction:function(e){this.tagCollection.push(e);var t=p(".previewimg.selected");console.log("selected",t);var n=this.tagCollection.length-1;n>-1&&t.attr("tagIndex",n),console.log("tagCollection",this.tagCollection),this.setUpTagView()},selectAllImages:function(e){p(".previewimg").addClass("selected"),p("#select-allup").hide(),p("#image-tagging").show()},showSelectAllImages:function(){p("#select-allup").show(),p("#image-tagging").hide()}}),i});