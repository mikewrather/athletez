define(["require","text!imageup/templates/uploader.html","text!imageup/templates/select_all.html","text!usercontrols/tag/templates/layout.html","facade","views","utils","vendor","imageup/models/basic","imageup/views/errors","usercontrols/tag/views/main"],function(e,t,n,r){var i,s=e("facade"),o=e("views"),u=e("utils"),a=u.lib.Channel,f=e("vendor"),l=o.SectionView,c=e("imageup/models/basic"),h=e("imageup/views/errors"),p=s.$,d=s._,v=u.debug,m=e("usercontrols/tag/views/main");return v.log("SectionView: ",l),i=l.extend({id:"imageuploadForm",events:{"click #imageup":"imageUploadClick","change #image_file":"imagePreview","dragover #imageholder":"drag","drop #imageholder":"drop","click #btn_select_all_h":"selectAllImages"},template:t,data:t,tagCollection:[],tagData:{1:[],5:[],8:[]},"const":{User:1,Team:5,Game:8},files_byUploader:[],files_drag:[],initialize:function(e,t){p("#errormsg, #preview").html(""),l.prototype.initialize.call(this,e),console.log("Image upload basic view"),this.attr=t,this.files_drag=[],this.scheme=e.scheme,this.layout=e.layout,this.dropedImage=e.dropedImage,this.attr?this.sports_id=this.attr.sports_id||null:this.sports_id=null,a("tag-team-image-success").empty(),a("tag-team-image-success").subscribe(this.tagFunction),p("#imgUploadModal").modal("show"),p("#imgUploadModal").on("hidden",function(){routing.trigger("refresh-onImageUpload")}),p("#imgUploadModal").on("hide",function(){routing.trigger("refresh-onImageUpload")})},drag:function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"},drop:function(e){var t=this;e.stopPropagation(),e.preventDefault(),p("#errormsg").hide(),this.files_drag=this.files_drag||[];var n=e.originalEvent.dataTransfer.files;n.length>0&&t.showLoader(t);var r=[];t.dataum=t.dataum||[];var i=t.dataum.length;for(var s=0,o;o=n[s];s++){if(!o.type.match("image.*"))continue;this.files_drag.push(o);var u=new FileReader;u.onload=function(e){return function(n){var r="preview_"+i;i++,t.dataum.push({preview_id:r,width:"250px",height:"250px",filesrc:n.target.result,title:escape(e.name)}),data={data:t.dataum},p("#image_file").attr("disabled","disabled"),routing.trigger("imageup-preview",data),t.hideLoader()}}(o),t.setUpBottomView(),u.readAsDataURL(o)}},imagePreview:function(e){var t=this;v.log("Image preview view"),p("#preview").hide(),p("#errormsg").hide(),this.files_byUploader=this.files_byUploader||[];var n=p("#image_file")[0].files;n.length>0&&t.showLoader(t),t.dataum=t.dataum||[];var r,i=t.dataum.length,s=0;for(;r=n[s];s++){if(!r.type.match("image.*"))continue;t.files_byUploader.push(r);var o=new FileReader;o.onload=function(e){return function(n){var r="preview_"+i;i++,t.dataum.push({preview_id:r,width:"250px",height:"250px",filesrc:n.target.result,title:escape(e.name)}),console.log("data**************************"),data={data:t.dataum},console.log(data),routing.trigger("imageup-preview",data),t.hideLoader()}}(r),o.readAsDataURL(r)}t.setUpBottomView()},imageUploadClick:function(e){e.preventDefault();var t=this;p("#errormsg").hide(),p("#imageup").attr("disabled","disabled"),p(".closepreview").attr("disabled","disabled"),p(".rotate").attr("disabled","disabled");if(p(".previewimg").length==0){var n={msg:"Image Field Empty",color:"alert-error"};routing.trigger("imageup-msg",n),p("#imageup").removeAttr("disabled")}else if(this.dropedImage){var r=this.files_drag.length;jQuery.each(this.dropedImage.data[0].drag_info,function(e,n){var i=new FormData;if(p("#preview_"+e+"group").length>0){i.append("image_file",n),p("#preview_"+e+"rotang").val()>0?i.append("rotate",p("#preview_"+e+"rotang").val()):i.append("rotate","false");for(var s in t.attr)console.error(s,t.attr[s]),i.append(s,t.attr[s]);var o={dataum:i,id:e,len:r};console.log(o),routing.trigger("imageup-add-image",o)}}),this.files_drag=[],p("#imageup").removeAttr("disabled")}else if(this.files_drag.length>=1){var r=this.files_drag.length;jQuery.each(this.files_drag,function(e,n){var i=new FormData;if(p("#preview_"+e+"group").length>0){i.append("image_file",n),p("#preview_"+e+"rotang").val()>0?i.append("rotate",p("#preview_"+e+"rotang").val()):i.append("rotate","false");for(var s in t.attr)console.error(s,t.attr[s]),i.append(s,t.attr[s]);var o=t.getTagData(p("#preview_"+e+"group"));i.append("tag",JSON.stringify(o));var u={dataum:i,id:e,len:r};console.log(u),routing.trigger("imageup-add-image",u)}}),this.files_drag=[],p("#imageup").removeAttr("disabled")}else console.log("file_byUploader"),console.log(this.files_byUploader),jQuery.each(t.files_byUploader,function(e,n){var r=new FormData;if(p("#preview_"+e+"group").length>0){r.append("image_file",n),p("#preview_"+e+"rotang").val()>0?r.append("rotate",p("#preview_"+e+"rotang").val()):r.append("rotate","false");for(var i in t.attr)r.append(i,t.attr[i]);var s=t.getTagData(p("#preview_"+e+"group"));r.append("tag",JSON.stringify(s));var o={dataum:r,id:e,len:t.files_byUploader.length};routing.trigger("imageup-add-image",o)}}),t.files_byUploader=[],p("#imageup").removeAttr("disabled");this.dataum=[]},getTagData:function(e){var t=p(e).attr("gameIndex"),n=p(e).attr("teamIndex"),r=p(e).attr("userIndex"),i={1:[],5:[],8:[]};if(t>-1){var s=this.tagData[this.const.Game][t];s&&(i[this.const.Game]=s)}if(n>-1){var s=this.tagData[this.const.Team][n];s&&(i[this.const.Team]=s)}if(r>-1){var s=this.tagData[this.const.User][r];s&&(i[this.const.User]=s)}return i},setUpBottomView:function(){p("#main-content-tag-section").fadeIn(),this.setUpSelectAllView(),this.setUpTagView()},setUpSelectAllView:function(){var e=this;p("#select-allup").html(n),e.showSelectAllImages()},setUpTagView:function(){var e=this;this.tagView=new m({model:this.model,template:r,name:"tag-image "+(new Date).toString(),destination:"#image-tagging",user_id:e.user_id||null,sports_id:e.sports_id,channel:"tag-team-image-success"}),this.scheme.push(this.tagView),this.layout.render()},tagFunction:function(e){var t=this;this.tagCollection.push(e);var n=0,r=p(".previewimg.selected");console.log("selected",r);for(var i in e)t.tagData[i]=t.tagData[i]||[],t.tagData[i].push(e[i]),n=t.tagData[i].length-1,i==t.const.Game?r.attr("gameIndex",n):i==t.const.Team?r.attr("teamIndex",n):i==t.const.User&&r.attr("userIndex",n)},selectAllImages:function(e){p(".previewimg").addClass("selected"),p("#select-allup").hide(),p("#image-tagging").show()},showSelectAllImages:function(){p("#select-allup").show(),p("#image-tagging").hide()}}),i});