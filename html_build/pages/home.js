define(["require","text!pages/home/templates/layout.html","backbone","facade","controller","models","views","utils","pages/home/models/menu","packages/location/models/city","signup/models/registerbasic","packages/sport/collections/sports","pages/home/collections/image","location/collections/states","pages/home/views/menu","pages/home/views/image-list","pages/home/views/state-list","packages/sport/views/sport-list","signup/views/registerbasic","packages/location/views/city"],function(e,t,n){var r,i=e("facade"),s=e("controller"),o=e("models"),u=e("views"),a=e("utils"),f=e("packages/sport/collections/sports"),l=e("location/collections/states"),c=e("pages/home/collections/image"),h=e("pages/home/models/menu"),p=e("packages/location/models/city"),d=e("signup/models/registerbasic"),v=e("pages/home/views/menu"),m=e("signup/views/registerbasic"),g=e("pages/home/views/image-list"),y=e("pages/home/views/state-list"),b=e("packages/sport/views/sport-list"),w=e("packages/location/views/city"),E=u.LayoutView,S=i.$,x=i._,T=a.lib.Channel,N=[base_url+"pages/home/home.css",base_url+"vendor/plugins/qtip/qtip.css"];return r=s.extend({searchPage:0,initialize:function(e){return T("load:css").publish(N),x.bindAll(this),e.params&&this.setParamsArray(e.params),this.handleOptions(e),e.userId&&(this.userId=e.userId),this.scheme=[],this.genderTypes=["boys","girls","both"],this.init(),this},init:function(){this.initUrlOptions(),this.createData(),this.handleDeferreds()},initUrlOptions:function(){this.searchUrls=["/api/video/search","/api/image/search","/api/user/search","/api/game/search","/api/team/search"];var e=!!x.isUndefined(this.base)||this.base==""&&this.base!=0?1:this.base;this.baseUrl=this.searchUrls[e],this.urlOptions={sports_id:this.sports_id||"0",cities_id:this.cities_id||"0",orderby:this.orderby||"random",time:this.time||"DAY",states_id:this.states_id||"0",searchtext:this.searchtext||"",country_id:this.country_id||"0"},this.urlOptionByPageView={restype:["base"],location:["cities_id","states_id","country_id"],view:["orderby"],sports:["sports_id"]},this.menuValues=[{page:"view",src:".view-options-h .browse.select",target:".view-link-h .option-heading-h",input:!1,defaultValue:"ORDER"},{page:"sports",src:".sports-option-h .sport.select",target:".sport-link-h .option-heading-h",input:!1,defaultValue:"ALL SPORTS"},{page:"location",src:"#city",target:".location-link-h .option-heading-h",input:!0,defaultValue:"PLACE"},{page:"restype",src:"#resulttype a.restype.select",target:".restype-link-h .option-heading-h",input:!1,defaultValue:"ATHLETES"}],this.viewOptions=["orderby","time"],this.sportsOptions=["sports_id"],this.locationOptions=["cities_id","states_id","country_id"]},addSubscribers:function(){var e=this;x.each(this.genderTypes,function(e){T("sportChanged:"+this.collections[e].cid,"unique").subscribe(this.changeSportFilter)},this),T("cityChanged:"+this.sections.city.id,"unique").subscribe(this.changeCityFilter),routing.off("stateChanged"),routing.on("stateChanged",function(t){e.changeStateFilter(t)}),T("resetIndividual","unique").subscribe(this.updateIndividual),T("textChanged","unique").subscribe(this.updateText),T("viewFilterChanged","unique").subscribe(this.changeViewFilter),T("baseUrlChanged","unique").subscribe(this.updateBaseUrl),T("resetFilter","unique").subscribe(this.resetFilter)},setupScheme:function(){var e,t=this.params;for(e=0;e<this.meta.activeViews.length;e++)this.scheme.push(this.sections[this.meta.activeViews[e]])},updateIndividual:function(e){for(var t in this.menuValues)this.menuValues[t].page==e&&(this.menuValues[t].input?S(this.menuValues[t].src).val(""):S(this.menuValues[t].src).removeClass("select"));switch(e){case"view":for(var t in this.viewOptions)this.viewOptions[t]=="orderby"?(S(".dropdown-menu .browse").removeClass("select"),this.urlOptions[this.viewOptions[t]]="random"):t=="time"&&(this.urlOptions[this.viewOptions[t]]="today");break;case"sports":for(var t in this.sportsOptions)this.urlOptions[this.sportsOptions[t]]="0";break;case"restype":this.baseUrl=this.searchUrls[0];break;case"location":for(var t in this.locationOptions)this.urlOptions[this.locationOptions[t]]="0"}this.updateUrlAfterReset(this.urlOptionByPageView[e]),this.transitionView()},updateUrlAfterReset:function(e){var t=window.location.hash;if(e&&e.length)for(var n in e){var r=new RegExp(e[n]+"/[0-9a-zA-Z]+/","i"),i=new RegExp(e[n]+"/[0-9a-zA-Z]+","i");r.test(t)?t=t.replace(r,""):i.test(t)&&(t=t.replace(i,""))}routing.navigate(t,{trigger:!1})},initSections:function(){this.setupMenuView(),x.each(this.genderTypes,this.setupSportListView),x.each(["top-rated","search-result"],this.setupImageListView),this.setupLocationDDView(),this.setupScheme(),this.setupLayout().render(),this.setUpRegistrationView(),this.cityView&&this.cityView.initPlugin(),this.userId&&S(".register-wrapper, .register-wrapper-h").hide().html(""),routing.mobile&&S("[data-uk-scrollspy]").on("uk.scrollspy.inview",function(){console.log("Element is visible.")})},updateBaseUrl:function(e){this.baseUrl=this.searchUrls[e];var t={base:e};this.transitionView(t)},updateText:function(e){this.urlOptions.searchtext=e;var t={searchtext:e};this.transitionView(t)},changeViewFilter:function(e){e.submenu==="browse"?options={orderby:e.value}:options={time:e.value},options.orderby=="random"?S(".left-arrow-page").fadeOut():S(".left-arrow-page").fadeIn(),this.transitionView(options)},changeSportFilter:function(e){var t={sports_id:e.attributes.payload.sport_id};this.transitionView(t)},changeStateFilter:function(e){var t={states_id:e};this.transitionView(t)},changeCityFilter:function(e){S(".menu-detail-h").hide(),S(".reset-option-btn-h[data-type=city]").removeClass("hide"),e.label&&S("#city").val(e.label);var t={cities_id:e.id,states_id:e.state_id,country_id:e.country_id};this.transitionView(t)},resetFilter:function(e){for(var t in this.menuValues)this.menuValues[t].input?S(this.menuValues[t].src).val(""):S(this.menuValues[t].src).removeClass("select");switch(e){case"view":for(var t in this.viewOptions)this.viewOptions[t]=="orderby"?(S(".dropdown-menu .browse").removeClass("select"),this.urlOptions[this.viewOptions[t]]="random"):t=="time"&&(this.urlOptions[this.viewOptions[t]]="today");break;case"sports":for(var t in this.sportsOptions)this.urlOptions[this.sportsOptions[t]]="0";break;case"location":for(var t in this.locationOptions)this.urlOptions[this.locationOptions[t]]="0"}this.removeParamsFromUrl(),this.transitionView()},transitionView:function(e){this.searchPage=0,this.searchView(e)},manageHomePageUrl:function(e){var t,n=window.location.hash.match("home")?window.location.hash:window.location.hash+"/!home";n=n.match("search")?n:n+"/search";if(e)for(var r in e)if(!x.isUndefined(e[r])&&(e[r]!=""||e[r]=="0")){var i=new RegExp(r+"/(.*)[0-9a-zA-Z]","i"),s=new RegExp(r+"/(.*)[0-9a-zA-Z]","i");i.test(n)?n=n.replace(i,r+"/"+e[r]):s.test(n)?n=n.replace(s,r+"/"+e[r]):(t=n[n.length-1]!="/"?"/":"",n+=t+r+"/"+e[r])}routing.navigate(n,{trigger:!1});var o=!this.currentHashURL||this.currentHashURL==n||!n.match("base")?!1:!0;return console.log(n,o),this.currentHashURL=n,o},removeParamsFromUrl:function(){routing.navigate("!home",{trigger:!1})},searchView:function(e){var t=this,r="search-result",i=this.collections[r],s=this,o=i.toJSON(),u=this.manageHomePageUrl(e);i.url=this.url(e),i.targetElement="#search-result",i.fetch({remove:!1});var a=a||null;S.when(i.request).done(function(){if(u){var e=new n.Collection;e.add(i.toJSON()),t.imageListView=new g({collection:i,name:r,destination:"#"+r,user_id:this.userId,media_id:a,pageName:"home",allItemsInCollection:e}),console.log(t.imageListView.allItemsInCollection),s.layout.transition(r,t.imageListView)}else t.imageListView.allItemsInCollection||(t.imageListView.allItemsInCollection=new n.Collection,t.imageListView.allItemsInCollection.add(o,{at:0})),t.imageListView.allItemsInCollection.add(i.toJSON());i.length<12&&S("[data-uk-scrollspy]").off("uk.scrollspy.inview"),S("[data-uk-scrollspy]").trigger("uk.scrollspy.outview")});for(var f in this.menuValues){if(this.menuValues[f].input)var l=S(this.menuValues[f].src).val();else var l=S(this.menuValues[f].src).text();l!=""?S(this.menuValues[f].target).html(l):S(this.menuValues[f].target).html(this.menuValues[f].defaultValue)}},bindLoadMoreContent:function(){var e=this;if(routing.mobile||1)S("[data-uk-scrollspy]").on("uk.scrollspy.inview",function(t){e.searchPage+=12,e.searchView()}),S("[data-uk-scrollspy]").on("uk.scrollspy.outview",function(e){console.log("OUTVIEW")})},bindCickEvents:function(){var e=this;S(document).on("click",".left-arrow-page-h",function(){e.searchPage-=12,e.searchView()}),S(document).on("click",".right-arrow-page-h",function(){e.searchPage+=12,e.searchView()}),e.bindLoadMoreContent(),e.searchPage==0?S(".left-arrow-page-h").addClass("disable-arrow-link"):S(".left-arrow-page-h").removeClass("disable-arrow-link")},url:function(e){var t=this.baseUrl+"?offset="+this.searchPage+"&";x.extend(this.urlOptions,e);var n=[];return S.each(this.urlOptions,function(e,t){n.push(e+"="+encodeURIComponent(t))}),t+=n.join("&"),this.media_id&&(t+="&media_id="+this.media_id),t},createData:function(){var e=this;e.collections={},e.collections["search-result"]=new c([],{url:e.url(),num:"12",media_id:e.media_id,targetElement:"#search-result"}),e.collections.state=new l,e.collections["top-rated"]=new c([],{url:"/api/user/search",num:"4",targetElement:"#top-rated"}),x.each(e.genderTypes,function(t){e.collections[t]=new f([],{name:t})})},handleDeferreds:function(){var e=this,t=[];x.each(this.collections,function(e,n,r){t.push(e.fetch())}),S.when.apply(S,t).done(e.initSections,e.addSubscribers)},setupImageListView:function(e){var t=new n.Collection;t.add(this.collections[e].toJSON()),this.imageListView=new g({collection:this.collections[e],name:e,destination:"#"+e,user_id:this.userId,media_id:this.media_id,pageName:"home",viewName:e,allItemsInCollection:t}),this.imageListView.render(),this.sections[e]=this.imageListView,this.meta.activeViews.push(e)},setupSportListView:function(e){var t;t=new b({collection:this.collections[e],name:e,id:e,sports_id:this.sports_id,destination:"#sport #"+e}),t.render(),this.sections[e]=t,this.meta.activeViews.push(e)},setUpRegistrationView:function(){var e;this.select_type=new d},setupMenuView:function(){var e=new h,t,n="menu",r=this.urlOptions;r.base=this.base,t=new v({model:e,name:n,destination:"#"+n,options:r}),t.render(),this.sections[n]=t,this.meta.activeViews.push(n)},setupLocationDDView:function(){var e,t="state",n=new p,r="city";this.cityView=new w({model:n,name:r,destination:"#location .city"}),this.cityView.render(),this.sections[r]=this.cityView,this.meta.activeViews.push(r)},setupLayout:function(){var e;return e=new E({scheme:this.scheme,destination:"#main",template:t,displayWhen:"ready"}),this.layout=e,this.bindCickEvents(),this.layout}}),r});