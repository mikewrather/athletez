define(["require","text!pages/home/templates/layout.html","facade","controller","models","views","utils","pages/home/models/menu","packages/location/models/city","signup/models/registerbasic","packages/sport/collections/sports","pages/home/collections/image","location/collections/states","pages/home/views/menu","pages/home/views/image-list","pages/home/views/state-list","packages/sport/views/sport-list","signup/views/registerbasic","packages/location/views/city"],function(e,t){var n,r=e("facade"),i=e("controller"),s=e("models"),o=e("views"),u=e("utils"),a=e("packages/sport/collections/sports"),f=e("location/collections/states"),l=e("pages/home/collections/image"),c=e("pages/home/models/menu"),h=e("packages/location/models/city"),p=e("signup/models/registerbasic"),d=e("pages/home/views/menu"),v=e("signup/views/registerbasic"),m=e("pages/home/views/image-list"),g=e("pages/home/views/state-list"),y=e("packages/sport/views/sport-list"),b=e("packages/location/views/city"),w=o.LayoutView,E=r.$,S=r._,x=u.lib.Channel,T=[base_url+"pages/home/home.css",base_url+"vendor/plugins/qtip/qtip.css"];return n=i.extend({searchPage:0,initialize:function(e){return x("load:css").publish(T),S.bindAll(this),e.params&&this.setParamsArray(e.params),this.handleOptions(e),e.userId&&(this.userId=e.userId),this.scheme=[],this.genderTypes=["boys","girls","both"],this.init(),this},init:function(){this.initUrlOptions(),this.createData(),this.handleDeferreds()},initUrlOptions:function(){this.searchUrls=["/api/video/search","/api/image/search","/api/user/search","/api/game/search","/api/team/search"];var e=!!S.isUndefined(this.base)||this.base==""&&this.base!=0?1:this.base;this.baseUrl=this.searchUrls[e],this.urlOptions={sports_id:this.sports_id||"0",cities_id:this.cities_id||"0",orderby:this.orderby||"random",time:this.time||"DAY",states_id:this.states_id||"0",searchtext:this.searchtext||"",country_id:this.country_id||"0"},this.urlOptionByPageView={restype:["base"],location:["cities_id","states_id","country_id"],view:["orderby"],sports:["sports_id"]},this.menuValues=[{page:"view",src:".view-options-h .browse.select",target:".view-link-h .option-heading-h",input:!1,defaultValue:"ORDER"},{page:"sports",src:".sports-option-h .sport.select",target:".sport-link-h .option-heading-h",input:!1,defaultValue:"ALL SPORTS"},{page:"location",src:"#city",target:".location-link-h .option-heading-h",input:!0,defaultValue:"PLACE"},{page:"restype",src:"#resulttype a.restype.select",target:".restype-link-h .option-heading-h",input:!1,defaultValue:"ATHLETES"}],this.viewOptions=["orderby","time"],this.sportsOptions=["sports_id"],this.locationOptions=["cities_id","states_id","country_id"]},addSubscribers:function(){var e=this;S.each(this.genderTypes,function(e){x("sportChanged:"+this.collections[e].cid,"unique").subscribe(this.changeSportFilter)},this),x("cityChanged:"+this.sections.city.id,"unique").subscribe(this.changeCityFilter),routing.off("stateChanged"),routing.on("stateChanged",function(t){e.changeStateFilter(t)}),x("resetIndividual","unique").subscribe(this.updateIndividual),x("textChanged","unique").subscribe(this.updateText),x("viewFilterChanged","unique").subscribe(this.changeViewFilter),x("baseUrlChanged","unique").subscribe(this.updateBaseUrl),x("resetFilter","unique").subscribe(this.resetFilter)},setupScheme:function(){var e,t=this.params;for(e=0;e<this.meta.activeViews.length;e++)this.scheme.push(this.sections[this.meta.activeViews[e]])},updateIndividual:function(e){for(var t in this.menuValues)this.menuValues[t].page==e&&(this.menuValues[t].input?E(this.menuValues[t].src).val(""):E(this.menuValues[t].src).removeClass("select"));switch(e){case"view":for(var t in this.viewOptions)this.viewOptions[t]=="orderby"?(E(".dropdown-menu .browse").removeClass("select"),this.urlOptions[this.viewOptions[t]]="random"):t=="time"&&(this.urlOptions[this.viewOptions[t]]="today");break;case"sports":for(var t in this.sportsOptions)this.urlOptions[this.sportsOptions[t]]="0";break;case"restype":this.baseUrl=this.searchUrls[0];break;case"location":for(var t in this.locationOptions)this.urlOptions[this.locationOptions[t]]="0"}this.updateUrlAfterReset(this.urlOptionByPageView[e]),this.transitionView()},updateUrlAfterReset:function(e){var t=window.location.hash;if(e&&e.length)for(var n in e){var r=new RegExp(e[n]+"/[0-9a-zA-Z]+/","i"),i=new RegExp(e[n]+"/[0-9a-zA-Z]+","i");r.test(t)?t=t.replace(r,""):i.test(t)&&(t=t.replace(i,""))}routing.navigate(t,{trigger:!1})},initSections:function(){this.setupMenuView(),S.each(this.genderTypes,this.setupSportListView),S.each(["top-rated","search-result"],this.setupImageListView),this.setupLocationDDView(),this.setupScheme(),this.setupLayout().render(),this.setUpRegistrationView(),this.cityView&&this.cityView.initPlugin(),this.userId&&E(".register-wrapper, .register-wrapper-h").hide().html("")},updateBaseUrl:function(e){this.baseUrl=this.searchUrls[e];var t={base:e};this.transitionView(t)},updateText:function(e){this.urlOptions.searchtext=e;var t={searchtext:e};this.transitionView(t)},changeViewFilter:function(e){e.submenu==="browse"?options={orderby:e.value}:options={time:e.value},options.orderby=="random"?E(".left-arrow-page").fadeOut():E(".left-arrow-page").fadeIn(),this.transitionView(options)},changeSportFilter:function(e){var t={sports_id:e.attributes.payload.sport_id};this.transitionView(t)},changeStateFilter:function(e){var t={states_id:e};this.transitionView(t)},changeCityFilter:function(e){E(".menu-detail-h").hide(),E(".reset-option-btn-h[data-type=city]").removeClass("hide"),e.label&&E("#city").val(e.label);var t={cities_id:e.id,states_id:e.state_id,country_id:e.country_id};this.transitionView(t)},resetFilter:function(e){for(var t in this.menuValues)this.menuValues[t].input?E(this.menuValues[t].src).val(""):E(this.menuValues[t].src).removeClass("select");switch(e){case"view":for(var t in this.viewOptions)this.viewOptions[t]=="orderby"?(E(".dropdown-menu .browse").removeClass("select"),this.urlOptions[this.viewOptions[t]]="random"):t=="time"&&(this.urlOptions[this.viewOptions[t]]="today");break;case"sports":for(var t in this.sportsOptions)this.urlOptions[this.sportsOptions[t]]="0";break;case"location":for(var t in this.locationOptions)this.urlOptions[this.locationOptions[t]]="0"}this.removeParamsFromUrl(),this.transitionView()},transitionView:function(e){this.searchPage=0,this.searchView(e)},manageHomePageUrl:function(e){var t,n=window.location.hash.match("home")?window.location.hash:window.location.hash+"/!home";n=n.match("search")?n:n+"/search";if(e)for(var r in e)if(!S.isUndefined(e[r])&&(e[r]!=""||e[r]=="0")){var i=new RegExp(r+"/(.*)[0-9a-zA-Z]","i"),s=new RegExp(r+"/(.*)[0-9a-zA-Z]","i");i.test(n)?n=n.replace(i,r+"/"+e[r]):s.test(n)?n=n.replace(s,r+"/"+e[r]):(t=n[n.length-1]!="/"?"/":"",n+=t+r+"/"+e[r])}routing.navigate(n,{trigger:!1})},removeParamsFromUrl:function(){routing.navigate("!home",{trigger:!1})},searchView:function(e){var t=this,n="search-result",r=this.collections[n];controller=this,this.manageHomePageUrl(e),r.url=this.url(e),r.targetElement="#search-result",r.fetch();var i=i||null;E.when(r.request).done(function(){r.length<12?E(".right-arrow-page-h").addClass("disable-arrow-link"):E(".right-arrow-page-h").removeClass("disable-arrow-link"),t.searchPage==0||controller.urlOptions.orderby=="random"?E(".left-arrow-page-h").addClass("disable-arrow-link"):E(".left-arrow-page-h").removeClass("disable-arrow-link");var e=new m({collection:r,name:n,destination:"#"+n,user_id:this.userId,media_id:i,pageName:"home"});controller.layout.transition(n,e)});for(var s in this.menuValues){if(this.menuValues[s].input)var o=E(this.menuValues[s].src).val();else var o=E(this.menuValues[s].src).text();o!=""?E(this.menuValues[s].target).html(o):E(this.menuValues[s].target).html(this.menuValues[s].defaultValue)}},bindCickEvents:function(){var e=this;E(document).on("click",".left-arrow-page-h",function(){e.searchPage-=12,e.searchView()}),E(document).on("click",".right-arrow-page-h",function(){e.searchPage+=12,e.searchView()}),e.searchPage==0?E(".left-arrow-page-h").addClass("disable-arrow-link"):E(".left-arrow-page-h").removeClass("disable-arrow-link")},url:function(e){var t=this.baseUrl+"?offset="+this.searchPage+"&";S.extend(this.urlOptions,e);var n=[];return E.each(this.urlOptions,function(e,t){n.push(e+"="+encodeURIComponent(t))}),t+=n.join("&"),this.media_id&&(t+="&media_id="+this.media_id),t},createData:function(){var e=this;e.collections={},e.collections["search-result"]=new l([],{url:e.url(),num:"12",media_id:e.media_id,targetElement:"#search-result"}),e.collections.state=new f,e.collections["top-rated"]=new l([],{url:"/api/user/search",num:"4",targetElement:"#top-rated"}),S.each(e.genderTypes,function(t){e.collections[t]=new a([],{name:t})})},handleDeferreds:function(){var e=this,t=[];S.each(this.collections,function(e,n,r){t.push(e.fetch())}),E.when.apply(E,t).done(e.initSections,e.addSubscribers)},setupImageListView:function(e){var t;t=new m({collection:this.collections[e],name:e,destination:"#"+e,user_id:this.userId,media_id:this.media_id,pageName:"home",viewName:e}),t.render(),this.sections[e]=t,this.meta.activeViews.push(e)},setupSportListView:function(e){var t;t=new y({collection:this.collections[e],name:e,id:e,sports_id:this.sports_id,destination:"#sport #"+e}),t.render(),this.sections[e]=t,this.meta.activeViews.push(e)},setUpRegistrationView:function(){var e;this.select_type=new p},setupMenuView:function(){var e=new c,t,n="menu",r=this.urlOptions;r.base=this.base,t=new d({model:e,name:n,destination:"#"+n,options:r}),t.render(),this.sections[n]=t,this.meta.activeViews.push(n)},setupLocationDDView:function(){var e,t="state",n=new h,r="city";this.cityView=new b({model:n,name:r,destination:"#location .city"}),this.cityView.render(),this.sections[r]=this.cityView,this.meta.activeViews.push(r)},setupLayout:function(){var e;return e=new w({scheme:this.scheme,destination:"#main",template:t,displayWhen:"ready"}),this.layout=e,this.bindCickEvents(),this.layout}}),n});