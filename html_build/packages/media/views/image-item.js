define(["vendor","views","utils","text!media/templates/image-item.html","text!media/templates/image-item-detail.html","votes/models/vote","votes/models/follow","utils/storage","chrome/views/header","common/models/delete","common/models/entparse"],function(e,t,n,r,i){var s,o=e.$,u=t.BaseView,a=e.Mustache,f=require("votes/models/vote"),l=require("utils/storage"),c=require("votes/models/follow"),h=require("common/models/delete"),p=require("chrome/views/header"),d=require("common/models/entparse");return s=u.extend({tagName:"li",className:"image",events:{"click .vote-h":"vote","click .follow-h":"follow","click .edit-h":"edit","click .delete-h":"delete","click .image-outer-h":"stopIfMobile"},initialize:function(e){this.template=r;if(e.length)for(var t in e)this[t]=e[t];e.mainView&&(this.mainView=e.mainView)},checkForUser:function(){return!_.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},stopIfMobile:function(e){routing.mobile&&e.preventDefault()},render:function(){function h(e){console.log(o(this),e)}var e=this,t=this.model.get("payload");if(_.isArray(t)||t.image_id==0)return!1;var n=routing.mobile?o(window).width()/3:220,r=new d({mpay:t,display_height:n,display_width:n}),i=r.parsedData;i._media_id=t.media_id;var s=a.to_html(this.template,i);this.$el.html(s);var u="120px",f="92px";this.$el.find(".image-item-container").mouseout(function(){o(this).find(".action-block").css({opacity:0}),o(this).find(".detail-view").css({bottom:"-"+f}),o(this).find(".detail-view.game").css({bottom:"-"+u})});var l=this.$el.find(".game-tile");if(l.length){var c=l.text().length;console.log(c),c<3?l.css({"font-size":"5em",top:"90px",left:"60px"}):c<5?l.css({"font-size":"4em",top:"90px",left:"40px"}):c<25?l.css("font-size","2em"):c<30?l.css({"font-size":"1.7em",top:"65px"}):c<40?l.css({"font-size":"1.5em",top:"50px"}):l.css("font-size","1em")}return i.imgData.maxwidth&&this.$el.find("img.list-thumbnail").css({"max-width":i.imgData.maxwidth,left:i.imgData.left}),i.imgData.maxheight&&this.$el.find("img.list-thumbnail").css({"max-height":i.imgData.maxheight,top:i.imgData.top}),i.show_play&&!routing.mobile&&this.$el.append('<div class="circle open-photo-player-h"><div class="play"></div></div>'),routing.mobile?this.$el.on("click",null,i,this.insertDetailView):(this.$el.find(".image-item-container").mouseover(function(){o(this).find(".detail-view").css({bottom:"0px"}),o(this).find(".action-block").css({opacity:90})}),this.$el.find(".circle").mouseover(function(){o(this).parent().find(".detail-view").css({bottom:"0px"}),o(this).parent().find(".action-block").css({opacity:90})})),this.$el.find(".vote-h").click(function(t){e.vote(t)}),this.$el.find(".follow-h").click(function(t){e.follow(t)}),this.$el.find(".edit-h").click(function(t){e.edit(t)}),this.$el.find(".delete-h").click(function(t){e["delete"](t)}),this.$el.find("a.image-outer-h").on("click",this.stopIfMobile),setTimeout(function(){if(e.$el.is(":visible"))console.log(e.$el.width()),e.$el.css("height",Math.floor(e.$el.width())),e.$el.find("div.image-item-container").css({height:e.$el.width(),"min-height":e.$el.width()});else{var t=Math.floor(o(window).width()*(e.$el.width()/100));console.log(t),e.$el.css("height",t),e.$el.find("div.image-item-container").css({height:t,"min-height":t})}},5),this},insertDetailView:function(e){var t=o(e.target).closest("li");t.parent().find("li.detail_row_mobile").remove(),t.parent().find("li").removeClass("selected"),t.addClass("selected");var n=Math.ceil((t.index()+1)/3)*3-1,r=_.extend({liid:"detail_"+e.data._enttypes_id+"_"+e.data._id},e.data);_.isUndefined(r._label)&&(r._label=r._sublabel[0].label);var s=_.template(i,r);console.log(n),console.log(r),t.parent().find("li:eq("+n+")").after(s)},vote:function(e){e.preventDefault(),e.stopPropagation();var t=this,n=function(n){var r=new f;r.subject_id=t.model.get("payload").id,r.entity_id=t.model.get("payload").enttypes_id,r.setData(),r.save(),o.when(r.request).done(function(){o(e.currentTarget).addClass("link-disabled").html("voted"),n&&n()})};t.checkForUser()?n():routing.trigger("showSignup",function(e){n(function(){e&&e()})})},follow:function(e){e.preventDefault(),console.log(e.target),e.stopPropagation();var t=this,n=function(n){var r=new c;r.subject_id=t.model.get("payload").id,r.entity_id=t.model.get("payload").enttypes_id,r.save(),o.when(r.request).done(function(){typeof r.get("payload").follower=="object"&&typeof r.get("payload").subject=="object"&&r.get("payload").id>0&&o(e.currentTarget).addClass("link-disabled").html("following"),n&&n()})};t.checkForUser()?n():routing.trigger("showSignup",function(e){n(function(){e&&e()})})},edit:function(e){e.stopPropagation(),e.preventDefault()},"delete":function(e){e.stopPropagation(),e.preventDefault(),deleteModel=new h,deleteModel.subject_id=o(e.currentTarget).attr("subject-id"),deleteModel.enttypes_id=o(e.currentTarget).attr("subject-type-id"),deleteModel.removeNode=o(e.currentTarget).parents("li.image"),deleteModel.destroyAndRemove(),this.mainView&&this.mainView.showAddButton&&_.isFunction(this.mainView.showAddButton)&&this.mainView.showAddButton()}}),s});