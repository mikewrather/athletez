define(["facade","views","utils","media/views/image-item","media/views/image-board","media/views/add-image","text!media/templates/image-list.html","votes/models/follow","common/views/add-description"],function(e,t,n,r,i,s,o){var u,a,f=e.$,l=e._,c=require("vendor"),h=require("votes/models/follow"),p=n.lib.Channel,d=require("common/views/add-description"),v=t.CollectionView,m=t.SectionView,g=c.Mustache;return a=v.extend(m.prototype),u=a.extend({__super__:v.prototype,template:o,_tagName:"li",_className:"image",page:0,page_limit:7,currentSection:"media",listView:".image-list",_view:r,events:{"click .see-more-h":"seeMore","click .open-photo-player-h":"initPhotoPlayer","dragover #image-place-holder":"drag","drop #image-place-holder":"drop","click .add-to-fans-h":"follow"},renderTemplate:function(){var e=g.to_html(this.template,{target:this.target_id});return this.$el.html(e),this},drag:function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"},checkForUser:function(){return!l.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},follow:function(e){e.preventDefault(),e.stopPropagation();if(!this.checkForUser()){routing.trigger("showSignup");return}var t=this,n=new h;n.subject_id=this.data.payload.id,n.entity_id=this.data.payload.enttypes_id,console.log(n),n.save(),f.when(n.request).done(function(){typeof n.get("payload").follower=="object"&&typeof n.get("payload").subject=="object"&&n.get("payload").id>0?(t.controllerObject.reloadFans(),f(e.currentTarget).parents("li").addClass("hide")):console.log("FAIL")})},drop:function(e){var t=this;e.stopPropagation(),e.preventDefault();var n=e.originalEvent.dataTransfer.files;this.files_drag=e.originalEvent.dataTransfer.files;var r=[],i=[],s=0;for(var o=0,u;u=n[o];o++){if(!u.type.match("image.*"))continue;var a=new FileReader;a.onload=function(e){return function(r){var o="preview_"+s;s++,i.push({preview_id:o,drag_info:t.files_drag,width:"150",height:"150",filesrc:r.target.result,title:escape(e.name)}),s==n.length&&(data={data:i},t.openImageUploader(data))}}(u),a.readAsDataURL(u)}},openImageUploader:function(e){var t=this.sport_id,n=this.target_url+this.target_id,r={sports_id:t},i=e;routing.trigger("add-image",n,r,i)},checkForUser:function(){return!l.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},initialize:function(t){console.log("IMAGE LIST",t);for(var n in t)this[n]=t[n];t.name?this.name=t.name:this.name="image list",this.teamName=t.teamName,this.pageName=t.pageName?t.pageName:"profile",t.collecton&&(this.collection=t.collection),t.dontrenderTemplate||this.renderTemplate();var r=this;if(!this.collection.limit){r.allData=this.collection.toArray();var i=r.allData.length;r.start=0,r.end=r.page_limit,r.page_limit=8}r.seeMore(),v.prototype.initialize.call(this,t);if(!this.collection)throw new Error("ImageListView expected options.collection.");var i=r.collection.toJSON().length;(!i||i<r.collection.limit)&&r.$el.find(".see-more-h").hide();if(!i){var s=e.Backbone.Model.extend({});new d({page:this.currentSection,target:this.$el,model:new s,teamName:this.teamName,name:"view - "+Math.random()})}l.bindAll(this),this.addSubscribers(),this.setupBoardView(),this.setupAddView(),r.media_id&&setTimeout(function(){routing.trigger("photo-player-init",undefined,r.collection,r.user_id,!0,r.pageName,r.target_id,r.media_id)},500)},initPhotoPlayer:function(e){var t=this,n=t.collection.limit,r=f(e.target).parents("li").index();r-=1,r<0&&(r=0),routing.trigger("photo-player-init",r,t.collection,t.user_id,!0,t.pageName,t.target_id)},seeMore:function(e){var t=this;if(e&&this.collection.limit)this.collection.offset+=this.collection.limit,this.collection.fetch({remove:!1}),f.when(t.collection.request).done(function(){var e=t.collection.toJSON().length;e<t.collection.limit&&t.$el.find(".see-more-h").hide()});else if(!this.collection.limit){var n=this.allData.length;e&&(this.start=this.end,this.end=this.end+this.page_limit),n<=this.end&&this.$el.find(".see-more-h").hide(),e?this.collection.add(this.allData.slice(this.start,this.end)):this.collection.reset(this.allData.slice(this.start,this.end)),this.page++,e&&(this.addSubscribers&&this.addSubscribers(),this.setupBoardView&&this.setupBoardView(),this.setupAddView&&this.setupAddView())}},childViews:{},setupAddView:function(){function r(e){t.model=e,t.render(),f(this.listView).append(t.el)}var e,t=new s({collection:this.collection}),n=this.addChildView(t);this.childViews.form=t,this.callbacks.add(function(){n()}),p("addimage:fetch").subscribe(r)},filterWithImageType:function(e){var t=this.collection;return f.each(t.models,function(t,n){n.selectImageType&&n.selectImageType(e)}),t},addButtons:function(){},setupBoardView:function(){function s(e){n.model=e,n.render()}this.addButtons();if(this.collection.size()==0)return;var e=this.filterWithImageType(this.imagetype),t,n=new i({collection:e,model:e.at(0)}),r=this.addChildView(n);this.childViews.board=n,this.callbacks.add(function(){r(),n.render(),f(this.listView).prepend(n.el)}),p("changeimage"+this.collection.id).subscribe(s)}}),u});