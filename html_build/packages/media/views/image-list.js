define(["facade","views","utils","media/views/image-item","media/views/image-board","media/views/add-image","text!media/templates/image-list.html","votes/models/follow"],function(e,t,n,r,i,s,o){var u,a,f=e.$,l=e._,c=require("vendor"),h=require("votes/models/follow"),p=n.lib.Channel,d=t.CollectionView,v=t.SectionView,m=c.Mustache;return a=d.extend(v.prototype),u=a.extend({__super__:d.prototype,template:o,_tagName:"li",_className:"image",page:0,page_limit:7,listView:".image-list",_view:r,events:{"click .see-more-h":"seeMore","click .open-photo-player-h":"initPhotoPlayer","dragover #image-place-holder":"drag","drop #image-place-holder":"drop","click .add-to-fans-h":"follow"},renderTemplate:function(){var e=m.to_html(this.template,{target:this.target_id});return this.$el.html(e),this},drag:function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"},checkForUser:function(){return!l.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},follow:function(e){e.preventDefault(),console.log(e.target),e.stopPropagation(),console.error(this.data);if(!this.checkForUser()){routing.trigger("showSignup");return}var t=this,n=new h;n.subject_id=this.data.payload.id,n.entity_id=this.data.payload.enttypes_id,console.log(n),n.save(),f.when(n.request).done(function(){typeof n.get("payload").follower=="object"&&typeof n.get("payload").subject=="object"&&n.get("payload").id>0?(t.controllerObject.reloadFans(),f(e.currentTarget).parents("li").addClass("hide")):console.log("FAIL")})},drop:function(e){var t=this;e.stopPropagation(),e.preventDefault();var n=e.originalEvent.dataTransfer.files;this.files_drag=e.originalEvent.dataTransfer.files;var r=[],i=[],s=0;for(var o=0,u;u=n[o];o++){if(!u.type.match("image.*"))continue;var a=new FileReader;a.onload=function(e){return function(r){var o="preview_"+s;s++,i.push({preview_id:o,drag_info:t.files_drag,width:"150",height:"150",filesrc:r.target.result,title:escape(e.name)}),s==n.length&&(data={data:i},t.openImageUploader(data))}}(u),a.readAsDataURL(u)}},openImageUploader:function(e){var t=this.sport_id,n=this.target_url+this.target_id,r={sports_id:t},i=e;routing.trigger("add-image",n,r,i)},checkForUser:function(){return!l.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},initialize:function(e){for(var t in e)this[t]=e[t];e.name?this.name=e.name:this.name="image list",this.pageName=e.pageName?e.pageName:"profile",e.collecton&&(this.collection=e.collection),e.dontrenderTemplate||this.renderTemplate();var n=this;n.allData=this.collection.toArray();var r=n.allData.length;n.start=0,n.end=n.page_limit,n.page_limit=8,n.seeMore(),d.prototype.initialize.call(this,e);if(!this.collection)throw new Error("ImageListView expected options.collection.");l.bindAll(this),this.addSubscribers(),this.setupBoardView(),this.setupAddView(),n.media_id&&setTimeout(function(){if(n.allData)for(var e in n.allData)if(n.media_id==n.allData[e].get("payload").media_id){routing.trigger("photo-player-init",e,n.allData,n.user_id,!0,n.pageName,n.target_id);break}},500)},initPhotoPlayer:function(e){var t=f(e.target).parents("li").index(),n=f("#add-media").length?1:0;t-=n,t<0&&(t=0),routing.trigger("photo-player-init",t,this.allData,this.user_id,!0,this.pageName,this.target_id)},seeMore:function(e){var t=this.allData.length;e&&(this.start=this.end,this.end=this.end+this.page_limit),t<=this.end&&this.$el.find(".see-more-h").hide(),e?this.collection.add(this.allData.slice(this.start,this.end)):this.collection.reset(this.allData.slice(this.start,this.end)),this.page++,e&&(this.addSubscribers&&this.addSubscribers(),this.setupBoardView&&this.setupBoardView(),this.setupAddView&&this.setupAddView())},childViews:{},setupAddView:function(){function r(e){t.model=e,t.render(),f(this.listView).append(t.el)}var e,t=new s({collection:this.collection}),n=this.addChildView(t);this.childViews.form=t,this.callbacks.add(function(){n()}),p("addimage:fetch").subscribe(r)},filterWithImageType:function(e){var t=this.collection;return f.each(t.models,function(t,n){n.selectImageType&&n.selectImageType(e)}),t},addButtons:function(){var e=this;setTimeout(function(){console.error(f("#add-icons").length),e.triggerItem&&!f("#add-icons").length&&(e.$el.find(e.listView).prepend('<li id="add-icons"></li>'),routing.trigger(e.triggerItem,"#add-icons"))},0)},setupBoardView:function(){function s(e){n.model=e,n.render()}this.addButtons();if(this.collection.size()==0)return;var e=this.filterWithImageType(this.imagetype),t,n=new i({collection:e,model:e.at(0)}),r=this.addChildView(n);this.childViews.board=n,this.callbacks.add(function(){r(),n.render(),f(this.listView).prepend(n.el)}),p("changeimage"+this.collection.id).subscribe(s)}}),u});