define(["facade","views","utils","media/views/image-item","media/views/image-board","media/views/add-image","text!media/templates/image-list.html"],function(e,t,n,r,i,s,o){var u,a,f=e.$,l=e._,c=require("vendor"),h=n.lib.Channel,p=t.CollectionView,d=t.SectionView,v=c.Mustache;return a=p.extend(d.prototype),u=a.extend({__super__:p.prototype,template:o,_tagName:"li",_className:"image",page:0,page_limit:8,listView:".image-list",_view:r,events:{"click .see-more-h":"seeMore","click .open-photo-player-h":"initPhotoPlayer","dragover #image-place-holder":"drag","drop #image-place-holder":"drop"},renderTemplate:function(){var e=v.to_html(this.template,{target:this.target_id});return this.$el.html(e),this},drag:function(e){e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="copy"},drop:function(e){var t=this;e.stopPropagation(),e.preventDefault();var n=e.originalEvent.dataTransfer.files;this.files_drag=e.originalEvent.dataTransfer.files;var r=[],i=[],s=0;for(var o=0,u;u=n[o];o++){if(!u.type.match("image.*"))continue;var a=new FileReader;a.onload=function(e){return function(r){var o="preview_"+s;s++,i.push({preview_id:o,drag_info:t.files_drag,width:"150",height:"150",filesrc:r.target.result,title:escape(e.name)}),s==n.length&&(data={data:i},t.openImageUploader(data))}}(u),a.readAsDataURL(u)}},openImageUploader:function(e){var t=this.sport_id,n=this.target_url+this.target_id,r={sports_id:t},i=e;routing.trigger("add-image",n,r,i)},checkForUser:function(){return!l.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},initialize:function(e){e.name?this.name=e.name:this.name="image list",this.pageName=e.pageName?e.pageName:"profile",e.collecton&&(this.collection=e.collection),this.target_id=e.target_id,this.target_url=e.target_url,this.sport_id=e.sport_id,this.user_id=e.user_id,this.media_id=e.media_id,this.renderTemplate();var t=this;t.allData=this.collection.toArray(),t.seeMore(),p.prototype.initialize.call(this,e);if(!this.collection)throw new Error("ImageListView expected options.collection.");l.bindAll(this),this.addSubscribers(),this.setupBoardView(),this.setupAddView(),t.media_id&&setTimeout(function(){if(t.allData)for(var e in t.allData)if(t.media_id==t.allData[e].get("payload").media_id){routing.trigger("photo-player-init",e,t.allData,t.user_id,!0);break}},500)},initPhotoPlayer:function(e){var t=f(e.target).parents("li").index();t<0&&(t=0),routing.trigger("photo-player-init",t,this.allData,this.user_id,!0,this.pageName)},seeMore:function(e){var t=this.allData.length,n=this.page*this.page_limit,r=n+this.page_limit;t<=r&&this.$el.find(".see-more-h").hide(),e?this.collection.add(this.allData.slice(n,r)):this.collection.reset(this.allData.slice(n,r)),this.page++,e&&(this.addSubscribers&&this.addSubscribers(),this.setupBoardView&&this.setupBoardView(),this.setupAddView&&this.setupAddView())},childViews:{},setupAddView:function(){function r(e){t.model=e,t.render(),f(this.listView).append(t.el)}var e,t=new s({collection:this.collection}),n=this.addChildView(t);this.childViews.form=t,this.callbacks.add(function(){n()}),h("addimage:fetch").subscribe(r)},filterWithImageType:function(e){var t=this.collection;return f.each(t.models,function(t,n){n.selectImageType&&n.selectImageType(e)}),t},setupBoardView:function(){function s(e){n.model=e,n.render()}if(this.collection.size()==0)return;var e=this.filterWithImageType(this.imagetype),t,n=new i({collection:e,model:e.at(0)}),r=this.addChildView(n);this.childViews.board=n,this.callbacks.add(function(){r(),n.render(),f(this.listView).prepend(n.el)}),h("changeimage"+this.collection.id).subscribe(s)}}),u});