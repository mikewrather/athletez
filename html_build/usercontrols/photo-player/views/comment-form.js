define(["require","text!usercontrols/photo-player/templates/comment-form.html","usercontrols/photo-player/models/commentonform","site/views/comment-form","models/base","views","chrome/views/header"],function(e,t,n,r,i){var s,o=e("views"),u=e("chrome/views/header"),a=o.BaseView;return s=a.extend({initialize:function(e){console.error(e),_.bindAll(this),this.setOptions(),a.prototype.initialize.call(this,e)},el:".comment-input-outer-h",template:t,events:{"click #comment-submit":"submitHandler","click .add-comment-h":"showCommentBox","keypress .photoplayer-comment-box":"addComment"},setOptions:function(e){if(!this.collection)throw new Error("comment form view expected options.collection.");this.model||(console.log("this.collection.id =",this.collection.id),this.model=new n({id:this.collection.id}),console.log(this.model.toJSON()),this.model.fetch())},checkForUser:function(){return!_.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},getCaret:function(e){if(e.selectionStart)return e.selectionStart;if(document.selection){e.focus();var t=document.selection.createRange();if(t==null)return 0;var n=e.createTextRange(),r=n.duplicate();return n.moveToBookmark(t.getBookmark()),r.setEndPoint("EndToStart",n),r.text.length}return 0},addComment:function(e){console.error(e);if(e.keyCode==13&&e.shiftKey){var t=$(e.currentTarget).val(),n=this.getCaret(e);t=t.substring(0,n)+"\n"+t.substring(n,t.length),e.stopPropagation()}else e.which===13&&!e.shiftKey&&(e.preventDefault(),this.submitHandler(e))},submitHandler:function(e){e.preventDefault();if(!this.checkForUser()){routing.trigger("showSignup");return}this.createOnEnter(e)},showCommentBox:function(){var e=this.$el.find(".add-comment-form-h");e.hasClass("hide")?e.removeClass("hide"):e.addClass("hide")},refreshComments:function(e){this.$("#new-comment").val("")},createOnEnter:function(e){var t=this.$el.find("#new-comment").val(),n=this;n.$(".submit-result").stop().fadeOut();if(t!=""){date=new Date;var r=new Array;r.comment=t,r.comment_date=date.toDateString(),r.subject_type_id=this.collection.subject_entity_type,r.subject_id=$(".large-image-h").attr("data-id");var s=new i(r);s.url=function(){return debug.log(n),_.isUndefined(n.collection.savePath)?testpath?testpath+"/user/comment/add":"/api/media/addcomment/"+r.subject_id+"?comment="+r.comment:"api"+n.collection.savePath},s.saveSuccess=function(e,t){i.prototype.saveSuccess.call(this,e,t);var r=e.get("exec_data"),s=e.get("payload"),o=e.get("desc");r.exec_error?$(".global-alert").addClass("alert-error").html(o).stop().fadeIn():$(".global-alert").addClass("alert-info").html(o).stop().fadeIn(),s.poster=s.name,s.poster_picture=s.user_picture,s.poster_email=s.email,console.log("thisresponse = ",t),n.collection.push(e),console.log("latest collectionsx",n.collection),n.refreshComments(),routing.on("profilecommentonlist:refresh",n.collection)},s.save()}},render:function(){return a.prototype.render.call(this),this.input=this.$("#new-comment"),console.log("run here now",this.el),this}}),s});