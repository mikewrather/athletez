define(["require","text!usercontrols/photo-player/templates/comments.html","text!usercontrols/tag/templates/layout.html","facade","controller","models","views","usercontrols/photo-player/collections/comments","usercontrols/photo-player/views/main","usercontrols/photo-player/views/comments","usercontrols/photo-player/collections/tags","usercontrols/photo-player/views/tags","usercontrols/photo-player/models/tags","usercontrols/tag/views/main","usercontrols/tag/models/basic_info"],function(e,t,n){var r,i=e("facade"),s=e("controller"),o=e("models"),u=e("views"),a=e("utils"),f=i.$,l=i._,c=a.debug,h=a.lib.Channel,p=u.LayoutView,d=i.Backbone,v=e("usercontrols/photo-player/collections/comments"),m=e("usercontrols/photo-player/collections/tags"),g=e("usercontrols/photo-player/views/main"),y=e("usercontrols/photo-player/views/comments"),b=e("usercontrols/photo-player/views/tags"),w=e("usercontrols/photo-player/models/tags"),E=e("usercontrols/tag/views/main"),S=e("usercontrols/tag/models/basic_info"),r=s.extend({cssArr:["/usercontrols/photo-player/photoPlayer.css"],events:{},initialize:function(e){var t=this;t.startPlayer(e)},startPlayer:function(e){var t=this;h("load:css").publish(this.cssArr),l.bindAll(this),e.id&&(this.id=e.id),this.index=e.index,e.userId&&(this.userId=e.userId),this.pageId=e.pageId,e.pageName&&(this.pageName=e.pageName),e.array&&(this.collectionArray=!0),this.mediaId=e.mediaId,e._collection&&(this._collection=e._collection),f(document).off("click","#photoPlayerModal .close"),f(document).on("click","#photoPlayerModal .close",function(){var e=window.location.hash;e.match(/\/media\/(.*)/g)&&(e=e.replace(/\/media\/(.*)/g,"")),routing.navigate(e,{trigger:!1})}),this.modelHTML='<div id="photoPlayerModal" class="modal region-loader photo-frame-model hide fade model-popup-h"><div class="photo-player-mask hide photo-player-mask-h"></div><div class="modal-body page-content-h"><div class="photo-player-area-h photo-player"></div><div class="photo-player-right-area"><div class="teamName-area"></div><div class="tags-area-h"></div><div class="comment-area coment-area-h"></div><div class="comment-input-outer-h comment-input-outer" class="clearfix"></div><div id="image-tagging-photo"></div></div></div></div>',routing.off("photo-player-section-reload"),routing.on("photo-player-section-reload",function(e,n,r){t.id=n,f("#image-tagging-photo").html(""),t.setUpCommentView(e,n),t.setUpTagView(e,n,r)}),routing.off("comments-fetch-new-form-data"),routing.on("comments-fetch-new-form-data",function(e,n,r){t.setUpCommentView(e,n,r)}),routing.off("tags-fetch-new-form-data"),routing.on("tags-fetch-new-form-data",function(e,n,r){t.setUpTagView(e,n,r)}),this.setupLayout().render(),this.setUpMainView(),this.handleDeferreds()},checkForUser:function(){return!l.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},handleDeferreds:function(){},setupLayout:function(){this.scheme=[],f(".model-popup-h").remove(),f("body").append(this.modelHTML);var e=new p({scheme:this.scheme,destination:"#modalPopup",template:"",displayWhen:"ready"});return this.layout=e,f("#photoPlayerModal").modal("show"),this.layout},setUpMainView:function(){var e=this;if(e.collectionArray){var t=e._collection.limit,n=e._collection.offset,r=d.Collection.extend(),i=new r;e._collection.limit=undefined,e._collection.offset=0,i.url=e._collection.url,i.fetch({success:function(t){e.setupPhotoPlayerView(t)},error:function(e,t){console.error(e,t)}})}else{var s=e._collection.toJSON(),o={},r=d.Collection.extend(),i=new r;o.payload=[];for(var u in s)o.payload.push(s[u].payload);i.reset(o),e.setupPhotoPlayerView(i),console.error(i,i.toJSON())}},setupPhotoPlayerView:function(e){var t=this;f("#photoPlayerModal").removeClass("region-loader"),t._collection&&t._collection.limit&&(t._collection.limit=limit),t._collection&&t._collection.offset&&(t._collection.offset=offset);var n=new g({model:e.models[0],name:"photo player",destination:".photo-player-area-h",index:t.index,pageName:t.pageName,pageId:t.pageId,user_id:t.userId||null,sports_id:t.sports_id||null,scheme:t.scheme,layout:t.layout,mediaId:t.mediaId}),r=f(document).width(),i=r-350;f("#photoPlayerModal .photo-player-area-h").css({width:i+"px"}),t.scheme.push(n),t.layout.render()},setUpTagView:function(e,t,n){var r=this.scheme.length;for(var i=0;i<r;i++)this.scheme[i].name==this.oldTagView&&this.scheme[i].remove();var s=this;s.oldTagView="tag section"+Math.random(),f(".tags-area-h").unbind().html(""),s.tags=new m,s.tags.id=t,s.tags.targetElement=".tags-area-h",s.tags.fetch(),console.log("Looking for media obj",n),f.when(s.tags.request).done(function(){var t=new w,r=new b({collection:s.tags,userId:s.userId,name:s.oldTagView,model:t,uploader:n,entity_type_id:e,destination:".tags-area-h"});s.scheme.push(r),s.layout.render()})},setUpCommentView:function(e,n){var r=this.scheme.length;for(var i=0;i<r;i++)this.scheme[i].name==this.oldView&&this.scheme[i].remove();var s=this,o;s.oldView="comment section"+Math.random(),f(".coment-area-h, .comment-input-outer-h").unbind().html(""),s.commentson=new v,s.commentson.subject_entity_type=e,s.commentson.id=n,s.commentson.fetch(),f.when(s.commentson.request).done(function(){console.error(s.commentson),o=new y({collection:s.commentson,userId:s.userId,name:s.oldView,_template:t,destination:".coment-area-h"}),s.scheme.push(o),s.layout.render()})},setUpOthersView:function(){},setUpTagPhotoView:function(e,t){var r=this;this.tagViewPhoto=new E({model:new S,template:n,name:"tag-image "+(new Date).toString(),destination:"#image-tagging-photo",user_id:r.userId||null,sports_id:r.sports_id,channel:"tag-image-success-photo"}),r.scheme.push(this.tagViewPhoto),r.layout.render()},tagFunction:function(e){var t=this;alert(JSON.stringify(e))}});return r});