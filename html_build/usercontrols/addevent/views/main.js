define(["require","text!usercontrol/addevent/templates/layout.html","facade","views","utils","vendor","sportorg/collections/sports_listall","location/collections/states","usercontrol/addgame/collections/teams","location/collections/cities","usercontrol/addgame/collections/teams_user","usercontrol/addgame/collections/teams","usercontrol/addgame/collections/games_search","usercontrol/addgame/models/team","usercontrol/addgame/models/team_add","usercontrol/addgame/models/game","usercontrol/addgame/models/uslgamelink","sportorg/models/game","usercontrol/dropdown/view/dropdown","usercontrol/location/views/get-view-location","component/forms","vendor/plugins/dateformat"],function(e,t){var n,r=e("facade"),i=e("views"),s=i.SectionView,o=e("utils"),u=o.lib.Channel,a=e("vendor"),f=a.Mustache,l=r.$,c=e("usercontrol/tag/models/basic_info"),h=e("sportorg/collections/sports_listall"),p=e("location/collections/states"),d=e("location/collections/cities"),v=e("usercontrol/addgame/collections/teams_user"),m=e("usercontrol/addgame/collections/teams"),g=e("usercontrol/addgame/models/team"),y=e("usercontrol/addgame/models/team_add"),b=e("usercontrol/addgame/models/game"),w=e("usercontrol/addgame/collections/games_search"),E=e("sportorg/models/game"),S=e("usercontrol/dropdown/view/dropdown"),x=e("vendor/plugins/dateformat"),T=e("component/forms"),N=e("usercontrol/addgame/models/uslgamelink");return s.extend({template:'<div class="add-event-container-h"></div>',gameData:{},teams:[],events:{"change .ddl-game-sports_h":"changeSport","keyup .txt-game-state_h":"keyupState","blur .txt-game-state_h":"changeState","keyup .txt-game-city_h":"keyupCity","blur .txt-game-city_h":"changeCity","keyup .txt-game-team_h":"keyupTeam","blur .txt-game-team_h":"changeTeam","keyup .txt-individual-game_h":"keyupIndividualGame","blur .txt-individual-game_h":"changeindividualGame","change .ddl-game-userteams_h":"changeUserTeam","click .btn-new-team-game_h":"showAddTeam","click .btn-ddl-team-game_h":"showDdlTeam","click .rdo-game-location_h":"showLocation","click .btn-game-Finish_h":"finishGame","change .txt-game-date_h":"CheckTeamControlsVisibility","click .btn-game-individual-Create_h":"createIndividualEvent","click .btn-game-individual-Finish_h":"goThereIndividualGame"},controls:{sectionAddSports:".section-Add-Sports_h",sectionDate:".section-game-date_h",txtGameDate:".txt-game-date_h",txtGameTime:".txt-game-time_h",spnTimePeriod:".spn-ddl-time-period_h",ddlTimePeriod:".ddl-time-period_h",spnSports:".span-ddl-sports_h",ddlSports:".ddl-game-sports_h",sectionTeams:".section-game-teams_h",ddlUserTeams:".ddl-game-userteams_h",spanddlteam:".span_ddl_team_h",spanddlteamtwo:".span_ddl_team_two_h",spanddlteamone:".span_ddl_team_one_h",btnNewTeam:".btn-new-team-game_h",btnDdlTem:".btn-ddl-team-game_h",sectionNewTeam:".section-new-team_h",txtState:".txt-game-state_h",txtCity:".txt-game-city_h",txtTeam:".txt-game-team_h",txtScore:".txt-score-team_h",btnFinish:".btn-game-Finish_h",sectionTeamOne:".team-one_h",sectionTeamTwo:".team-two_h",sectionScore:".section-score_h",sectionRadio:".section-game-radio_h",rdoTeamOne:".rdo-game-location-one-home_h",rdoTeamTwo:".rdo-game-location-two-home_h",rdoLocation:".rdo-game-location_h",sectionMainLocation:".section-main-location_h",sectionLocation:".div-game-location_h",txtLocationId:".txt-game-location-id_h",sectionIndividual:".section-individual-game_h",txtIndividualGame:".txt-individual-game_h",btnIndividualFinish:".btn-game-individual-Finish_h",txtIndividualLocation:".txt-individual-location_h",btnIndividualGameCreate:".btn-game-individual-Create_h",fieldMessage:".field-message_h",secSports:".section-game-sports_h",hdnSportsIdData:"hdn_sport_id",hdnSportsId:"#hdn_sport_id",hdnTimePeriodData:"hdn_time-period_h",hdnTimePeriod:"#hdn_time-period_h",indicator:".indicator_h"},attributes:{stateId:"stateid",schoolId:"schoolid",teamId:"teamid",playersId:"playerid",cityId:"cityid",sportId:"sportid",locationId:"locationid",gameId:"gameid"},inlineTemplates:{},messages:{dataNotExist:"Data does not exist . ",selectDateAndTime:"Please select date and time",selectTeam:"Please select team",selectScore:"Please enter score",selectLocation:"Please select location",selectLocationType:"Please select location type",gameFound:"Sweet ! This Event Already Exists ! ",enterEventName:"Please enter event name",selectSport:"Please select sport",selectValidTime:"Please enter valid time in format hh:mm (12 hours)"},tags:{individual:"individual",team:"team",rgxTime:/^(0?[1-9]|1[012])(:[0-5]\d)$/,rgxTimeWhole:/^(0?[1-9]|1[012])$/},initialize:function(e){s.prototype.initialize.call(this,e),n=this,n.setOptions(e),this.init()},render:function(){s.prototype.render.call(this),this.setupForm()},setupForm:function(){var e=this,t=new T({game_search:{type:"AutoComplete",label:"Event Name",form_values:{post_to_server:!0,keyNameInPayload:"event_name",subLabelInPayload:"full_date",serverKey:"event_name",serverDbField:"event_name",defaultValue:"",field_width:"80%",request_fields:[{key:"sports_id",value:function(){return e.sports_id}},{key:"game_name",value:function(e){return e.$el.val()}}],source_collection:w,request_finished:function(){console.log("request finished")},automaticFetch:!0,automaticFetchFn:function(e){console.log("auto fetch called",e)},callback:function(t,n){var r=e.$el.find(".add-event-container-h form");if(t>0){var i=new E({id:t});i.fetch(),l.when(i.request).done(function(){var e=i.get("payload").time_as_int,t=new Date(e);r.find('input[type="submit"]').val("Add Me to This Event"),r.find('input[name="games_id"]').val(i.get("payload").id),r.find('input[name="date_chooser"]').val(x(t,"mmm d, yyyy")).attr("disabled","disabled"),r.find('input[name="time_chooser"]').val(x(t,"h:MM")).attr("disabled","disabled"),r.find("textarea.location-h").html(i.get("payload").game_location).trigger("blur").attr("disabled","disabled"),r.find(".verify-address-h").trigger("click")})}else r.find('input[type="submit"]').val("Create Event"),r.find('input[name="games_id"]').val("0"),r.find('input[name="game_name"]').val(l('input[name="game_search"]').val()),r.find('input[name="date_chooser"]').removeAttr("disabled").val(""),r.find('input[name="time_chooser"]').removeAttr("disabled").val(""),r.find("textarea.location-h").removeAttr("disabled").html("")},afterSetValue:function(e){console.log("After set value called",e)}},validators:[]},date_chooser:{form_values:{post_to_server:!1,serverKey:"game_date",serverDbField:"gameDay",objectValuesToUpdate:["game_datetime"],getValue:function(){return this.$el.val()}},fieldClass:"date-picker-field",type:"Text",attr:{placeholder:"Enter Date","class":"txt-game-date_h txtDate"},showLable:!1,label:"Date",bindDatePicker:!0,changeEvent:function(){var e=new Date(this.getValue()),t=new Date;e!=null&&t>=e?l(".txt-score-team-h").removeClass("hidden"):l(".txt-score-team-h").addClass("hidden").val("")}},time_chooser:{form_values:{post_to_server:!1,serverDbField:"gameTime",serverKey:"game_time",objectValuesToUpdate:["game_datetime"]},type:"Text",fieldClass:"time-picker-field",attr:{placeholder:"Time","class":"txt-game-time_h hasDatepicker txtTime"},showLable:!1,label:"Time",validators:[{type:"required",message:"Please enter a time"},/^(0?[1-9]|1[012])(:[0-5]\d)?$/]},Day_light:{type:"DropDown",fieldClass:"ampm-field",form_values:{post_to_server:!1,serverKey:"game_ampm",objectValuesToUpdate:["game_datetime"],data:{records:[{payload:{name:"AM",value:"AM"}},{payload:{name:"PM",value:"PM"}}],recordId:"name",recordValue:"value",selectedValue:"PM"},elementId:e.controls.hdnTimePeriodData,callback:function(e){}},showLable:!1,label:""},game_datetime:{type:"Hidden",form_values:{serverDbField:"game_datetime",valueBindings:["date_chooser","time_chooser","Day_light"],serverKey:"game_datetime",post_to_server:!0}},event_location:{form_values:{serverKey:"locations_id",post_to_server:!0,serverDbField:"locations_id"},type:"Location",label:"Location",fieldClass:"location-chooser",validators:[{type:"required",message:"Please select location."}]},users_id:{form_values:{serverKey:"users_id",post_to_server:!0,value:e.user_id},type:"Hidden"},games_id:{form_values:{serverKey:"games_id",post_to_server:!0,value:0},type:"Hidden"},game_name:{form_values:{serverKey:"game_name",post_to_server:!0,value:0},type:"Hidden"},submit:{type:"Submit",fieldClass:"button-field",attr:{value:"Create Event"},showLable:!1,onSubmit:function(t){var r=n.commit();if(r)for(var i in r){var s=l("*[name="+i+"]"),o=s.position();s.parents(".common-modal #modalBody").animate({scrollTop:o.top},"500",function(){s.addClass("focus-error-animation"),setTimeout(function(){s.removeClass("focus-error-animation")},2e3)});break}else{var u=e.formValues.getFormValues(),a=e;console.log(u,a.$el.find('input[name="game_search"]'));if(u.game_name===""||u.game_name===0||u.game_name==="0")u.game_name=a.$el.find('input[name="game_search"]').val();if(u.games_id>0){c={games_id:u.games_id,sports_id:a.sports_id,users_id:a.user_id};var f=new N(c);f.save(),l.when(f.request).fail(function(t){var n=JSON.parse(t.responseText),r=n.exec_data.error_array;e.formValues.showServersErrors(r)}),l.when(f.request).done(function(e){routing.trigger(a.channel,e)})}else{var c={game_datetime:u.game_datetime,game_location:u.locations_id,games_id:u.games_id,sports_id:a.sports_id,event_name:u.game_name,users_id:a.user_id},h=new b(c);h.game_id=u.games_id,h.save({}),l.when(h.request).fail(function(t){var n=JSON.parse(t.responseText),r=n.exec_data.error_array;e.formValues.showServersErrors(r)}),l.when(h.request).done(function(e){var t=new N;t.save({games_id:e.payload.id,sports_id:a.sports_id,users_id:a.user_id},{success:function(t,n){console.log(a.channel),routing.trigger(a.channel,e)},error:function(e,t){alert("fail"),console.log(t)}})})}}}},button:{type:"Button",fieldClass:"button-field",attr:{value:"Cancel","class":"cancel-btn"},onClick:function(){routing.trigger("common-popup-close")},showLable:!1}},this.$el.find(".add-event-container-h")),n=t.form;this.formValues=t.formValues},afterRender:function(){},setOptions:function(e){this.user_id=e.user_id;if(!e.channel)throw new Error("call back channel is must for this");this.channel=e.channel,this.sports_id=e.sports_id||null},init:function(){n.setUpMainView()},setUpMainView:function(){var e=f.to_html(n.template,{});l(n.el).html(e)}})});