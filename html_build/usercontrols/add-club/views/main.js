define(["require","text!usercontrols/add-club/templates/layout.html","facade","views","utils","vendor","usercontrol/add-club/collections/complevel","usercontrol/add-club/models/adress","usercontrol/add-club/models/add","usercontrol/dropdown/view/dropdown"],function(e,t){var n,r=e("facade"),i=e("views"),s=i.SectionView,o=e("utils"),u=o.lib.Channel,a=e("vendor"),f=a.Mustache,l=r.$,c=e("usercontrol/add-club/collections/complevel"),h=e("usercontrol/add-club/models/adress"),p=e("usercontrol/add-club/models/add"),d=e("usercontrol/dropdown/view/dropdown");return PhotoPlayerView=s.extend({template:t,events:{"click .verify-address-h":"verifyAddress","click .finish-h":"addClub","blur .address-h":"verifyAddress"},stateData:{},initialize:function(e){this.model=e.model,this.id=e.id,this.addType=e.addType,this.callback=e.callback,this.addressValid=!1,s.prototype.initialize.call(this,e),this.setUpMainView(),this.render(),this.setProfiles()},openLocationPopup:function(e,t){var n=this;routing.trigger("show_location",e,t,".location-map-h",function(){})},addClub:function(){var e=this,t=!0;if(this.$el.find(".name-h").val()=="")return alert("Please enter name."),!1;if(!this.addressValid)return alert("Please choose valid address"),!1;this.verifyAddress(function(){t&&e.saveData()})},saveData:function(){var e=this,t=new p,n={};n.name=this.$el.find(".name-h").val(),n.complevel_profiles_id=this.$el.find("#comp-levels-h").val(),n.location_id=e.locationId,n.season_profiles_id=this.$el.find("#profile-h").val(),n.sports_club=e.addType=="school"?"0":"1",t.set(n),t.save(),l.when(t.request).done(function(){console.log(t.get("payload"));var r=t.get("payload");n.locationState=e.stateData,n.org_id=r.id,e.callback&&e.callback(n),alert(e.addType+" added successfully"),routing.trigger("popup-close")})},verifyAddress:function(e){var t=this,n=t.$el.find(".address-h").val(),r=new h;t.stateData={},r.address=n,r.url(),r.set({address:n}),r.showError=function(e,n){try{t.$el.find(".address-error-status-h").removeClass("hide").html(n.responseJSON.exec_data.error_array[0].error)}catch(r){}t.$el.find(".address-h").addClass("address-field-error").removeClass("address-verified")},r.save({dataType:"json"}),t.$el.find(".address-h").removeClass("address-verified"),l.when(r.request).done(function(){t.locationId=r.get("payload").id,t.stateData=r.get("payload").states_obj,t.locationId?(typeof e!="function"&&t.openLocationPopup(r.get("payload").lat,r.get("payload").lon),t.$el.find(".address-error-status-h").addClass("hide"),t.$el.find(".address-h").removeClass("address-field-error").addClass("address-verified"),t.addressValid=!0,typeof e=="function"&&e()):t.addressValid=!1})},setProfiles:function(){var e=this,t=e.model.toJSON(),n=e.model.toJSON(),r={};r.records=[];for(var i in n[0].payload){var s=[];for(var o in n[0].payload[i].seasons)s.push(n[0].payload[i].seasons[o].name);r.records.push({payload:{id:n[0].payload[i].id,name:s.join(", ")}})}console.error(t),r.recordId="id",r.recordValue="name";var u=new d({data:r,title:"Club's Season Profile",elementId:"profile-h",destination:".profile-h",targetView:e,callback:function(t){e.getCompLevels()}})},getCompLevels:function(){var e=this;e.compLevel=new c,e.compLevel.fetch(),l.when(e.compLevel.request).done(function(){console.error(e.compLevel);var t=e.compLevel.toJSON(),n={};n.records=[];for(var r in t[0].payload){var i=[];for(var s in t[0].payload[r].levels)i.push(t[0].payload[r].levels[s].name);n.records.push({payload:{id:t[0].payload[r].id,name:i.join(", ")}})}n.recordId="id",n.recordValue="name";var o=new d({data:n,title:"Team",elementId:"comp-levels-h",destination:".comp-levels-h",targetView:e,callback:function(e){}})})},setUpMainView:function(){var e=this,t={};t.type=e.addType;var n=f.to_html(e.template,t);l(e.$el).html(n)}}),PhotoPlayerView});