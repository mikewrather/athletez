define(["require","text!usercontrols/tag/templates/layout.html","facade","views","utils","vendor","usercontrols/tag/models/basic_info","sportorg/collections/sports_listall","location/collections/states","usercontrols/tag/collections/schools","usercontrols/tag/collections/teams","location/collections/cities","user/collections/users","usercontrols/tag/collections/games","usercontrols/tag/models/complevel","usercontrol/dropdown/view/dropdown"],function(t,n){var r,i=t("facade"),s=t("views"),o=s.SectionView,u=t("utils"),a=u.lib.Channel,f=t("vendor"),l=f.Mustache,c=i.$,h=t("usercontrols/tag/models/basic_info"),p=t("sportorg/collections/sports_listall"),d=t("location/collections/states"),v=t("location/collections/cities"),m=t("usercontrols/tag/collections/schools"),g=t("user/collections/users"),y=t("usercontrols/tag/collections/games"),b=t("usercontrols/tag/collections/teams"),w=t("usercontrols/tag/models/complevel"),E=t("usercontrol/dropdown/view/dropdown"),S=o.extend({template:n,tagData:{Game:{},Player:{},Team:{}},events:{"change .ddl-tag-sports_h":"changeSport","click .btn-tag-sport_h":"sportsDone","click .btn-tag-edit-sport_h":"editSport","click .link-tag-team_h":"showTeamSection","keyup .txt-tag-team-state_h":"keyupState","blur .txt-tag-team-state_h":"changeState","keyup .txt-tag-team-city_h":"keyupCity","blur .txt-tag-team-city_h":"changeCity","keyup .txt-tag-team-school_h":"keyupSchool","blur .txt-tag-team-school_h":"changeSchool","change .ddl-tag-team-level_h":"changeCompLevel","change .ddl-tag-team-season_h":"changeSeason","click .btn-tag-team-Done_h":"doneTagTeamTagging","click .link-tag-player_h":"showPlayer","click .btn-tag-add-player_h":"addPlayer","keyup .txt-tag-player-name_h":"keyUpPlayer","change .txt-tag-player-name_h":"setPlayerId","click .btn-tag-player-Done_h":"donePlayerTagging","click .link-tag-Game_h":"showGameSection","click .btn-tag-game-Done_h":"doneGameTagging","change .ddl-tag-game_h":"changeGame","click .btn-tag-Finish_h":"finishTagging"},controls:{secAddSports:".section-Add-Sports_h",divTagList:".div-tag-list_h",secSports:".section-sports_h",lblSportName:".lbl-tag-sport-name_h",btnEditSport:".btn-tag-edit-sport_h",btnSportsDone:".btn-tag-sport_h",ddlSports:".ddl-tag-sports_h",spnSports:".span-ddl-sports-tag_h",dropdownHeader:".dropdown-header-box",secTeam:".section-team_h",lblTeamName:".lbl-tag-team-name_h",secTagTeam:".section-tag-team_h",txtTeamState:".txt-tag-team-state_h",txtTeamCity:".txt-tag-team-city_h",txtTeamSchool:".txt-tag-team-school_h",ddlTeamLevel:".ddl-tag-team-level_h",ddlTeamSeason:".ddl-tag-team-season_h",btnTeamDone:".btn-tag-team-Done_h",secPlayer:".section-tag-player_h",secPlayerInput:".section-tag-player-input_h",txtPlayerName:".txt-tag-player-name_h",additionalPlayer:".additional_h",btnAddPlayer:".btn-tag-add-player_h",btnPlayerDone:".btn-tag-player-Done_h",sectionSelectedPlayers:".section-team-players_h",lblPlayerNames:".lbl-tag-players-name_h",secGame:".section-tag-game_h",ddlGame:".ddl-tag-game_h",btnGameDone:".btn-tag-game-Done_h",secFooterLinks:".section-link_h",lnkTeam:".link-tag-team_h",lnkPlayer:".link-tag-player_h",lnkGame:".link-tag-Game_h",sectionSelectedGames:".section-team-games_h",lblGameNames:".lbl-tag-games-name_h",spnGames:".span-ddl-games-tag_h",btnTeamFinish:".btn-tag-Finish_h",fieldMessage:".field-message",fieldError:".field-error",hdnSportsIdData:"hdn_sport_id",hdnSportsId:"#hdn_sport_id",hdnGamesIdData:"hdn_game_id",hdnGamesId:"#hdn_game_id"},attributes:{stateId:"stateid",schoolId:"schoolid",teamId:"teamid",playersId:"playerid",cityId:"cityid"},inlineTemplates:{sportOption:'{{#sports}}<option value="{{sport_id}}">{{sport_name}}</option>{{/sports}}',compLevelOption:'{{#levels}}<option value="{{complevel_id}}">{{complevel_name}}</option>{{/levels}}',seasonOption:'{{#seasons}}<option value="{{season_id}}">{{season_name}}</option>{{/seasons}}',addPlayerText:'</br><input type="text" class="txt-tag-player-name_h additional_h" placeholder="Enter Name" value="" />'},messages:{dataNotExist:"Data Does Not Exist . ",dataNotExistAwards:"Data Does Not Exists For Awards.",MandatoryFields:"Sports Id, Name , Year are mandatory.",selectOrganization:"Please Select High School Or Club & Season . ",selectTeamAndSports:"Please Select Both Sports And A Team . "},initialize:function(e){o.prototype.initialize.call(this,e),r=this,r.setOptions(e),this.init()},render:function(){o.prototype.render.call(this)},setOptions:function(e){this.user_id=e.user_id;if(!e.channel)throw new Error("call back channel is must for this");this.channel=e.channel,this.sports_id=e.sports_id||null},init:function(){r.setupView()},setupView:function(){r.setUpMainView(),r.fillSports()},setUpMainView:function(){var e=l.to_html(r.template,{});c(r.el).html(e)},fillSports:function(){if(!(r.sports&&r.sports.length>0)){var e=new p;e.processResult=function(t){var n=e.ParseForDropdown();r.SetupSportsView(n)},e.fetch()}},SetupSportsView:function(e){r.sports=e;var t={};t.records=r.sports,t.recordId="id",t.recordValue="custom_name";var n=new E({data:t,title:"Select Sport",elementId:r.controls.hdnSportsIdData,destination:r.controls.spnSports,targetView:r,selectedValue:r.sports_id||null,callback:function(e){r.changeSport(e)}})},changeSport:function(e){e&&e!=0?c(r.destination).find(r.controls.btnSportsDone).fadeIn():c(r.destination).find(r.controls.btnSportsDone).fadeOut()},sportsDone:function(e){r.sportsId=c(r.destination).find(r.controls.hdnSportsId).val(),c(r.destination).find(r.controls.lblSportName).html(c(r.destination).find(r.controls.spnSports).find(r.controls.dropdownHeader).text()),c(e.target).parents(r.controls.secAddSports).fadeOut(),c(r.destination).find(r.controls.secSports).fadeIn(),c(r.destination).find(r.controls.secFooterLinks).fadeIn()},editSport:function(){this.tagData={Game:{},Player:{},Team:{}},c(r.destination).find(r.controls.secSports).fadeOut(),c(r.destination).find(r.controls.secAddSports).fadeIn(),c(r.destination).find(r.controls.secFooterLinks).fadeOut(),c(r.destination).find("*").show(),c(r.destination).find(".displayNone").hide(),c(r.destination).find("input").val(""),c(r.destination).find(r.controls.additionalPlayer).remove()},showTeamSection:function(e){c(r.destination).find(r.controls.secPlayer).fadeOut(),c(r.destination).find(r.controls.secGame).fadeOut(),c(r.destination).find(r.controls.secTagTeam).fadeIn(),c(r.destination).find(r.controls.secFooterLinks).fadeOut(),c(r.destination).find(r.controls.btnTeamFinish).fadeOut(),c(e.target).hide()},keyupState:function(e){var t=c(e.target).val(),n=[];if(t!="")if(r.isValidAutoCompleteKey(e)==1){c(e.target).removeAttr(r.attributes.stateId),r.CheckTeamControlsVisibility();var i=new d;i.state_name=c(e.target).val(),r.stateFetchRequest=r.stateFetchRequest||[],r.stateFetchRequest.push(r.cityFetchRequest||[]),r.stateFetchRequest.push(r.teamFetchRequest||[]),r.stateFetchRequest=r.abortRequest(r.stateFetchRequest);var s=i.fetch();r.stateFetchRequest.push(s),c.when(i.request).done(function(){if(i.isError())return;var t=i.toJSON();t==null||t.length<1?r.$(e.target).parent().find(r.controls.fieldMessage).html(r.messages.dataNotExist).stop().fadeIn():r.$(e.target).parent().find(r.controls.fieldMessage).html("").fadeOut(),r.states=[];for(var s in t)r.states.push(t[s].payload);r.states.forEach(function(e,t){n.push(e.name)});try{r.$(e.target).autocomplete("destroy")}catch(o){}r.$(e.target).autocomplete({source:n}),r.$(e.target).trigger("keydown")})}else r.changeState(e)},changeState:function(e){var t=c(e.target).val();c(e.target).removeAttr(r.attributes.stateId);var n=!1;r.states_id="",r.states&&r.states.forEach(function(i,s){i["name"]==t&&(n=!0,r.states_id=i.id,c(e.target).attr(r.attributes.stateId,r.states_id),c(e.target).parent().find(r.controls.txtTeamCity).removeAttr("disabled").attr(r.attributes.stateId,r.states_id).fadeIn(),c(e.target).parent().find(r.controls.txtTeamSchool).removeAttr("disabled").attr(r.attributes.stateId,r.states_id))}),n||(r.states_id=0,c(r.destination).find(r.controls.txtTeamSchool).attr("disabled","disabled").removeAttr(r.attributes.stateId).fadeOut(),c(r.destination).find(r.controls.txtTeamCity).attr("disabled","disabled").removeAttr(r.attributes.stateId).fadeOut()),r.CheckTeamControlsVisibility()},keyupCity:function(e){var t=c(e.target).val(),n=[];if(t.length>2)if(r.isValidAutoCompleteKey(e)==1){try{r.$(e.target).autocomplete("destroy")}catch(i){}c(e.target).removeAttr(r.attributes.cityId),r.CheckTeamControlsVisibility();var s=new v;s.states_id=r.states_id,s.city_name=c(e.target).val(),console.log("City Request Abort Request Function AddGame/Main.js"),r.cityFetchRequest=r.cityFetchRequest||[],r.cityFetchRequest.push(r.teamFetchRequest||[]),r.cityFetchRequest=r.abortRequest(r.cityFetchRequest);var o=s.fetch();r.cityFetchRequest.push(o),c.when(s.request).done(function(){if(s.isError())return;var t=s.toJSON();t==null||t.length<1?r.$(e.target).parent().find(r.controls.fieldMessage).html(r.messages.dataNotExist).stop().fadeIn():r.$(e.target).parent().find(r.controls.fieldMessage).html("").fadeOut(),r.cities=[];for(var i in t)r.cities.push(t[i]);r.cities.forEach(function(e,t){n.push(e.city)}),r.$(e.target).autocomplete({source:n}),r.$(e.target).trigger("keydown")})}else r.changeCity(e)},changeCity:function(e){var t=c(e.target).val();c(e.target).removeAttr(r.attributes.cityId);var n=!1;r.city_id="",r.cities&&r.cities.forEach(function(i,s){i["city"]==t&&(n=!0,r.city_id=i.id,c(e.target).attr(r.attributes.cityId,r.city_id))}),n?c(r.destination).find(r.controls.txtTeamSchool).removeAttr("disabled"):(r.city_id=0,c(r.destination).find(r.controls.txtTeamSchool).attr("disabled","disabled").removeAttr(r.attributes.cityId).fadeOut()),r.CheckTeamControlsVisibility()},keyupSchool:function(e){var t=c(e.target).val(),n=[],i=r.isValidAutoCompleteKey(e);if(t!=""&&i==1&&t.length>2){c(e.target).removeAttr(r.attributes.teamId),r.CheckTeamControlsVisibility();var s=new b;s.states_id=c(e.target).attr(r.attributes.stateId),s.sports_id=c(r.destination).find(r.controls.hdnSportsId).val(),s.team_name=t,console.log("Team Request Abort Request Function"),r.TeamFetchRequest=r.abortRequest(r.TeamFetchRequest);var o=s.fetch();r.TeamFetchRequest.push(o),c.when(s.request).done(function(){if(s.isError())return;var t=s.toJSON();t==null||t.length<1?r.$(e.target).parent().find(r.controls.fieldMessage).html(r.messages.dataNotExist).stop().fadeIn():r.$(e.target).parent().find(r.controls.fieldMessage).html("").stop().fadeOut(),r.teams=[];for(var i in t)r.teams.push(t[i].payload);r.teams.forEach(function(e,t){n.push(e.team_name)});try{c(e.target).autocomplete("destroy")}catch(o){}c(e.target).autocomplete({source:n}),c(e.target).trigger("keydown")})}else c(e.target).removeAttr(r.attributes.teamId),r.CheckTeamControlsVisibility(),r.isEnterKey(e)&&r.changeSchool(e)},changeSchool:function(e){var t=c(e.target).val(),n=!1;r.team_id=0,r.teams&&r.teams.forEach(function(i,s){var o=i.team_name;o==t&&(n=!0,r.team_id=i.id,c(e.target).attr(r.attributes.teamId,r.team_id))}),n||c(e.target).removeAttr(r.attributes.teamId),r.CheckTeamControlsVisibility()},CheckTeamControlsVisibility:function(){var e=c(r.destination).find(r.controls.txtTeamState).attr(r.attributes.stateId);e&&e!=""&&e!=0?c(r.destination).find(r.controls.txtTeamCity).show():c(r.destination).find(r.controls.txtTeamCity).val("").removeAttr(r.attributes.cityId).hide(),e=c(r.destination).find(r.controls.txtTeamCity).attr(r.attributes.cityId),e&&e!=""&&e!=0?c(r.destination).find(r.controls.txtTeamSchool).show():c(r.destination).find(r.controls.txtTeamSchool).val("").removeAttr(r.attributes.teamId).hide(),e=c(r.destination).find(r.controls.txtTeamSchool).attr(r.attributes.teamId),e&&e!=""&&e!=0?c(r.destination).find(r.controls.btnTeamDone).show():c(r.destination).find(r.controls.btnTeamDone).hide()},doneTagTeamTagging:function(e){var t=c(r.destination).find(r.controls.txtTeamSchool).attr(r.attributes.teamId);r.team_id=t;var n=c(r.destination).find(r.controls.ddlTeamSeason).val(),i={};if(t&&t!=""&&t!=0&&t&&t!=""&&t!=0){var s=c(r.destination).find(r.controls.txtTeamSchool).val();i.teamName=s,i.id=t,c(r.destination).find(r.controls.lblTeamName).html(s),c(r.destination).find(r.controls.secTagTeam).fadeOut(),c(r.destination).find(r.controls.secTeam).fadeIn(),c(r.destination).find(r.controls.lnkPlayer).fadeIn(),c(r.destination).find(r.controls.lnkGame).fadeIn(),c(r.destination).find(r.controls.secFooterLinks).fadeIn(),c(r.destination).find(r.controls.btnTeamFinish).fadeIn()}else r.$(e.target).parents(r.controls.secTagTeam).find(r.controls.fieldMessage).html(r.messages.selectOrganization).stop().fadeIn();r.tagData.Team=i},showPlayer:function(e){c(r.destination).find(r.controls.secTagTeam).fadeOut(),c(r.destination).find(r.controls.secGame).fadeOut(),c(r.destination).find(r.controls.secPlayer).fadeIn(),c(r.destination).find(r.controls.btnTeamFinish).fadeOut()},addPlayer:function(e){c(r.destination).find(r.controls.secPlayerInput).append(r.inlineTemplates.addPlayerText)},keyUpPlayer:function(e){var t=c(e.target).val(),n=[];if(t!="")if(r.isValidAutoCompleteKey(e)==1){c(e.target).removeAttr(r.attributes.playersId);var i=new g;i.user_name=t,i.states_id=r.states_id,i.sports_id=c(r.destination).find(r.controls.hdnSportsId).val(),console.log("Player Request Abort Request Function"),r.PlayerFetchRequest=r.abortRequest(r.PlayerFetchRequest);var s=i.fetch();r.PlayerFetchRequest.push(s),c.when(i.request).done(function(){var t=i.toJSON();t==null||t.length<1?r.$(e.target).parent().find(r.controls.fieldMessage).html(r.messages.dataNotExist).stop().fadeIn():r.$(e.target).parent().find(r.controls.fieldMessage).html("").fadeOut(),r.users=[];for(var s in t)r.users.push(t[s].payload);r.users.forEach(function(e,t){n.push(e.name)});try{r.$(e.target).autocomplete("destroy")}catch(o){}r.$(e.target).autocomplete({source:n}),r.$(e.target).trigger("keydown")})}else r.setPlayerId(e),r.isEnterKey(e)&&r.addPlayer(e);else c(e.target).removeAttr(r.attributes.playersId)},setPlayerId:function(e){if(r.users){var t=c(e.target).val().toLowerCase();for(var n in r.users)if(r.users[n].name.toLowerCase()==t){c(e.target).attr(r.attributes.playersId,r.users[n].id);return}}},donePlayerTagging:function(e){var t=[],n="";c(r.destination).find(r.controls.txtPlayerName).each(function(){c(this).attr(r.attributes.playersId)>0&&(t.push({name:c(this).val(),id:c(this).attr(r.attributes.playersId)}),n+=","+c(this).val())});if(t.length>0){var i={players:t};r.tagData.Player=i;var s=c(r.destination).find(r.controls.sectionSelectedPlayers);c(s).find(r.controls.lblPlayerNames).html(n),c(s).fadeIn(),c(r.destination).find(r.controls.secPlayer).fadeOut(),c(r.destination).find(r.controls.btnTeamFinish).fadeIn()}else{c(e.target).parents(r.controls.secGame).find(r.controls.fieldMessage).html(r.messages.selectPlayer).fadeIn();var s=c(r.destination).find(r.controls.sectionSelectedPlayers);c(s).find(r.controls.lblPlayerNames).html(""),c(s).fadeOut()}},showGameSection:function(e){r.bindGamesData(e),c(r.destination).find(r.controls.secTagTeam).fadeOut(),c(r.destination).find(r.controls.secPlayer).fadeOut(),c(r.destination).find(r.controls.secGame).fadeIn(),c(r.destination).find(r.controls.btnTeamFinish).fadeOut()},bindGamesData:function(e){var t=c(r.destination).find(r.controls.hdnSportsId).val();if(r.sportsId){var n=new y;n.states_id=r.states_id,n.cities_id=r.city_id,n.sports_id=r.sportsId,n.teams_id=r.team_id,c(e.target).parents(r.controls.secGame).find(r.controls.fieldMessage).html("").fadeOut(),n.processResult=function(e){r.SetupGamesView(e)},console.log("Team Request Abort Request Function"),r.GameFetchRequest=r.abortRequest(r.GameFetchRequest);var i=n.fetch();r.GameFetchRequest.push(i)}else c(e.target).parents(r.controls.secGame).find(r.controls.fieldMessage).html(r.messages.selectTeamAndSports).fadeIn()},SetupGamesView:function(e){var t=e;if(t==null||t.length<1){c(r.destination).find(r.controls.secGame).find(r.controls.fieldMessage).html(r.messages.dataNotExist).stop().fadeIn();return}r.games=e;var n={};n.records=r.games,n.recordId="id",n.recordValue="game_name";var i=new E({data:n,title:"Select Game",elementId:r.controls.hdnGamesIdData,destination:r.controls.spnGames,targetView:r,selectedValue:r.sports_id||null,callback:function(e){r.changeGame(e)}})},changeGame:function(t){var n=t;n&&n!=""&&n!=0?c(e.target).parents(r.controls.secGame).find(r.controls.btnGameDone).fadeIn():c(e.target).parents(r.controls.secGame).find(r.controls.btnGameDone).fadeOut()},doneGameTagging:function(e){var t=this,n=c(e.target).parents(t.controls.secGame).find(t.controls.hdnGamesId).val(),r="";if(n&&n!=""&&n!=0){r=c(e.target).parents(t.controls.secGame).find(t.controls.spnGames).find(t.controls.dropdownHeader).text();var i={game:{id:n,game_name:r}};t.tagData.Game=i;var s=c(t.destination).find(t.controls.sectionSelectedGames);c(s).find(t.controls.lblGameNames).html(r),c(s).fadeIn(),c(t.destination).find(t.controls.secGame).fadeOut(),c(t.destination).find(t.controls.btnTeamFinish).fadeIn()}else{var s=c(t.destination).find(t.controls.sectionSelectedGames);c(s).find(t.controls.lblGameNames).html(""),c(s).fadeIn()}},finishTagging:function(){a(r.channel).publish(this.tagData)}});return S});