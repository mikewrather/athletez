//     (c) 2010-2013 Jeremy Ashkenas, DocumentCloud Inc.

//     Backbone may be freely distributed under the MIT license.

/**
 * Backbone Forms v0.12.0
 *
 * Copyright (c) 2013 Charles Davison, Pow Media Ltd
 *
 * License and more information at:
 * http://github.com/powmedia/backbone-forms
 */

(function(){var e=this,t=e.Backbone,n=[],r=n.push,i=n.slice,s=n.splice,o;typeof exports!="undefined"?o=exports:o=e.Backbone={},o.VERSION="1.0.0";var u=e._;!u&&typeof require!="undefined"&&(u=require("underscore")),o.$=e.jQuery||e.Zepto||e.ender||e.$,o.noConflict=function(){return e.Backbone=t,this},o.emulateHTTP=!1,o.emulateJSON=!0;var a=o.Events={on:function(e,t,n){if(!l(this,"on",e,[t,n])||!t)return this;this._events||(this._events={});var r=this._events[e]||(this._events[e]=[]);return r.push({callback:t,context:n,ctx:n||this}),this},once:function(e,t,n){if(!l(this,"once",e,[t,n])||!t)return this;var r=this,i=u.once(function(){r.off(e,i),t.apply(this,arguments)});return i._callback=t,this.on(e,i,n)},off:function(e,t,n){var r,i,s,o,a,f,c,h;if(!this._events||!l(this,"off",e,[t,n]))return this;if(!e&&!t&&!n)return this._events={},this;o=e?[e]:u.keys(this._events);for(a=0,f=o.length;a<f;a++){e=o[a];if(s=this._events[e]){this._events[e]=r=[];if(t||n)for(c=0,h=s.length;c<h;c++)i=s[c],(t&&t!==i.callback&&t!==i.callback._callback||n&&n!==i.context)&&r.push(i);r.length||delete this._events[e]}}return this},trigger:function(e){if(!this._events)return this;var t=i.call(arguments,1);if(!l(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&c(n,t),r&&c(r,arguments),this},stopListening:function(e,t,n){var r=this._listeners;if(!r)return this;var i=!t&&!n;typeof t=="object"&&(n=this),e&&((r={})[e._listenerId]=e);for(var s in r)r[s].off(t,n,this),i&&delete this._listeners[s];return this}},f=/\s+/,l=function(e,t,n,r){if(!n)return!0;if(typeof n=="object"){for(var i in n)e[t].apply(e,[i,n[i]].concat(r));return!1}if(f.test(n)){var s=n.split(f);for(var o=0,u=s.length;o<u;o++)e[t].apply(e,[s[o]].concat(r));return!1}return!0},c=function(e,t){var n,r=-1,i=e.length,s=t[0],o=t[1],u=t[2];switch(t.length){case 0:while(++r<i)(n=e[r]).callback.call(n.ctx);return;case 1:while(++r<i)(n=e[r]).callback.call(n.ctx,s);return;case 2:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o);return;case 3:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o,u);return;default:while(++r<i)(n=e[r]).callback.apply(n.ctx,t)}},h={listenTo:"on",listenToOnce:"once"};u.each(h,function(e,t){a[t]=function(t,n,r){var i=this._listeners||(this._listeners={}),s=t._listenerId||(t._listenerId=u.uniqueId("l"));return i[s]=t,typeof n=="object"&&(r=this),t[e](n,r,this),this}}),a.bind=a.on,a.unbind=a.off,u.extend(o,a);var p=o.Model=function(e,t){var n,r=e||{};t||(t={}),this.cid=u.uniqueId("c"),this.attributes={},u.extend(this,u.pick(t,d)),t.parse&&(r=this.parse(r,t)||{});if(n=u.result(this,"defaults"))r=u.defaults({},r,n);this.set(r,t),this.changed={},this.initialize.apply(this,arguments)},d=["url","urlRoot","collection"];u.extend(p.prototype,a,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(e){return u.clone(this.attributes)},sync:function(){return o.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return u.escape(this.get(e))},has:function(e){return this.get(e)!=null},set:function(e,t,n){var r,i,s,o,a,f,l,c;if(e==null)return this;typeof e=="object"?(i=e,n=t):(i={})[e]=t,n||(n={});if(!this._validate(i,n))return!1;s=n.unset,a=n.silent,o=[],f=this._changing,this._changing=!0,f||(this._previousAttributes=u.clone(this.attributes),this.changed={}),c=this.attributes,l=this._previousAttributes,this.idAttribute in i&&(this.id=i[this.idAttribute]);for(r in i)t=i[r],u.isEqual(c[r],t)||o.push(r),u.isEqual(l[r],t)?delete this.changed[r]:this.changed[r]=t,s?delete c[r]:c[r]=t;if(!a){o.length&&(this._pending=!0);for(var h=0,p=o.length;h<p;h++)this.trigger("change:"+o[h],this,c[o[h]],n)}if(f)return this;if(!a)while(this._pending)this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,u.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var n in this.attributes)t[n]=void 0;return this.set(t,u.extend({},e,{unset:!0}))},hasChanged:function(e){return e==null?!u.isEmpty(this.changed):u.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?u.clone(this.changed):!1;var t,n=!1,r=this._changing?this._previousAttributes:this.attributes;for(var i in e){if(u.isEqual(r[i],t=e[i]))continue;(n||(n={}))[i]=t}return n},previous:function(e){return e==null||!this._previousAttributes?null:this._previousAttributes[e]},previousAttributes:function(){return u.clone(this._previousAttributes)},fetch:function(e){e=e?u.clone(e):{},e.parse===void 0&&(e.parse=!0);var t=this,n=e.success;return e.success=function(r){if(!t.set(t.parse(r,e),e))return!1;n&&n(t,r,e),t.trigger("sync",t,r,e)},j(this,e),this.sync("read",this,e)},save:function(e,t,n){var r,i,s,o=this.attributes;e==null||typeof e=="object"?(r=e,n=t):(r={})[e]=t;if(r&&(!n||!n.wait)&&!this.set(r,n))return!1;n=u.extend({validate:!0},n);if(!this._validate(r,n))return!1;r&&n.wait&&(this.attributes=u.extend({},o,r)),n.parse===void 0&&(n.parse=!0);var a=this,f=n.success;return n.success=function(e){a.attributes=o;var t=a.parse(e,n);n.wait&&(t=u.extend(r||{},t));if(u.isObject(t)&&!a.set(t,n))return!1;f&&f(a,e,n),a.trigger("sync",a,e,n)},j(this,n),i=this.isNew()?"create":n.patch?"patch":"update",i==="patch"&&(n.attrs=r),s=this.sync(i,this,n),r&&n.wait&&(this.attributes=o),s},destroy:function(e){e=e?u.clone(e):{};var t=this,n=e.success,r=function(){t.trigger("destroy",t,t.collection,e)};e.success=function(i){(e.wait||t.isNew())&&r(),n&&n(t,i,e),t.isNew()||t.trigger("sync",t,i,e)};if(this.isNew())return e.success(),!1;j(this,e);var i=this.sync("delete",this,e);return e.wait||r(),i},url:function(){var e=u.result(this,"urlRoot")||u.result(this.collection,"url")||B();return this.isNew()?e:e+(e.charAt(e.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(e){return this._validate({},u.extend(e||{},{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=u.extend({},this.attributes,e);var n=this.validationError=this.validate(e,t)||null;return n?(this.trigger("invalid",this,n,u.extend(t||{},{validationError:n})),!1):!0}});var v=["keys","values","pairs","invert","pick","omit"];u.each(v,function(e){p.prototype[e]=function(){var t=i.call(arguments);return t.unshift(this.attributes),u[e].apply(u,t)}});var m=o.Collection=function(e,t){t||(t={}),t.url&&(this.url=t.url),t.model&&(this.model=t.model),t.comparator!==void 0&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,u.extend({silent:!0},t))},g={add:!0,remove:!0,merge:!0},y={add:!0,merge:!1,remove:!1};u.extend(m.prototype,a,{model:p,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return o.sync.apply(this,arguments)},add:function(e,t){return this.set(e,u.defaults(t||{},y))},remove:function(e,t){e=u.isArray(e)?e.slice():[e],t||(t={});var n,r,i,s;for(n=0,r=e.length;n<r;n++){s=this.get(e[n]);if(!s)continue;delete this._byId[s.id],delete this._byId[s.cid],i=this.indexOf(s),this.models.splice(i,1),this.length--,t.silent||(t.index=i,s.trigger("remove",s,this,t)),this._removeReference(s)}return this},set:function(e,t){t=u.defaults(t||{},g),t.parse&&(e=this.parse(e,t)),u.isArray(e)||(e=e?[e]:[]);var n,i,o,a,f,l,c=t.at,h=this.comparator&&c==null&&t.sort!==!1,p=u.isString(this.comparator)?this.comparator:null,d=[],v=[],m={};for(n=0,i=e.length;n<i;n++){if(!(o=this._prepareModel(e[n],t)))continue;(f=this.get(o))?(t.remove&&(m[f.cid]=!0),t.merge&&(f.set(o.attributes,t),h&&!l&&f.hasChanged(p)&&(l=!0))):t.add&&(d.push(o),o.on("all",this._onModelEvent,this),this._byId[o.cid]=o,o.id!=null&&(this._byId[o.id]=o))}if(t.remove){for(n=0,i=this.length;n<i;++n)m[(o=this.models[n]).cid]||v.push(o);v.length&&this.remove(v,t)}d.length&&(h&&(l=!0),this.length+=d.length,c!=null?s.apply(this.models,[c,0].concat(d)):r.apply(this.models,d)),l&&this.sort({silent:!0});if(t.silent)return this;for(n=0,i=d.length;n<i;n++)(o=d[n]).trigger("add",o,this,t);return l&&this.trigger("sort",this,t),this},reset:function(e,t){t||(t={});for(var n=0,r=this.models.length;n<r;n++)this._removeReference(this.models[n]);return t.previousModels=this.models,this._reset(),this.add(e,u.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,u.extend({at:this.length},t)),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,u.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(e,t){return this.models.slice(e,t)},get:function(e){return e==null?void 0:this._byId[e.id!=null?e.id:e.cid||e]},at:function(e){return this.models[e]},where:function(e,t){return u.isEmpty(e)?t?void 0:[]:this[t?"find":"filter"](function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0})},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return e||(e={}),u.isString(this.comparator)||this.comparator.length===1?this.models=this.sortBy(this.comparator,this):this.models.sort(u.bind(this.comparator,this)),e.silent||this.trigger("sort",this,e),this},sortedIndex:function(e,t,n){t||(t=this.comparator);var r=u.isFunction(t)?t:function(e){return e.get(t)};return u.sortedIndex(this.models,e,r,n)},pluck:function(e){return u.invoke(this.models,"get",e)},fetch:function(e){e=e?u.clone(e):{},e.parse===void 0&&(e.parse=!0);var t=e.success,n=this;return e.success=function(r){var i=e.reset?"reset":"set";n[i](r,e),t&&t(n,r,e),n.trigger("sync",n,r,e)},j(this,e),this.sync("read",this,e)},create:function(e,t){t=t?u.clone(t):{};if(!(e=this._prepareModel(e,t)))return!1;t.wait||this.add(e,t);var n=this,r=t.success;return t.success=function(i){t.wait&&n.add(e,t),r&&r(e,i,t)},e.save(null,t),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){if(e instanceof p)return e.collection||(e.collection=this),e;t||(t={}),t.collection=this;var n=new this.model(e,t);return n._validate(e,t)?n:(this.trigger("invalid",this,e,t),!1)},_removeReference:function(e){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){if((e==="add"||e==="remove")&&n!==this)return;e==="destroy"&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],t.id!=null&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments)}});var b=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];u.each(b,function(e){m.prototype[e]=function(){var t=i.call(arguments);return t.unshift(this.models),u[e].apply(u,t)}});var w=["groupBy","countBy","sortBy"];u.each(w,function(e){m.prototype[e]=function(t,n){var r=u.isFunction(t)?t:function(e){return e.get(t)};return u[e](this.models,r,n)}});var E=o.View=function(e){this.cid=u.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},S=/^(\S+)\s*(.*)$/,x=["model","collection","el","id","attributes","className","tagName","events"];u.extend(E.prototype,a,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(e,t){return this.$el&&this.undelegateEvents(),this.$el=e instanceof o.$?e:o.$(e),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=u.result(this,"events")))return this;this.undelegateEvents();for(var t in e){var n=e[t];u.isFunction(n)||(n=this[e[t]]);if(!n)continue;var r=t.match(S),i=r[1],s=r[2];n=u.bind(n,this),i+=".delegateEvents"+this.cid,s===""?this.$el.on(i,n):this.$el.on(i,s,n)}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(e){this.options&&(e=u.extend({},u.result(this,"options"),e)),u.extend(this,u.pick(e,x)),this.options=e},_ensureElement:function(){if(!this.el){var e=u.extend({},u.result(this,"attributes"));this.id&&(e.id=u.result(this,"id")),this.className&&(e["class"]=u.result(this,"className"));var t=o.$("<"+u.result(this,"tagName")+">").attr(e);this.setElement(t,!1)}else this.setElement(u.result(this,"el"),!1)}}),o.sync=function(e,t,n){var r=T[e];u.defaults(n||(n={}),{emulateHTTP:o.emulateHTTP,emulateJSON:o.emulateJSON});var i={type:r,dataType:"json"};n.url||(i.url=u.result(t,"url")||B()),n.data==null&&t&&(e==="create"||e==="update"||e==="patch")&&(i.contentType="application/json",i.data=JSON.stringify(n.attrs||t.toJSON(n))),n.emulateJSON&&(i.contentType="application/x-www-form-urlencoded",i.data=i.data?{model:i.data}:{});if(n.emulateHTTP&&(r==="PUT"||r==="DELETE"||r==="PATCH")){i.type="POST",n.emulateJSON&&(i.data._method=r);var s=n.beforeSend;n.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",r);if(s)return s.apply(this,arguments)}}i.type!=="GET"&&!n.emulateJSON&&(i.processData=!1),i.type==="PATCH"&&window.ActiveXObject&&(!window.external||!window.external.msActiveXFilteringEnabled)&&(i.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var a=n.xhr=o.ajax(u.extend(i,n));return t.trigger("request",t,a,n),a};var T={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};o.ajax=function(){return o.$.ajax.apply(o.$,arguments)};var N=o.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},C=/\((.*?)\)/g,k=/(\(\?)?:\w+/g,L=/\*\w+/g,A=/[\-{}\[\]+?.,\\\^$|#\s]/g;u.extend(N.prototype,a,{initialize:function(){},route:function(e,t,n){u.isRegExp(e)||(e=this._routeToRegExp(e)),u.isFunction(t)&&(n=t,t=""),n||(n=this[t]);var r=this;return o.history.route(e,function(i){var s=r._extractParameters(e,i);n&&n.apply(r,s),r.trigger.apply(r,["route:"+t].concat(s)),r.trigger("route",t,s),o.history.trigger("route",r,t,s)}),this},navigate:function(e,t){return o.history.navigate(e,t),this},_bindRoutes:function(){if(!this.routes)return;this.routes=u.result(this,"routes");var e,t=u.keys(this.routes);while((e=t.pop())!=null)this.route(e,this.routes[e])},_routeToRegExp:function(e){return e=e.replace(A,"\\$&").replace(C,"(?:$1)?").replace(k,function(e,t){return t?e:"([^/]+)"}).replace(L,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){var n=e.exec(t).slice(1);return u.map(n,function(e){return e?decodeURIComponent(e):null})}});var O=o.History=function(){this.handlers=[],u.bindAll(this,"checkUrl"),typeof window!="undefined"&&(this.location=window.location,this.history=window.history)},M=/^[#\/]|\s+$/g,_=/^\/+|\/+$/g,D=/msie [\w.]+/,P=/\/$/;O.started=!1,u.extend(O.prototype,a,{interval:50,getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(e,t){if(e==null)if(this._hasPushState||!this._wantsHashChange||t){e=this.location.pathname;var n=this.root.replace(P,"");e.indexOf(n)||(e=e.substr(n.length))}else e=this.getHash();return e.replace(M,"")},start:function(e){if(O.started)throw new Error("Backbone.history has already been started");O.started=!0,this.options=u.extend({},{root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var t=this.getFragment(),n=document.documentMode,r=D.exec(navigator.userAgent.toLowerCase())&&(!n||n<=7);this.root=("/"+this.root+"/").replace(_,"/"),r&&this._wantsHashChange&&(this.iframe=o.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(t)),this._hasPushState?o.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?o.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=t;var i=this.location,s=i.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!s)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&s&&i.hash&&(this.fragment=this.getHash().replace(M,""),this.history.replaceState({},document.title,this.root+this.fragment+i.search));if(!this.options.silent)return this.loadUrl()},stop:function(){o.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),O.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe)));if(t===this.fragment)return!1;this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(e){var t=this.fragment=this.getFragment(e),n=u.any(this.handlers,function(e){if(e.route.test(t))return e.callback(t),!0});return n},navigate:function(e,t){if(!O.started)return!1;if(!t||t===!0)t={trigger:t};e=this.getFragment(e||"");if(this.fragment===e)return;this.fragment=e;var n=this.root+e;if(this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,t.replace))}t.trigger&&this.loadUrl(e)},_updateHash:function(e,t,n){if(n){var r=e.href.replace(/(javascript:|#).*$/,"");e.replace(r+"#"+t)}else e.hash="#"+t}}),o.history=new O;var H=function(e,t){var n=this,r;e&&u.has(e,"constructor")?r=e.constructor:r=function(){return n.apply(this,arguments)},u.extend(r,n,t);var i=function(){this.constructor=r};return i.prototype=n.prototype,r.prototype=new i,e&&u.extend(r.prototype,e),r.__super__=n.prototype,r};p.extend=m.extend=N.extend=E.extend=O.extend=H;var B=function(){throw new Error('A "url" property or function must be specified')},j=function(e,t){var n=t.error;t.error=function(r){n&&n(e,r,t),e.trigger("error",e,r,t)}}}).call(this),function(t){if(typeof exports!="undefined"&&typeof require!="undefined")var n=t.jQuery||t.Zepto||t.ender||require("jquery"),r=t._||require("underscore"),i=t.Backbone||require("backbone");else var n=t.jQuery,r=t._,i=t.Backbone;var s=i.View.extend({initialize:function(e){var t=this;e=e||{},e.formValues&&(this.formValues=e.formValues);var n=this.schema=function(){if(e.schema)return r.result(e,"schema");var n=e.model;return n&&n.schema?r.isFunction(n.schema)?n.schema():n.schema:t.schema?r.isFunction(t.schema)?t.schema():t.schema:{}}();r.extend(this,r.pick(e,"model","data","idPrefix"));var i=this.constructor;this.template=e.template||this.template||i.template,this.Fieldset=e.Fieldset||this.Fieldset||i.Fieldset,this.Field=e.Field||this.Field||i.Field,this.NestedField=e.NestedField||this.NestedField||i.NestedField;var s=this.selectedFields=e.fields||r.keys(n),o=this.fields={};r.each(s,function(e){var t=n[e];o[e]=this.createField(e,t)},this);var u=e.fieldsets||[s],a=this.fieldsets=[];r.each(u,function(e){this.fieldsets.push(this.createFieldset(e))},this)},createFieldset:function(e){var t={schema:e,fields:this.fields};return new this.Fieldset(t)},createField:function(e,t){var n={form:this,key:e,schema:t,idPrefix:this.idPrefix};this.model?n.model=this.model:this.data?n.value=this.data[e]:n.value=null;var r=new this.Field(n);return this.listenTo(r.editor,"all",this.handleEditorEvent),r},handleEditorEvent:function(e,t){var n=t.key+":"+e;this.trigger.call(this,n,this,t,Array.prototype.slice.call(arguments,2));switch(e){case"change":this.trigger("change",this);break;case"focus":this.hasFocus||this.trigger("focus",this);break;case"blur":this.updateFields(t);if(this.hasFocus){var i=this;setTimeout(function(){var e=r.find(i.fields,function(e){return e.editor.hasFocus});e||i.trigger("blur",i)},0)}}},updateFields:function(e){this.formValues&&this.formValues.updateFormValues(e),this.validate&&this.validate({fields:[e]})},render:function(){var e=this,t=this.fields,i=n(n.trim(this.template(r.result(this,"templateData"))));return i.find("[data-editors]").add(i).each(function(i,s){var o=n(s),u=o.attr("data-editors");if(r.isUndefined(u))return;var a=u=="*"?e.selectedFields||r.keys(t):u.split(",");r.each(a,function(e){var n=t[e];o.append(n.editor.render().el)})}),i.find("[data-fields]").add(i).each(function(i,s){var o=n(s),u=o.attr("data-fields");if(r.isUndefined(u))return;var a=u=="*"?e.selectedFields||r.keys(t):u.split(",");r.each(a,function(e){var n=t[e];o.append(n.render().el)})}),i.find("[data-fieldsets]").add(i).each(function(t,i){var s=n(i),o=s.attr("data-fieldsets");if(r.isUndefined(o))return;r.each(e.fieldsets,function(e){s.append(e.render().el)})}),this.setElement(i),i.addClass(this.className),this},ShowValidateMessage:function(e){if(!e)return;var t=this,n=e.field,i=e.message;console.error(n,i);return},validate:function(e){var t=this,n=this.fields,i=this.model,s={};e=e||{},r.each(n,function(e){var t=e.validate();t&&(s[e.key]=t)});if(!e.skipModelValidate&&i&&i.validate){var o=i.validate(this.getValue());if(o){var u=r.isObject(o)&&!r.isArray(o);u||(s._others=s._others||[],s._others.push(o)),u&&r.each(o,function(e,t){if(n[t]&&!s[t])n[t].setError(e),s[t]=e;else{s._others=s._others||[];var r={};r[t]=e,s._others.push(r)}})}}return r.isEmpty(s)?null:s},commit:function(e){e=e||{};var t={skipModelValidate:!e.validate},n=this.validate(t);if(n)return n;var i,s=r.extend({error:function(e,t){i=t}},e);this.model.set(this.getValue(),s);if(i)return i},getValue:function(e){if(e)return this.fields[e].getValue();var t={};return r.each(this.fields,function(e){t[e.key]=e.getValue()}),t},setValue:function(e,t){var n={};typeof e=="string"?n[e]=t:n=e;var r;for(r in this.schema)n[r]!==undefined&&this.fields[r].setValue(n[r])},getEditor:function(e){var t=this.fields[e];if(!t)throw"Field not found: "+e;return t.editor},focus:function(){if(this.hasFocus)return;var e=this.fieldsets[0],t=e.getFieldAt(0);if(!t)return;t.editor.focus()},blur:function(){if(!this.hasFocus)return;var e=r.find(this.fields,function(e){return e.editor.hasFocus});e&&e.editor.blur()},trigger:function(e){return e==="focus"?this.hasFocus=!0:e==="blur"&&(this.hasFocus=!1),i.View.prototype.trigger.apply(this,arguments)},remove:function(){return r.each(this.fieldsets,function(e){e.remove()}),r.each(this.fields,function(e){e.remove()}),i.View.prototype.remove.apply(this,arguments)}},{template:r.template('    <form data-fieldsets class="autoform"></form>  ',null,this.templateSettings),templateSettings:{evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},editors:{}});s.validators=function(){var e={};return e.errMessages={required:"Required",regexp:"Invalid",email:"Invalid email address",url:"Invalid URL",match:r.template('Must match field "<%= field %>"',null,s.templateSettings)},e.required=function(e){return e=r.extend({type:"required",message:this.errMessages.required},e),function(n){e.value=n;var i={type:e.type,message:r.isFunction(e.message)?e.message(e):e.message};if(n===null||n===undefined||n===!1||n==="")return i}},e.regexp=function(e){if(!e.regexp)throw new Error('Missing required "regexp" option for "regexp" validator');return e=r.extend({type:"regexp",message:this.errMessages.regexp},e),function(n){e.value=n;var i={type:e.type,message:r.isFunction(e.message)?e.message(e):e.message};if(n===null||n===undefined||n==="")return;if(!e.regexp.test(n))return i}},e.email=function(t){return t=r.extend({type:"email",message:this.errMessages.email,regexp:/^[\w\-]{1,}([\w\-\+.]{1,1}[\w\-]{1,}){0,}[@][\w\-]{1,}([.]([\w\-]{1,})){1,3}$/},t),e.regexp(t)},e.url=function(t){return t=r.extend({type:"url",message:this.errMessages.url,regexp:/^(http|https):\/\/(([A-Z0-9][A-Z0-9_\-]*)(\.[A-Z0-9][A-Z0-9_\-]*)+)(:(\d+))?\/?/i},t),e.regexp(t)},e.match=function(e){if(!e.field)throw new Error('Missing required "field" options for "match" validator');return e=r.extend({type:"match",message:this.errMessages.match},e),function(n,i){e.value=n;var s={type:e.type,message:r.isFunction(e.message)?e.message(e):e.message};if(n===null||n===undefined||n==="")return;if(n!==i[e.field])return s}},e}(),s.Fieldset=i.View.extend({initialize:function(e){e=e||{};var t=this.schema=this.createSchema(e.schema);this.fields=r.pick(e.fields,t.fields),this.template=e.template||this.constructor.template},createSchema:function(e){return r.isArray(e)&&(e={fields:e}),e.legend=e.legend||null,e},getFieldAt:function(e){var t=this.schema.fields[e];return this.fields[t]},templateData:function(){return this.schema},render:function(){var e=this.schema,t=this.fields,i=n(n.trim(this.template(r.result(this,"templateData"))));return i.find("[data-fields]").add(i).each(function(e,i){var s=n(i),o=s.attr("data-fields");if(r.isUndefined(o))return;r.each(t,function(e){s.append(e.render().el)})}),this.setElement(i),this},remove:function(){r.each(this.fields,function(e){e.remove()}),i.View.prototype.remove.call(this)}},{template:r.template("    <fieldset data-fields>      <% if (legend) { %>        <legend><%= legend %></legend>      <% } %>    </fieldset>  ",null,s.templateSettings)}),s.Field=i.View.extend({initialize:function(e){e=e||{},r.extend(this,r.pick(e,"form","key","model","value","idPrefix"));var t=this.schema=this.createSchema(e.schema);this.template=e.template||t.template||this.constructor.template,this.errorClassName=e.errorClassName||this.constructor.errorClassName,this.editor=this.createEditor()},createSchema:function(e){r.isString(e)&&(e={type:e});if(r.isUndefined(e.showLable)||e.showLable)e=r.extend({type:"Text",title:e.label?e.label:""},e);return e.type=r.isString(e.type)?s.editors[e.type]:e.type,e},createEditor:function(){var e=r.extend(r.pick(this,"schema","form","key","model","value"),{id:this.createEditorId()}),t=this.schema.type;return new t(e)},createEditorId:function(){var e=this.idPrefix,t=this.key;return t=t.replace(/\./g,"_"),r.isString(e)||r.isNumber(e)?e+t:r.isNull(e)?t:this.model?this.model.cid+"_"+t:t},createTitle:function(){var e=this.schema&&this.schema.label?this.schema.label:this.key;return e=e.replace(/([A-Z])/g," $1"),e=e.replace(/^./,function(e){return e.toUpperCase()}),e},templateData:function(){var e=this.schema;return{help:e.help||"",title:e.title,fieldAttrs:e.fieldAttrs,editorAttrs:e.editorAttrs,key:this.key,editorId:this.editor.id}},render:function(){var e=this.schema,t=this.editor;if(e.type==s.editors.Hidden)return this.setElement(t.render().el);var i=n(n.trim(this.template(r.result(this,"templateData"))));return e.fieldClass&&i.addClass("input-field "+e.fieldClass),e.fieldAttrs&&i.attr(e.fieldAttrs),i.find("[data-editor]").add(i).each(function(i,s){var o=n(s),u=o.attr("data-editor");if(r.isUndefined(u))return;o.append(t.render().el),e.tooltip&&e.tooltip!=""&&o.find("input,label,textarea,.dropdown-wrapper").qtip({content:e.tooltip,position:{my:"bottom center",at:"top center"},style:{}})}),this.setElement(i),this.schema.hideElement&&this.$el.addClass("hide"),this},showField:function(){this.$el.removeClass("hide")},validate:function(){var e=this.editor.validate();return e?this.setError(e.message):this.clearError(),e},setError:function(e){if(this.editor.hasNestedForm)return;console.log(this.$el),this.$el.addClass(this.errorClassName);var t=this;this.$("[data-error]").html(e).fadeIn(),setTimeout(function(){t.$("[data-error]").fadeOut(1e3)},3e3)},clearError:function(){this.$el.removeClass(this.errorClassName),this.$("[data-error]").empty()},commit:function(){return this.editor.commit()},getValue:function(){return this.editor.getValue()},setValue:function(e){this.editor.setValue(e)},focus:function(){this.editor.focus()},blur:function(){this.editor.blur()},remove:function(){this.editor.remove(),i.View.prototype.remove.call(this)}},{template:r.template('    <div class="field-row">      <label for="<%= editorId %>"><%= title %></label>      <div>        <span data-editor></span>        <div data-error></div>        <div><%= help %></div>      </div>    </div>  ',null,s.templateSettings),errorClassName:"error"}),s.NestedField=s.Field.extend({template:r.template(n.trim("    <div>      <span data-editor></span>      <% if (help) { %>        <div><%= help %></div>      <% } %>      <div data-error></div>    </div>  "),null,s.templateSettings)}),s.Editor=s.editors.Base=i.View.extend({defaultValue:null,hasFocus:!1,initialize:function(e){var e=e||{};if(e.model){if(!e.key)throw"Missing option: 'key'";this.model=e.model,this.value=this.model.get(e.key)}else e.value!==undefined&&(this.value=e.value);this.value===undefined&&(this.value=this.defaultValue),r.extend(this,r.pick(e,"key","form"));var t=this.schema=e.schema||{};this.validators=e.validators||t.validators,this.$el.attr("id",this.id),this.$el.attr("name",this.getName()),t.editorClass&&this.$el.addClass(t.editorClass),t.editorAttrs&&this.$el.attr(t.editorAttrs)},setFieldWidth:function(){this.field_width&&this.$el.css({width:this.field_width})},getName:function(){var e=this.key||"";return e.replace(/\./g,"_")},getValue:function(){return this.value},setValue:function(e){this.value=e},focus:function(){throw"Not implemented"},blur:function(){throw"Not implemented"},commit:function(e){var t=this.validate();if(t)return t;this.listenTo(this.model,"invalid",function(e,n){t=n}),this.model.set(this.key,this.getValue(),e);if(t)return t},validate:function(){var e=this.$el,t=null,n=this.getValue(),i=this.form?this.form.getValue():{},s=this.validators,o=this.getValidator;return s&&r.every(s,function(e){return t=o(e)(n,i),t?!1:!0}),t},trigger:function(e){return e==="focus"?this.hasFocus=!0:e==="blur"&&(this.hasFocus=!1),i.View.prototype.trigger.apply(this,arguments)},getValidator:function(e){var t=s.validators;if(r.isRegExp(e))return t.regexp({regexp:e});if(r.isString(e)){if(!t[e])throw new Error('Validator "'+e+'" not found');return t[e]()}if(r.isFunction(e))return e;if(r.isObject(e)&&e.type){var n=e;return t[n.type](n)}throw new Error("Invalid validator: "+e)}}),s.editors.Text=s.Editor.extend({tagName:"input",defaultValue:"",previousValue:"",events:{keyup:"determineChange",keypress:function(e){var t=this;setTimeout(function(){t.determineChange()},0)},select:function(e){this.trigger("select",this)},focus:function(e){this.trigger("focus",this)},blur:function(e){this.trigger("blur",this)},change:"change"},change:function(e){this.changeEvent&&this.changeEvent(e),this.validate&&this.validate()},validateField:function(e,t){this.serverValidate({field:e,message:t})},initialize:function(e){r.bindAll(this),s.editors.Base.prototype.initialize.call(this,e);var t=this.schema,n="text";t&&t.editorAttrs&&t.editorAttrs.type&&(n=t.type),t&&t.dataType&&(n=t.dataType),t&&t.changeEvent&&(this.changeEvent=t.changeEvent),this.setAllAttr(this.schema.attr),this.$el.attr("type",n),this.setOptions(e.schema.form_values),this.defaultValue&&(this.value=this.defaultValue),this.schema.bindDatePicker&&this.bindDatePickerFn()},setOptions:function(e){for(var t in e)this[t]=e[t]},bindDatePickerFn:function(){this.$el.datepicker({dateFormat:"M d, yy",changeMonth:!0,changeYear:!0})},setAllAttr:function(e){for(var t in e)this.$el.attr(t,e[t])},render:function(){return this.setValue(this.value),this.setFieldWidth(),this},determineChange:function(e){var t=this.$el.val(),n=t!==this.previousValue;n&&(this.previousValue=t,this.trigger("change",this))},getValue:function(){return this.schema.bindDatePicker?this.$el.datepicker("getDate"):this.$el.val()},setValue:function(e){this.$el.val(e)},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()},select:function(){this.$el.select()}}),s.editors.Location=s.editors.Text.extend({tagName:"div",locationId:null,map_id:"",template:'<textarea placeholder="Address" class="location-h address-h" rows="3" cols="25"><%= address %></textarea>			 <span class="address-error hide address-error-status-h"></span>			 <a href="javascript: void(0);" class="verify-address-h">Verify Address</a>			 <div id="<%= map_id %>" style="width: 97%; height: 250px; margin-top: 20px; display:none;"></div>',events:{"click .verify-address-h":"verifyAddress","blur .verify-address-h":"verifyAddress"},verifyAddress:function(){var e=this,t=e.$el.find(".address-h").val(),r=require("usercontrol/location/models/verify-adress");e.locationId=undefined,e.adressModel=new r,e.adressModel.address=t,e.adressModel.url(),e.adressModel.set({address:t}),e.adressModel.showError=function(t,n){try{e.$el.find(".set-address-h").addClass("link-disabled"),e.$el.find(".address-error-status-h").removeClass("hide").html(n.responseJSON.exec_data.error_array[0].error)}catch(r){}e.$el.find(".address-h").addClass("address-field-error").removeClass("address-verified")},e.adressModel.save({dataType:"json"}),e.$el.find(".address-h").removeClass("address-verified"),n.when(e.adressModel.request).done(function(){console.log(e.adressModel.toJSON()),e.locationId=e.adressModel.get("payload").id;if(e.locationId){e.$el.find(".address-error-status-h").addClass("hide"),e.$el.find(".address-h").removeClass("address-field-error").addClass("address-verified"),e.location.latitude=e.adressModel.get("payload").lat,e.location.longitude=e.adressModel.get("payload").lon,e.$el.find(".set-address-h").removeClass("link-disabled");if(e.map){var t=new google.maps.LatLng(e.location.latitude,e.location.longitude);e.refreshAndPosition(t)}else e.createMap();e.trigger("blur",e)}})},createMap:function(){this.$el.find("#"+this.map_id).show();var e=this,t=new google.maps.LatLng(e.location.latitude,e.location.longitude),n={zoom:13,scaleControl:!0,zoomControl:!0,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP};this.map=new google.maps.Map(document.getElementById(this.map_id),n),this.marker=new google.maps.Marker({position:t,map:this.map}),this.marker.setMap(this.map),e.refreshAndPosition(t)},refreshAndPosition:function(e){var t=this;setTimeout(function(){google.maps.event.trigger(t.map,"resize"),t.marker.setPosition(e),t.map.panTo(e)},50)},determineChange:function(e){var t=this,n=this.$el.val();t.$el.addClass("ui-autocomplete-loading"),this.getData&&this.getData(n,function(e){t.cities=[];for(var n in e)t.cities.push(e[n]);var r=[];t.cities.forEach(function(e,t){r.push(e.city)});try{t.$el.autocomplete("destroy")}catch(i){}t.$el.autocomplete({source:r}),t.$el.trigger("keydown")})},autoComplete:function(){n(e.target).autocomplete({source:arr})},initialize:function(e){r.bindAll(this),s.editors.Base.prototype.initialize.call(this,e),this.map_id="map-canvas-"+Math.floor(Math.random()*1e4+1);var t=e.schema;t&&t.getData&&(this.getData=t.getData),this.setFormOptions(e.schema.form_values),this.value=this.defaultValue||"",this.location={latitude:undefined,longitude:undefined},e.callback&&(this.callback=e.callback),this.location.latitude=r.isUndefined(t.latitude)?undefined:t.latitude,this.location.longitude=r.isUndefined(t.longitude)?undefined:t.longitude,this.locationId=r.isUndefined(t.locationId)?undefined:t.locationId},setFormOptions:function(e){if(e)for(var t in e)this[t]=e[t]},render:function(){var e=this,t=r.template(this.template,{address:this.value,map_id:this.map_id});this.$el.html(t);if(this.location.latitude!==undefined&&this.location.longitude!==undefined)var i=0,s=setInterval(function(){i++,n("#"+e.map_id).length?(e.createMap(),clearInterval(s)):i>20&&clearInterval(s)},300);return this},getValue:function(){return this.locationId},setValue:function(e){this.$el.find(".address-h").val(e),this.$el.find(".verify-address-h").trigger("click")},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()},select:function(){this.$el.select()}}),s.editors.AutoComplete=s.editors.Text.extend({tagName:"input",defaultValue:"",previousValue:"",events:{keyup:"determineChange",keypress:function(e){},select:function(e){this.trigger("select",this)},focus:function(e){this.trigger("focus",this)},blur:function(e){this.trigger("checkForEmpty",this)}},isValidAutoCompleteKey:function(e){if(e){var t=e.keyCode?e.keyCode:e.which;if(t>=59&&t<=90||t>=96&&t<=105||t==8||t==32||t==46)return!0}return!1},checkForEmpty:function(){alert("sdasd");var e=this,t=this.$el.val();console.error(t),t==""&&(e.afterSetValue&&r.isFunction(e.afterSetValue)&&e.afterSetValue("hide"),e.$el.removeClass("ui-autocomplete-loading"))},determineChange:function(e){if(!this.isValidAutoCompleteKey(e))return;var t=this,i=this.$el.val();this.getData&&i!=""?(t.$el.addClass("ui-autocomplete-loading"),this.getData(i,function(e){console.error("callback",e,i),t.records=[],t.keyNameInPayload||(t.keyNameInPayload="name");var s=t.keyNameInPayload,o=t.subLabelInPayload?t.subLabelInPayload:null;for(var u in e)t.records.push(e[u]);var a=[];t.initialInsert&&typeof t.initialInsert=="object"&&a.push(t.initialInsert),t.records.forEach(function(e,t){var n=e.payload?e.payload[s]:e[s],r=o&&e.payload?e.payload[o]:o?e[o]:"";id=e.payload?e.payload.id:e.id,a.push({value:n,l:r,id:id,full_return:e.payload})}),t.finalInsert&&typeof t.finalInsert=="object"&&a.push(t.finalInsert),console.log(a);var f=function(e,n){t.afterSetValue&&r.isFunction(t.afterSetValue)&&t.afterSetValue("show"),console.log("select or change");if(n.item){t.$el.parent().find(".indicator-h").removeClass("invalid").addClass("valid");var i=n.item.id?n.item.id:n.item.value;t.$el.attr("data-id",i),t.trigger("blur",t),n.item.customCallback&&typeof n.item.customCallback=="function"?n.item.customCallback(i,n.item):t.callback&&t.callback(i,n.item)}};try{t.$el.autocomplete("destroy")}catch(l){}a.length?t.$el.autocomplete({source:a,select:f,change:f,response:function(e,n){n.content.length||(t.$el.attr("data-id",""),t.callback&&t.callback(0)),console.log("hopefully this is every key stroke",n)}}).data("ui-autocomplete")._renderItem=function(e,t){var r=n("<li>"),s="<a>";return console.log(typeof t.value),typeof t.value=="string"?s+=t.value:typeof t.value=="function"&&(s+=t.value(i)),t.l!=""&&(s+="<br><span class='sub-label'>"+t.l+"</span>"),s+="</a>",r.append(s).appendTo(e)}:(console.log("No Results"),t.noResultsCallback&&r.isFunction(t.noResultsCallback)&&t.noResultsCallback(i)),t.$el.trigger("keydown")})):(t.afterSetValue&&r.isFunction(t.afterSetValue)&&t.afterSetValue("hide"),t.$el.removeClass("ui-autocomplete-loading"))},setOptions:function(e){for(var t in e)this[t]=e[t]},initialize:function(e){s.editors.Base.prototype.initialize.call(this,e);var t=this,n=e.schema;this.$el.attr("type","text"),this.setOptions(e.schema.form_values),this.setFieldWidth(),this.automaticFetch&&t.automaticFetchFn(t)},getData:function(e,t){var i=this;if(this.source_collection){if(this.collectionFetchOb){try{i.$el.autocomplete("destroy")}catch(s){}this.collectionFetchOb.abort()}this.collection=new this.source_collection,i.$el.addClass("ui-autocomplete-loading");if(this.request_fields)for(var o in this.request_fields)this.collection[this.request_fields[o].key]=this.request_fields[o].value&&typeof this.request_fields[o].value=="function"?this.request_fields[o].value(this):this.request_fields[o].value;i.$el.parent().find(".indicator-h").length||i.$el.after('<span class="indicator-h field-error-img"></span>'),i.$el.parent().find(".indicator-h").removeClass("valid").addClass("invalid"),i.afterSetValue&&r.isFunction(i.afterSetValue)&&i.afterSetValue("hide"),this.collectionFetchOb=this.collection.fetch(),n.when(i.collection.request).done(function(){i.request_finished&&i.request_finished(),t&&t(i.collection.toJSON()),i.$el.removeClass("ui-autocomplete-loading")})}},getValue:function(){return this.$el.attr("data-id")},setValue:function(e,t){this.$el.parent().find(".indicator-h").length||this.$el.after('<span class="indicator-h field-error-img"></span>'),!e&&e==""?this.$el.parent().find(".indicator-h").removeClass("valid").addClass("invalid"):this.$el.parent().find(".indicator-h").removeClass("invalid").addClass("valid"),this.$el.attr("data-id",e),this.$el.val(t),this.afterSetValue&&r.isFunction(this.afterSetValue)&&this.afterSetValue("show")},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()},select:function(){this.$el.select()}}),s.editors.DropDown=s.editors.Text.extend({tagName:"div",determineChange:function(e){var t=this,n=this.$el.val()},template:'<div class="dropdown-container">		<input type="hidden" class="hidden-input-dropdown-h" value="" />		<div class="drop-down-outer">			<div class="region-dark dropdown-header-box">				<%=dropView.title%>			</div>			<div class="down-arrow-outer">				<a href="javascript: void(0);" class="down-arrow up-down-arrow-h">					<span class="icon-white icon-chevron-down"></span>				</a></div>		<div class="common-container">			<ul class="common-dropdown">				<% if(records) { var len = records.length; for(var i = 0; i < len; i++) { %>				<li class="<%=(records[i].payload[recordId] == selectedValue)?"selected":""%>">					<a data-id="<%=records[i].payload[recordId]%>" href="javascript: void(0);"><%=records[i].payload[recordValue]%></a>				</li>				<% } } %>			</ul>		</div>	</div>',multiple:!1,selectedOptions:[],className:"dropdown-wrapper",events:{"click .up-down-arrow-h":"showDropdown","click li a":"selectOptions"},selectOptions:function(e){var t=n(e.target).data("id");this.multiple?(this.setMultipleOptions(t,e),this.setValue(this.selectedOptions.join(", "))):(this.setSingleOption(t,e),this.setValue(t)),this.showSelectedValue(),this.callback&&this.callback(this.selectedOptions),this.trigger("blur",this)},showSelectedValue:function(){var e=this.$el.find(".common-dropdown li.selected").text()||this.title;this.$el.find(".dropdown-header-box").html(e)},setMultipleOptions:function(e,t){var r=this.checkifExists(e);r==-1?(n(t.target).parent().addClass("selected"),this.selectedOptions.push(e)):(n(t.target).parent().removeClass("selected"),this.selectedOptions.splice(r,1))},setSingleOption:function(e,t){var r=this.checkifExists(e);r==-1&&(this.selectedOptions=[],this.$el.find(".common-dropdown li").removeClass("selected"),n(t.target).parent().addClass("selected"),this.selectedOptions.push(e),this.$el.find(".hidden-input-dropdown-h").val(e),this.hideDropdown())},checkifExists:function(e){var t=-1;for(var n in this.selectedOptions)if(this.selectedOptions[n]==e){t=n;break}return t},initialize:function(e){s.editors.Base.prototype.initialize.call(this,e);var t=this;t.selectedOptions=[],t.setOptions(e.schema.form_values),t.checkForData(),t.$el.find(".hidden-input-dropdown-h").attr("id",t.elementId)},getData:function(e,t){var n=this;if(this.source_collection){this.collection=new this.source_collection;if(this.request_fields)for(var r in this.request_fields)this.collection[this.request_fields[r].key]=this.request_fields[r].value&&typeof this.request_fields[r].value=="function"?this.request_fields[r].value():this.request_fields[r].value;this.collection.fetch(),this.collection.processResult=function(){console.log("COLLECTION: ",n.collection);var e=n.collection.ParseForDropdown();n.request_finished&&n.request_finished(),t&&t(e)}}},checkForData:function(e){var t=this;t.data.records&&!e?t.render():t.getData("",function(e){t.data.records=e;if(!t.selectedValue){if(t.data.records&&t.data.records.length)var n=t.data.records[0].payload[t.data.recordId];t.multiple?(t.selectedValue=[],t.selectedValue.push(n)):t.selectedValue=n,t.showDefaultValueSelected()}t.render()})},hideDropdown:function(e){if(!e||!this.$el.find(n(e.target)).parents(".dropdown-container").length)this.$el.find(".dropdown-container").removeClass("increase-dropown-zindex"),this.$el.find(".up-down-arrow-h span").removeClass("icon-chevron-up").addClass("icon-chevron-down"),this.$el.find(".common-dropdown").slideUp()},showDropdown:function(e){e.preventDefault();var t=this;n(e.currentTarget).find("span").hasClass("icon-chevron-down")?(n(e.currentTarget).find("span").removeClass("icon-chevron-down").addClass("icon-chevron-up"),n(".dropdown-container").removeClass("increase-dropown-zindex"),t.$el.find(".dropdown-container").addClass("increase-dropown-zindex"),n("html").bind("click",function(e){t.hideDropdown(e)})):(t.$el.find(".dropdown-container").removeClass("increase-dropown-zindex"),n(e.currentTarget).find("span").removeClass("icon-chevron-up").addClass("icon-chevron-down")),n(e.currentTarget).parents(".dropdown-container").find(".common-dropdown").slideToggle()},defaultSelected:function(e){if(_self.multiple){if(_self.selectedValue&&r.isArray(_self.selectedValue))for(var t in _self.selectedValue)if(_self.selectedValue[t]==this.payload[_self.data.recordId])return"selected"}else if(_self.selectedValue&&_self.selectedValue==this.payload[_self.data.recordId])return"selected"},render:function(){var e=this;this.data.dropView=e,this.selectedValue=this.data.selectedValue,this.selectedOptions=[];if(typeof this.selectedValue=="undefined"||!this.selectedValue){if(this.data.records&&this.data.records.length)var t=this.data.records[0].payload[this.data.recordId];this.multiple?(this.selectedValue=[],this.selectedValue.push(t)):this.selectedValue=t}var e=this,i=r.template(this.template,this.data);return this.$el.html(i),this.setValue(this.data.selectedValue),this.selectedOptions.push(this.selectedValue),this.showSelectedValue(),n("#"+this.elementId).length?e.callback&&e.callback(this.selectedOptions):setTimeout(function(){e.showDefaultValueSelected(),e.callback&&e.callback(e.selectedOptions)},200),this},showDefaultValueSelected:function(){var e=this;if(!e.$el.find("li.selected").length){var t=e.$el.find(".common-dropdown li:first-child");t.addClass("selected")}else var t=e.$el.find("li.selected");var n=t.find("a").data("id");n&&(e.$el.find(".hidden-input-dropdown-h").val(t.find("a").data("id")),e.showSelectedValue())},setOptions:function(e){for(var t in e)this[t]=e[t]},getValue:function(){return this.$el.find(".hidden-input-dropdown-h").val()},setValue:function(e){this.$el.find(".common-dropdown li").removeClass("selected"),this.$el.find(".common-dropdown a[data-id="+e+"]").parent("li").addClass("selected");var t=this.$el.find(".common-dropdown li.selected a").data("id");t&&t!=""?this.$el.find(".hidden-input-dropdown-h").val(t):(this.$el.find(".common-dropdown li:first-child").addClass("selected"),this.$el.find(".hidden-input-dropdown-h").val(this.$el.find(".common-dropdown li.selected a").data("id"))),this.showSelectedValue()},select:function(){this.$el.select()}}),s.editors.TextArea=s.editors.Text.extend({tagName:"textarea",initialize:function(e){s.editors.Base.prototype.initialize.call(this,e)}}),s.editors.Password=s.editors.Text.extend({initialize:function(e){s.editors.Text.prototype.initialize.call(this,e),this.$el.attr("type","password")}}),s.editors.Number=s.editors.Text.extend({defaultValue:0,events:r.extend({},s.editors.Text.prototype.events,{keypress:"onKeyPress",change:"onKeyPress"}),initialize:function(e){s.editors.Text.prototype.initialize.call(this,e);var t=this.schema;this.$el.attr("type","number"),(!t||!t.editorAttrs||!t.editorAttrs.step)&&this.$el.attr("step","any")},onKeyPress:function(e){var t=this,n=function(){setTimeout(function(){t.determineChange()},0)};if(e.charCode===0){n();return}var r=this.$el.val();e.charCode!=undefined&&(r+=String.fromCharCode(e.charCode));var i=/^[0-9]*\.?[0-9]*?$/.test(r);i?n():e.preventDefault()},getValue:function(){var e=this.$el.val();return e===""?null:parseFloat(e,10)},setValue:function(e){e=function(){return r.isNumber(e)?e:r.isString(e)&&e!==""?parseFloat(e,10):null}(),r.isNaN(e)&&(e=null),s.editors.Text.prototype.setValue.call(this,e)}}),s.editors.Submit=s.editors.Text.extend({tag:"input",defaultValue:"Create",className:"submit-btn",events:{click:"submitHandler"},submitHandler:function(e){e.preventDefault(),this.onSubmit&&this.onSubmit(e)},initialize:function(e){e.schema&&e.schema.attr&&e.schema.attr.value&&(this.defaultValue=e.schema.attr.value),e.schema&&e.schema.onSubmit&&(this.onSubmit=e.schema.onSubmit),s.editors.Text.prototype.initialize.call(this,e),this.$el.attr("type","submit"),this.$el.attr("value","Create")}}),s.editors.Button=s.editors.Text.extend({tag:"input",defaultValue:"",className:"submit-btn",events:{click:"submitHandler"},initialize:function(e){e.schema&&e.schema.attr&&e.schema.attr.value&&(this.defaultValue=e.schema.attr.value),e.schema&&e.schema.onClick&&(this.onClick=e.schema.onClick),s.editors.Text.prototype.initialize.call(this,e),this.$el.attr("type","button"),this.$el.attr("value","Cancel"),this.setAllAttr(this.schema.attr)},submitHandler:function(e){e.preventDefault(),this.onClick&&this.onClick(e)},setAllAttr:function(e){for(var t in e)this.$el.attr(t,e[t])}}),s.editors.Hidden=s.editors.Text.extend({defaultValue:"",initialize:function(e){s.editors.Text.prototype.initialize.call(this,e),this.$el.attr("type","hidden"),this.value&&this.$el.attr("value",this.value),this.setOptions(e.schema.options)},setOptions:function(e){for(var t in e)this[t]=e[t]},focus:function(){},blur:function(){}}),s.editors.Checkbox=s.editors.Base.extend({defaultValue:!1,tagName:"input",events:{click:function(e){this.trigger("change",this)},focus:function(e){this.trigger("focus",this)},blur:function(e){this.trigger("blur",this)}},initialize:function(e){s.editors.Base.prototype.initialize.call(this,e),this.$el.attr("type","checkbox")},render:function(){return this.setValue(this.value),this},getValue:function(){return this.$el.prop("checked")},setValue:function(e){e?this.$el.prop("checked",!0):this.$el.prop("checked",!1)},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()}}),s.editors.Select=s.editors.Base.extend({tagName:"select",events:{change:function(e){this.trigger("change",this)},focus:function(e){this.trigger("focus",this)},blur:function(e){this.trigger("blur",this)}},initialize:function(e){s.editors.Base.prototype.initialize.call(this,e);if(!this.schema||!this.schema.options)throw"Missing required 'schema.options'"},render:function(){return this.setOptions(this.schema.options),this},setOptions:function(e){var t=this;if(e instanceof i.Collection){var n=e;n.length>0?this.renderOptions(e):n.fetch({success:function(n){t.renderOptions(e)}})}else r.isFunction(e)?e(function(e){t.renderOptions(e)},t):this.renderOptions(e)},renderOptions:function(e){var t=this.$el,n;n=this._getOptionsHtml(e),t.html(n),this.setValue(this.value)},_getOptionsHtml:function(e){var t;if(r.isString(e))t=e;else if(r.isArray(e))t=this._arrayToHtml(e);else if(e instanceof i.Collection)t=this._collectionToHtml(e);else if(r.isFunction(e)){var n;e(function(e){n=e},this),t=this._getOptionsHtml(n)}else t=this._objectToHtml(e);return t},getValue:function(){return this.$el.val()},setValue:function(e){this.$el.val(e)},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()},_collectionToHtml:function(e){var t=[];e.each(function(e){t.push({val:e.id,label:e.toString()})});var n=this._arrayToHtml(t);return n},_objectToHtml:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push({val:n,label:e[n]});var r=this._arrayToHtml(t);return r},_arrayToHtml:function(e){var t=[];return r.each(e,function(e){if(r.isObject(e))if(e.group)t.push('<optgroup label="'+e.group+'">'),t.push(this._getOptionsHtml(e.options)),t.push("</optgroup>");else{var n=e.val||e.val===0?e.val:"";t.push('<option value="'+n+'">'+e.label+"</option>")}else t.push("<option>"+e+"</option>")},this),t.join("")}}),s.editors.Radio=s.editors.Select.extend({tagName:"ul",events:{"change input[type=radio]":function(){this.trigger("change",this)},click:"clickHandler","focus input[type=radio]":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur input[type=radio]":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("input[type=radio]:focus")[0])return;e.trigger("blur",e)},0)}},getValue:function(){return this.$("input[type=radio]:checked").val()},setValue:function(e){this.$("input[type=radio]").val([e])},focus:function(){if(this.hasFocus)return;var e=this.$("input[type=radio]:checked");if(e[0]){e.focus();return}this.$("input[type=radio]").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("input[type=radio]:focus").blur()},initialize:function(e){s.editors.Base.prototype.initialize.call(this,e);if(!this.schema||!this.schema.options)throw"Missing required 'schema.options'";this.clickHandler=this.schema.onClickFn?this.schema.onClickFn:function(){}},_arrayToHtml:function(e){var t=[],n=this;return r.each(e,function(e,i){var s="<li>";if(r.isObject(e)){var o=e.val||e.val===0?e.val:"";s+='<input type="radio" name="'+n.getName()+'" value="'+o+'" id="'+n.id+"-"+i+'" />',s+='<label for="'+n.id+"-"+i+'">'+e.label+"</label>"}else s+='<input type="radio" name="'+n.getName()+'" value="'+e+'" id="'+n.id+"-"+i+'" />',s+='<label for="'+n.id+"-"+i+'">'+e+"</label>";s+="</li>",t.push(s)}),t.join("")}}),s.editors.Checkboxes=s.editors.Select.extend({tagName:"ul",groupNumber:0,events:{"click input[type=checkbox]":function(){this.trigger("change",this)},"focus input[type=checkbox]":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur input[type=checkbox]":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("input[type=checkbox]:focus")[0])return;e.trigger("blur",e)},0)}},getValue:function(){var e=[];return this.$("input[type=checkbox]:checked").each(function(){e.push(n(this).val())}),e},setValue:function(e){r.isArray(e)||(e=[e]),this.$("input[type=checkbox]").val(e)},focus:function(){if(this.hasFocus)return;this.$("input[type=checkbox]").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("input[type=checkbox]:focus").blur()},_arrayToHtml:function(e){var t=[],n=this;return r.each(e,function(e,i){var s="<li>",o=!0;if(r.isObject(e))if(e.group){var u=n.id;n.id+="-"+n.groupNumber++,s='<fieldset class="group"> <legend>'+e.group+"</legend>",s+=n._arrayToHtml(e.options),s+="</fieldset>",n.id=u,o=!1}else{var a=e.val||e.val===0?e.val:"";s+='<input type="checkbox" name="'+n.getName()+'" value="'+a+'" id="'+n.id+"-"+i+'" />',s+='<label for="'+n.id+"-"+i+'">'+e.label+"</label>"}else s+='<input type="checkbox" name="'+n.getName()+'" value="'+e+'" id="'+n.id+"-"+i+'" />',s+='<label for="'+n.id+"-"+i+'">'+e+"</label>";o&&(s+="</li>"),t.push(s)}),t.join("")}}),s.editors.Object=s.editors.Base.extend({hasNestedForm:!0,initialize:function(e){this.value={},s.editors.Base.prototype.initialize.call(this,e);if(!this.form)throw'Missing required option "form"';if(!this.schema.subSchema)throw new Error("Missing required 'schema.subSchema' option for Object editor")},render:function(){var e=this.form.constructor;return this.nestedForm=new e({schema:this.schema.subSchema,data:this.value,idPrefix:this.id+"_",Field:e.NestedField}),this._observeFormEvents(),this.$el.html(this.nestedForm.render().el),this.hasFocus&&this.trigger("blur",this),this},getValue:function(){return this.nestedForm?this.nestedForm.getValue():this.value},setValue:function(e){this.value=e,this.render()},focus:function(){if(this.hasFocus)return;this.nestedForm.focus()},blur:function(){if(!this.hasFocus)return;this.nestedForm.blur()},remove:function(){this.nestedForm.remove(),i.View.prototype.remove.call(this)},serverValidate:function(e){return this.nestedForm.ShowValidateMessage(e)},validate:function(){return this.nestedForm.validate()},_observeFormEvents:function(){if(!this.nestedForm)return;this.nestedForm.on("all",function(){var e=r.toArray(arguments);e[1]=this,this.trigger.apply(this,e)},this)}}),s.editors.NestedModel=s.editors.Object.extend({initialize:function(e){s.editors.Base.prototype.initialize.call(this,e);if(!this.form)throw'Missing required option "form"';if(!e.schema.model)throw'Missing required "schema.model" option for NestedModel editor'},render:function(){var e=this.form.constructor,t=this.value||{},n=this.key,r=this.schema.model,i=t.constructor===r?t:new r(t);return this.nestedForm=new e({model:i,idPrefix:this.id+"_",fieldTemplate:"nestedField"}),this._observeFormEvents(),this.$el.html(this.nestedForm.render().el),this.hasFocus&&this.trigger("blur",this),this},commit:function(){var e=this.nestedForm.commit();return e?(this.$el.addClass("error"),e):s.editors.Object.prototype.commit.call(this)}}),s.editors.Date=s.editors.Base.extend({events:{"change select":function(){this.updateHidden(),this.trigger("change",this)},"focus select":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur select":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("select:focus")[0])return;e.trigger("blur",e)},0)}},initialize:function(e){e=e||{},s.editors.Base.prototype.initialize.call(this,e);var t=s.editors.Date,n=new Date;this.options=r.extend({monthNames:t.monthNames,showMonthNames:t.showMonthNames},e),this.schema=r.extend({yearStart:n.getFullYear()-100,yearEnd:n.getFullYear()},e.schema||{}),this.value&&!r.isDate(this.value)&&(this.value=new Date(this.value));if(!this.value){var i=new Date;i.setSeconds(0),i.setMilliseconds(0),this.value=i}this.template=e.template||this.constructor.template},render:function(){var e=this.options,t=this.schema,i=r.map(r.range(1,32),function(e){return'<option value="'+e+'">'+e+"</option>"}),s=r.map(r.range(0,12),function(t){var n=e.showMonthNames?e.monthNames[t]:t+1;return'<option value="'+t+'">'+n+"</option>"}),o=t.yearStart<t.yearEnd?r.range(t.yearStart,t.yearEnd+1):r.range(t.yearStart,t.yearEnd-1,-1),u=r.map(o,function(e){return'<option value="'+e+'">'+e+"</option>"}),a=n(n.trim(this.template({dates:i.join(""),months:s.join(""),years:u.join("")})));return this.$date=a.find('[data-type="date"]'),this.$month=a.find('[data-type="month"]'),this.$year=a.find('[data-type="year"]'),this.$hidden=n('<input type="hidden" name="'+this.key+'" />'),a.append(this.$hidden),this.setValue(this.value),this.setElement(a),this.$el.attr("id",this.id),this.$el.attr("name",this.getName()),this.hasFocus&&this.trigger("blur",this),this},getValue:function(){var e=this.$year.val(),t=this.$month.val(),n=this.$date.val();return!e||!t||!n?null:new Date(e,t,n)},setValue:function(e){this.$date.val(e.getDate()),this.$month.val(e.getMonth()),this.$year.val(e.getFullYear()),this.updateHidden()},focus:function(){if(this.hasFocus)return;this.$("select").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("select:focus").blur()},updateHidden:function(){var e=this.getValue();r.isDate(e)&&(e=e.toISOString()),this.$hidden.val(e)}},{template:r.template('    <div>      <select data-type="date"><%= dates %></select>      <select data-type="month"><%= months %></select>      <select data-type="year"><%= years %></select>    </div>  ',null,s.templateSettings),showMonthNames:!0,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"]}),s.editors.DateTime=s.editors.Base.extend({events:{"change select":function(){this.updateHidden(),this.trigger("change",this)},"focus select":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur select":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("select:focus")[0])return;e.trigger("blur",e)},0)}},initialize:function(e){e=e||{},s.editors.Base.prototype.initialize.call(this,e),this.options=r.extend({DateEditor:s.editors.DateTime.DateEditor},e),this.schema=r.extend({minsInterval:15},e.schema||{}),this.dateEditor=new this.options.DateEditor(e),this.value=this.dateEditor.value,this.template=e.template||this.constructor.template},render:function(){function e(e){return e<10?"0"+e:e}var t=this.schema,i=r.map(r.range(0,24),function(t){return'<option value="'+t+'">'+e(t)+"</option>"}),s=r.map(r.range(0,60,t.minsInterval),function(t){return'<option value="'+t+'">'+e(t)+"</option>"}),o=n(n.trim(this.template({hours:i.join(),mins:s.join()})));return o.find("[data-date]").append(this.dateEditor.render().el),this.$hour=o.find('select[data-type="hour"]'),this.$min=o.find('select[data-type="min"]'),this.$hidden=o.find('input[type="hidden"]'),this.setValue(this.value),this.setElement(o),this.$el.attr("id",this.id),this.$el.attr("name",this.getName()),this.hasFocus&&this.trigger("blur",this),this},getValue:function(){var e=this.dateEditor.getValue(),t=this.$hour.val(),n=this.$min.val();return!e||!t||!n?null:(e.setHours(t),e.setMinutes(n),e)},setValue:function(e){r.isDate(e)||(e=new Date(e)),this.dateEditor.setValue(e),this.$hour.val(e.getHours()),this.$min.val(e.getMinutes()),this.updateHidden()},focus:function(){if(this.hasFocus)return;this.$("select").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("select:focus").blur()},updateHidden:function(){var e=this.getValue();r.isDate(e)&&(e=e.toISOString()),this.$hidden.val(e)},remove:function(){this.dateEditor.remove(),s.editors.Base.prototype.remove.call(this)}},{template:r.template('    <div class="bbf-datetime">      <div class="bbf-date-container" data-date></div>      <select data-type="hour"><%= hours %></select>      :      <select data-type="min"><%= mins %></select>    </div>  ',null,s.templateSettings),DateEditor:s.editors.Date}),s.VERSION="0.12.0",i.Form=s,typeof exports!="undefined"&&(exports=s)}(window||global||this);