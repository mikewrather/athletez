define("collections/application-states",["models","facade","utils"],function(e,t,n){var r,i,s=e.ApplicationStateModel,o=t.Backbone,u=t._,a=n.docCookies;return debug=n.debug,r=o.Collection.extend({model:s,_idAttr:"id",initialize:function(e,t){var n=i;return u.bindAll(this),n&&n instanceof r?(debug.log("ApplicationStates instance already exists."),n):(debug.log("ApplicationStates initialize"),i=this,this)},add:function(e,t){var n=this;u.isArray(e)&&e.length?u.each(e,function(e){n.addOrUpdate(e,t)}):n.addOrUpdate(e,t)},addOrUpdate:function(e,t){this.isAlreadyStored(e)?this.updateModel(e,t):(u.isUndefined(e.prototype)&&(e=new this.model(e)),this.storeReferenceName(e.get("name")),o.Collection.prototype.add.call(this,e,t))},clearModel:function(e){e&&e instanceof s&&(this.removeReferenceName(e.get("name")),this.remove(e),this.destroy(e))},remove:function(){var e=r.references,t,n=this,i;if(!arguments[0]){debug.log("Removing all models in ApplicationStates collection (memory).");for(i=n.length-1;i>=0;i--)n.removeReferenceName(n.at(i).get("name")),o.Collection.prototype.remove.call(n,[n.at(i)])}else u.isString(arguments[0])&&u.contains(e,arguments[0])&&(t=n.findByName(arguments[0]),debug.log("Removing model, "+t.name+" in ApplicationStates."),n.removeReferenceName(t.get("name")),o.Collection.prototype.remove.call(n,[t]))},destroy:function(){var e=r.references,t,n=this;arguments[0]?u.isString(arguments[0])&&u.contains(e,arguments[0])&&(t=n.findByName(arguments[0]),debug.log("destroying model, "+t.cid+" in ApplicationStates."),n.removeReferenceName(t.get("name")),n.remove(t),t.destroy()):(debug.log("destroying all models in ApplicationStates."),n.each(function(e){n.removeReferenceName(e.get("name")),n.remove(e),e.destroy()}))},expiresHandler:function(e){var t=!1;return e?(e instanceof s?t=e.isExpired():t=e.expires&&(new Date(e.expires)).valueOf()<Date.now().valueOf(),t&&this.clearModel(e),t):(debug.log("expiresHandler expects a model as argument, preferably with an expires attribute/property."),!0)},isAlreadyStored:function(e){var t=!1,n=r.references;return u.isObject(e)&&e.name&&u.contains(n,e.name)&&(t=!0),t},removeReferenceName:function(e){r.references.splice(r.references.indexOf(e),1)},updateModel:function(e){var t=this.findByName(e.name),n={};t&&u.isFunction(t.toJSON)&&(n=t.toJSON(),e.data&&(u.extend(n,e),u.each(n,function(e,n,r){t.set(n,e)})))},save:function(){var e=arguments[0],t=this,n;e&&!u.isArray(e)?e instanceof s?e.save():u.isString(e)&&(n=this.findByName(e),n&&!u.isString(n)&&this.save(n)):e||this.each(function(e){t.expiresHandler(e)||e.save()})},storeReferenceName:function(e){var t,n=r.references;return u.isString(e)?(n.push(e),t=e+" added to ApplicationStates"):t="ApplicationStates failed to add a model, error on name property.",debug.log(t),e},validate:function(e){function r(e){u.isString(e)&&n.push(e)}var t,n=[];r(this.validateNameProperty(e));if(n.length)return t="ApplicationStates collection failed validation: ",t+=n.join(" AND "),debug.log(t),t},validateNameProperty:function(e){var t,n=e.name,i=r.references;return!n||!u.isString(n)?t="name property is not a string":i.length&&u.contains(i,n)&&(t=n+" is already stored in this model"),t},findByName:function(e){var t=null;return u.isString(e)&&u.contains(r.references,e)&&(t=this.filter(function(t){return t.attributes.name===e})),u.isArray(t)&&(t.length===0?t=null:t=t[0]),t=t instanceof o.Model?t:null,this.expiresHandler(t)?null:t},findByNameInStorage:function(e){var t;if(!e||!u.isString(e))throw new Error("findByNameInStorage expects string as argument.");return t=sessionStorage.getItem(e)||localStorage.getItem(e)||a.getItem(e),t=t?JSON.parse(t):null,t&&!this.expiresHandler(t)?t:null},findInCollectionOrStorage:function(e,t){var n;n=this.findByName(e)||this.findByNameInStorage(e);if(n){if(u.isFunction(n.toJSON))return n.toJSON();if(u.isString(n))return JSON.parse(n)}return!n&&!!(t&&u.isFunction(t.fetch)&&t.url())?t.fetch({url:t.url()}):u.isObject(n)?n:null}},{references:[]}),r}),define("collections/base",["facade","utils"],function(e,t){var n,r=e.Backbone,i=e.$,s=e._,o=t.lib,u=t.ajaxOptions,a=t.debug;return n=r.Collection.extend({initialize:function(e,t){a.log("BaseCollection initialize..."),this.cid=this.cid||s.uniqueId("c"),s.bindAll(this),this.deferred=new i.Deferred},request:null,_idAttr:"id",fetch:function(e){return e=e||{},this.targetElement&&this.targetElement!=""&&i(this.targetElement).addClass("region-loader"),e.success||(e.success=this.afterFetch),e.error||(e.error=this.fetchError),s.extend(e,u),this.request=r.Collection.prototype.fetch.call(this,e),this.request||(this.request=this.deferred.promise()),typeof routing!="undefined"&&typeof routing.ajaxRequests!="undefined"&&routing.ajaxRequests.push(this.request),this.request},afterFetch:function(e,t){this.targetElement&&i(this.targetElement).removeClass("region-loader"),this.fetchSuccess&&this.fetchSuccess(e,t)},isReady:function(){return this.request?this.request.state()==="resolved":this.deferred.state()==="resolved"},fetchSuccess:function(e,t){e.deferred.resolve(t),this.targetElement&&i(this.targetElement).removeClass("region-loader"),a.log("fetchSuccess resolved",t)},fetchError:function(e,t){a.log(t)},isError:function(){return!1}}),n}),define("collections/iterator",["require","collections/base","facade","utils"],function(e){var t,n=e("collections/base"),r=e("facade"),i=e("utils"),s=r.Backbone,o=r.$,u=r._,a=i.lib,f=i.debug;return t=n.extend({_activeModel:null,_setActive:function(e){var t=0,n;return e&&u.isNumber(e)&&(e!==t?(n=this._activeModel+e,n<0?t=this.length+n:n<this.length?t=n:t=n-this.length):t=this._activeModel),this._activeModel=t,t},initialize:function(e,t){this._activeModel=0,n.prototype.initialize.call(this,arguments)},previous:function(){this._activeModel=this._setActive(-1)},next:function(){this._activeModel=this._setActive(1)},selected:function(e){var t;return u.isNumber(e)&&(t=parseInt(e,10),t>=0&&t<this.length&&(this._activeModel=t)),this._activeModel},toJSON:function(){var e=n.prototype.toJSON.call(this);return e[this._activeModel].active=!0,u.each(e,function(e,t,n){n[t].idx=t}),e}}),t}),define("collections/messaging",["models","collections/base","utils","facade"],function(e,t,n,r){var i,s=e.MessagingModel,o=n.lib.Channel,u=n.debug,a=r._;return i=t.extend({model:s,initialize:function(){a.bindAll(this),this.addSubscribers()},add:function(e,n){var r,i=!1;a.isArray(e)?i=!0:this.length>0?(r=this.filter(function(e){return e.get("state")==="done"}),r&&r.length&&(e.message===this.at(r.length-1).get("message")&&u.log("duplicate msg"),this.remove(r),i=!0)):i=!0,i&&t.prototype.add.call(this,e,n)},addSubscribers:function(){o("messaging:status","nomemory").subscribe(this.setStatus)},removeSubscribers:function(){o("messaging:status").unsubscribe(this.setStatus)},setStatus:function(e){this.add(e)}}),i}),define("collections",["require","collections/application-states","collections/base","collections/iterator","collections/messaging"],function(e){return{ApplicationStates:e("collections/application-states"),BaseCollection:e("collections/base"),IteratorCollection:e("collections/iterator"),MessagingCollection:e("collections/messaging")}});