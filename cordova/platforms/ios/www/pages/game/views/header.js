define(["require","text!game/templates/header.html","facade","views","game/models/score","game/models/basics","votes/models/vote","votes/models/follow","usercontrol/location/views/location","usercontrol/location/models/verify-adress","usercontrol/location/models/save","chrome/views/header","usercontrol/dropdown/view/dropdown","media/views/image-item","component/forms","vendor/plugins/dateformat"],function(e,t){var n,r=e("facade"),i=e("views"),s=e("game/models/score"),o=e("game/models/basics"),u=e("votes/models/vote"),a=e("votes/models/follow"),f=e("media/views/image-item"),l=e("usercontrol/location/views/location"),c=e("usercontrol/dropdown/view/dropdown"),h=e("usercontrol/location/models/verify-adress"),p=e("usercontrol/location/models/save"),d=e("component/forms"),v=e("vendor/plugins/dateformat"),m=i.SectionView;return n=m.extend({id:"main-header",template:t,events:{"click .edit-score-h":"editScore","blur .edit-score-input-h":"resumeEditScore","keyup .edit-score-input-h":"adjustFont","click .vote":"vote","click .follow":"follow","click .object-edit-h":"editObject","click .object-delete-h":"deleteObject","submit .update-date-time-h":"updateDateTime","click .game-edit-btn-h":"openEditPopup","click .verify-address-h":"verifyAddress","blur .address-h":"verifyAddress"},messages:{dataNotExist:"Data does not exist . ",selectDateAndTime:"Please select date and time",selectTeam:"Please select team",selectScore:"Please enter score",selectLocation:"Please select location",selectLocationType:"Please select location type",gameFound:"Sweet ! This Event Already Exists ! ",enterEventName:"Please enter event name",selectSport:"Please select sport",selectValidTime:"Please enter valid time in format hh:mm (12 hours)"},location:{lat:undefined,lon:undefined},initialize:function(e){m.prototype.initialize.call(this,e);var t=this.model.get("payload"),n;if(t.teams){if(t.teams.length)try{n=t.teams[0].org_name+" VS "+t.teams[1].org_name,n+=" "+t.shared.complevel}catch(r){n="Game Page"}}else n=t.event_name;n+=" | "+t.shared.sport+" | "+t.game_day,document.title=n,this.setDateFields()},setDateFields:function(){var e=this.model.get("payload"),t=e.game_time;console.log(t);if(t!=undefined)try{var n=t.split(" ");console.log(n),n.length&&(e.game_hour=n[0],e.game_ampm=n[1],console.log("full payload now",e),this.model.set("payload",e))}catch(r){}},adjustFont:function(e){var t=2.2,n=$(e.target).val().length-2,r=n>0?t-.5*n:t-0;r>0&&$(e.target).parents(".team-item").find(".game-score-el").css({"font-size":r+"em"})},checkForUser:function(){return!_.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},openEditPopup:function(){if(!this.checkForUser()){routing.trigger("showSignup");return}var e={height:"500px",width:"500px",html:'<div id="editGameForm"></div>',title:"Edit Event Info"};routing.trigger("common-popup-open",e),this.drawEditGameForm()},drawEditGameForm:function(){var e=this,t=e.model.get("payload").time_as_int,n=new Date(t);console.log(t,n);var r=new d({date:{form_values:{defaultValue:v(n,"mmm d, yy"),post_to_server:!1,serverKey:"game_date",serverDbField:"gameDay",objectValuesToUpdate:["game_datetime"],getValue:function(){return this.$el.val()}},fieldClass:"date-picker-field",type:"Text",attr:{placeholder:"Enter Date","class":"txt-game-date_h txtDate"},showLable:!0,label:"Date and Time",bindDatePicker:!0},time:{form_values:{defaultValue:v(n,"h:MM"),post_to_server:!1,serverDbField:"gameTime",serverKey:"game_time",objectValuesToUpdate:["game_datetime"]},type:"Text",fieldClass:"time-picker-field",attr:{placeholder:"Time","class":"txt-game-time_h hasDatepicker txtTime"},showLable:!0,label:"&nbsp;",validators:[{type:"required",message:"Please enter a time"},/^(0?[1-9]|1[012])(:[0-5]\d)?$/]},Day_light:{type:"DropDown",fieldClass:"ampm-field",form_values:{post_to_server:!1,serverKey:"game_ampm",objectValuesToUpdate:["game_datetime"],data:{records:[{payload:{name:"AM",value:"AM"}},{payload:{name:"PM",value:"PM"}}],recordId:"name",recordValue:"value",selectedValue:v(n,"TT")},elementId:"hidden_time_value",callback:function(e){}},showLable:!0,label:"&nbsp;"},game_datetime:{type:"Hidden",form_values:{serverDbField:"game_datetime",valueBindings:["date","time","Day_light"],serverKey:"game_datetime",post_to_server:!0}},eventname:{form_values:{defaultValue:e.model.get("payload").event_name,post_to_server:!0,serverDbField:"event_name",serverKey:"event_name"},type:"Text",fieldClass:"",attr:{placeholder:"Event Name","class":"txt-event-name"},showLable:!0,label:"Event Name"},Location:{form_values:{defaultValue:e.model.get("payload").location.full_address,serverKey:"locations_id",post_to_server:!0,serverDbField:"locations_id"},longitude:e.model.get("payload").location.lon,latitude:e.model.get("payload").location.lat,locationId:e.model.get("payload").location.id,type:"Location",label:"Location",validators:[{type:"required",message:'Please select location and click the "Verify Address" button'}]},users_id:{form_values:{serverKey:e.users_id,post_to_server:!0,value:e.user_id},type:"Hidden"},submit:{type:"Submit",fieldClass:"button-field",attr:{value:"Save Changes"},showLable:!1,onSubmit:function(t){var n=routing.showSpinner("input[name=submit]"),r=i.commit();if(r){routing.hideSpinner(n,"input[name=submit]");for(var s in r){var o=$("*[name="+s+"]"),u=o.position();o.parents(".common-modal #modalBody").animate({scrollTop:u.top},"500",function(){o.addClass("focus-error-animation"),setTimeout(function(){o.removeClass("focus-error-animation")},2e3)});break}}else{if(e.formValues)var a=e.formValues.getFormValues();else var a=i.getValue();var a=e.formValues.getFormValues(),f=e;e.model.set({game_datetime:a.game_datetime,locations_id:a.locations_id,event_name:a.event_name}),console.log(f.model),f.model.save({}),$.when(f.model.request).done(function(t){e.updateHeaderData(f.model.id),routing.hideSpinner(n,"input[name=submit]"),routing.trigger("common-popup-close")}),$.when(f.model.request).fail(function(t){var r=JSON.parse(t.responseText),i=r.exec_data.error_array;routing.hideSpinner(n,"input[name=submit]"),e.formValues.showServersErrors(i)})}}},button:{type:"Button",fieldClass:"button-field",attr:{value:"Cancel","class":"cancel-btn"},onClick:function(){routing.trigger("common-popup-close")},showLable:!1}},$("#editGameForm")),i=r.form;this.formValues=r.formValues},editObject:function(){alert("Coming soon")},deleteObject:function(){alert("Coming soon")},gameEditBtn:function(){this.$el.find(".update-date-time-h").removeClass("hide")},updateHeaderData:function(e){var t=this;t.model.id=e,t.model.fetch(),$.when(t.model.request).done(function(){t.setDateFields(),console.error(t.model.toJSON()),$("#modalPopupGameEdit").modal("hide"),t.render()})},cancelDateTimeBtn:function(){this.$el.find(".update-date-time-h").addClass("hide")},afterRender:function(){this.$el.find(".edit-score-input-h").trigger("keyup"),this.$el.find(".image-outer-h").mouseover(function(){$(this).find(".action-block").css({opacity:90})}).mouseout(function(){$(this).find(".action-block").css({opacity:0})}),this.$el.find(".date-time-h").datetimepicker({timeFormat:"hh:mm:ss",dateFormat:"yy-mm-dd",showTimezone:!0,changeMonth:!0,changeYear:!0})},vote:function(e){e.preventDefault(),console.log(this.model);var t=new u;t.userId=this.model.id,t.entity_id=this.model.get("payload").enttypes_id,t.setData(),t.save()},follow:function(e){e.preventDefault(),console.log(e.target);var t=new a;t.userId=this.model.id,t.entity_id=this.model.get("payload").enttypes_id,t.save()},editScore:function(e){if(!this.checkForUser()){routing.trigger("showSignup");return}$(e.currentTarget).hide(),$(e.currentTarget).parents(".score-box-h").find(".edit-score-input-h").attr("type","text").focus()},checkForUser:function(){return!_.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},resumeEditScore:function(e){var t=new s;t.teams_id=$(e.currentTarget).data("id"),t.score=$(e.target).val(),t.gameId=this.model.id,t.set({id:$(e.target).data("id"),games_teams_link_id:$(e.target).data("id"),score:$(e.target).val()}),t.save(),this.$el.find(".edit-score-input-h").attr("type","hidden"),this.$el.find(".edit-score-h").show(),$.when(t.request).done(function(){$(e.currentTarget).parents(".score-box-h").find(".edit-score-h span").html(t.get("score"))})},childViews:{},render:function(e,t,n){m.prototype.render.call(this,e,t,n),$(this.el).find(".txt-game-date_h").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0});var r=[{payload:{name:"AM",value:"AM"}},{payload:{name:"PM",value:"PM"}}],i={};i.records=r,i.recordId="name",i.recordValue="value";var s=this,o=new c({data:i,elementId:"hdn_time-period_h",destination:".spn-ddl-time-period_h",targetView:s,selectedValue:this.model.get("payload").game_ampm,callback:function(e){}});this.renderImage()},renderImage:function(){this.headerImage=new f({model:this.model}),this.headerImage.render(),this.$el.find(".image-outer-h").html(this.headerImage.$el)}}),n});