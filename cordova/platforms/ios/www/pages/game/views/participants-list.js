define(["facade","views","utils","media/views/image-item","text!game/templates/participats-list.html","sportorg/models/uslgamelink","common/models/add","component/fb","component/forms","common/views/add-description"],function(e,t,n,r,i,s,o){var u,a,f=e.$,l=e._,c=require("vendor"),h=n.lib.Channel,p=require("component/fb"),d=t.CollectionView,v=t.SectionView,m=require("component/forms"),g=c.Mustache,y=require("common/views/add-description"),b=d.extend(v.prototype);return b.extend({__super__:d.prototype,template:i,_tagName:"li",_className:"image",page:0,page_limit:8,listView:".image-list",_view:r,events:{"click .see-more-h":"seeMore","mouseover a.tiles":"showText","mouseout a.tiles":"showicon","click .invite-to-fb-h":"inviteFBFriend"},showText:function(e){f(e.target).parent().find("span").removeClass("hide")},showicon:function(e){f(e.target).parent().find("span").addClass("hide")},inviteFBFriend:function(e){var t=this,n={},r=function(){n.subject_id=t.game_id,n.enttype_id=t.controllerObject.basics.get("payload").enttypes_id,routing.trigger("fbInvite",undefined,n)};t.checkForUser()?r():routing.trigger("showSignup",function(e){r(function(){e&&e()})})},renderTemplate:function(){var e=g.to_html(this.template,{target:this.target_id});return console.log(e),this.$el.html(e),this},afterRender:function(){var e=this,t=setInterval(function(){var n=e.$el.find(".character-limit-h"),r=0;if(n.length||r++>=5)clearInterval(t),n.each(function(){e.adJustFontDynamically(f(this))})},500);this.$el.find(".edit-h").on("click",this.editResults)},editResults:function(e){e.preventDefault(),e.stopPropagation();if(f(e.target)[0].tagName=="SPAN")var t=f(e.target).parent().attr("subject-id");else var t=f(e.target).attr("subject-id");if(!this.checkForUser())routing.trigger("showSignup",function(e){addToList(function(){e&&e()})});else{var n={height:"500px",width:"500px",html:'<div id="addParticipantForm"></div>',title:"Edit My Times"};routing.trigger("common-popup-open",n),this.drawAddParticipantForm(t)}},addParticipant:function(){if(!this.checkForUser())routing.trigger("showSignup",function(e){addToList(function(){e&&e()})});else{var e={height:"500px",width:"500px",html:'<div id="addParticipantForm"></div>',title:"Add Me to This Event"};routing.trigger("common-popup-open",e),this.drawAddParticipantForm()}},drawAddParticipantForm:function(e){var t=this,n=!1,r=new s,i=function(){var e=new m({result_time:{form_values:{defaultValue:n?r.get("payload").result_time:"",post_to_server:!0,serverDbField:"result_time",serverKey:"result_time"},type:"Text",fieldClass:"",attr:{placeholder:"00:00:00","class":"txt-result-time"},showLable:!0,label:"Result Time"},bibnumber:{form_values:{defaultValue:n?r.get("payload").bib_number:"",post_to_server:!0,serverDbField:"bib_number",serverKey:"bib_number"},type:"Text",fieldClass:"",attr:{placeholder:"0","class":"txt-bib-number"},showLable:!0,label:"Bib Number"},games_id:{form_values:{serverKey:"games_id",serverDbField:"games_id",post_to_server:!0,value:t.game_id},type:"Hidden"},sports_id:{form_values:{serverKey:"sports_id",serverDbField:"sports_id",post_to_server:!0,value:t.sport_id},type:"Hidden"},submit:{type:"Submit",fieldClass:"button-field",attr:{value:"Save Changes"},showLable:!1,onSubmit:function(e){var s=i.commit();if(s)for(var u in s){var a=f("*[name="+u+"]"),c=a.position();a.parents(".common-modal #modalBody").animate({scrollTop:c.top},"500",function(){a.addClass("focus-error-animation"),setTimeout(function(){a.removeClass("focus-error-animation")},2e3)});break}else{if(t.formValues)var h=t.formValues.getFormValues();else var h=i.getValue();var h=t.formValues.getFormValues();r.set({games_id:h.games_id,sports_id:h.sports_id,result_time:h.result_time,bib_number:h.bib_number}),r.save(),f.when(r.request).done(function(){var e=r.toJSON(),i=new o;i.processItemFromResponse(e.payload.usl.user),routing.trigger("common-popup-close"),t.$el.find(".add-to-event").addClass("link-disabled"),n||(t.collection.add(i),t.collection.length==1&&t.controllerObject&&t.controllerObject.reloadParticipants&&l.isFunction(t.controllerObject.reloadParticipants)&&t.controllerObject.reloadParticipants())}),f.when(r.request).fail(function(e){var n=JSON.parse(e.responseText),r=n.exec_data.error_array;t.formValues.showServersErrors(r)})}}},button:{type:"Button",fieldClass:"button-field",attr:{value:"Cancel","class":"cancel-btn"},onClick:function(){routing.trigger("common-popup-close")},showLable:!1}},f("#addParticipantForm")),i=e.form;t.formValues=e.formValues};e?(r.set("id",e),r.fetch(),f.when(r.request).done(function(){n=!0,i()})):i()},initialize:function(t){var n=this;routing.off("add-to-event"),routing.on("add-to-event",function(){if(!n.checkForUser()){routing.trigger("showSignup");return}n.addParticipant()}),f(".participants-heading-h").removeClass("hide"),t.name?this.name=t.name:this.name="image list",t.collecton&&(this.collection=t.collection),this.controllerObject=t.controllerObject,this.controller=t.controller,this.sports_id=t.sports_id,this.game_id=this.collection.id,this.mainView=this,t.mainView=this,this.renderTemplate();if(!this.collection.limit){n.allData=this.collection.toArray();var r=n.allData.length;n.start=0,n.end=n.page_limit,n.page_limit=8}var r=n.collection.length;(!r||r<n.collection.limit)&&n.$el.find(".see-more-h").hide(),console.log("PL",r,n.collection);if(!r){var i=e.Backbone.Model.extend({});new y({page:"participants",target:this.$el,model:new i,teamName:this.teamName,name:"view - "+Math.random()})}else{var s=this.collection.toArray(),o=!1;for(var u in s)routing.loggedInUserId==s[u].id&&(o=!0)}this.target_id=t.target_id,this.target_url=t.target_url,this.sport_id=t.sport_id,console.error(t);var n=this;n.allData=this.collection.toArray(),n.seeMore(),d.prototype.initialize.call(this,t);if(!this.collection)throw new Error("ImageListView expected options.collection.");l.bindAll(this),this.addSubscribers(),this.setupAddView(),setTimeout(function(){},0)},showAddButton:function(){this.$el.find(".add-to-event").removeClass("link-disabled")},seeMore:function(e){var t=this.allData.length,n=this.page*this.page_limit,r=n+this.page_limit;t<=r&&this.$el.find(".see-more-h").hide(),e?this.collection.add(this.allData.slice(n,r)):this.collection.reset(this.allData.slice(n,r)),this.page++,e&&(this.addSubscribers&&this.addSubscribers(),this.setupAddView&&this.setupAddView())},checkForUser:function(){return!l.isUndefined(routing.userLoggedIn)&&routing.userLoggedIn?!0:!1},childViews:{},setupAddView:function(){function i(e){n.model=e,n.render(),f(this.listView).append(n.el)}var e,t=this,n=new AddImageView({collection:this.collection}),r=this.addChildView(n);this.childViews.form=n,this.callbacks.add(function(){r()}),h("addimage:fetch").subscribe(i)},filterWithImageType:function(e){var t=this.collection;return f.each(t.models,function(t,n){n.selectImageType&&n.selectImageType(e)}),t}})});