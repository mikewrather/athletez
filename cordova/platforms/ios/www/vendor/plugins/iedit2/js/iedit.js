(function(e){function v(e){var n='<table cellspacing="0" cellpadding="0" class="image-display"><tr><td class="displayzone"><div class="container"><img id="displayonly" src="'+e.edited+'">'+'<div class="nav"><a id="goEdit">Make Adjustment</a><a id="closeWindow">All Finished</a></div>'+"</div>"+"</td></tr>"+"</table>";t.find("div.display-main").append(n),t.find("#goEdit").bind("click",function(){T()}),t.find("#closeWindow").bind("click",function(){console.log(window.parent)})}function m(r,i){t=e(r);var s='<table cellspacing="0" cellpadding="0" class="image-edit show"><tr><td class="panzone"></td></tr><tr><td class="tools"><div class="menu"></div></td></tr></table>';t.find("div.display-main").append(s),n=e("<img>",{id:"main_image","class":"image",src:i.original}),u=t.find(".menu"),n.css({display:"none"});var o=e.extend({},p,i);n.data("dim",o);var a=b(!0).append(n);t.find("td.panzone").append(a),n.each(function(){n.height()>0?g(i):n.load(function(){g(i)})})}function g(e){var t=n.data("dim");t.actualWidth=n.width(),t.actualHeight=n.height(),t.width=t.actualWidth,t.height=t.actualHeight,t.topX<0&&(t.topX=0,t.topY=0,t.actualWidth/t.viewportWidth>t.actualHeight/t.viewportHeight?(t.bottomY=t.actualHeight,t.bottomX=t.viewportWidth*(t.actualHeight/t.viewportHeight)):(t.bottomX=t.actualWidth,t.bottomY=t.viewportHeight*(t.actualWidth/t.viewportWidth))),P(),k(),L(t.startX,t.startY),O(),n.css({position:"relative",cursor:"move",display:"block"}),E.setup(),E.addSave(),N.zoomSlider(),n.mousedown(M),n.mouseup(_),n.mouseout(_),w(e),v(t)}function b(t){t?vpClass="viewport edit":vpClass="viewport";var r=n.data("dim");return a=e('<div class="loader"></div>'),e('<div class="'+vpClass+'">').css({backgroundColor:"#fff",position:"relative",overflow:"hidden",width:r.viewportWidth+"px",height:r.viewportHeight+"px"}).append(a)}function w(r){var i=n.width(),s=n.height();c=i,h=s,console.log(n);var o=i/s,u=n.data("dim"),a=u.viewportWidth,f=u.viewportHeight;console.log(u);var l,p,d,v,m=182,g=104,y=m/g;y>o?(d=Math.floor(m),v=Math.floor(d/o)):y==o?(v=Math.floor(g),d=Math.floor(g)):(d=Math.floor(m),v=Math.floor(d*(s/i)));var l=d+9,p=v,b,w;b=Math.floor(a/i*d)-4,w=Math.floor(f/s*v)-4;var E='<div class="navigator"><h1>Navigator</h1><div class="thumb" style="width:'+l+"px; height:"+p+'px">'+'<img id="navigator_thumb_img" src="'+r.original+'" width="'+d+'" height="'+v+'">'+'<div id="marker" style="width:'+b+"px; height:"+w+'px"></div>'+"</div>"+'<p id="navigator_zoom" class="zooming">100%</p>'+"</div>";t.find("div.extra-tools").html(E),document.onmousedown=X,document.onmousemove=$,document.onmouseup=V,e("#marker").mousedown(W)}function S(){t.find(".extra-tools").hide(),t.find("table.image-edit").removeClass("show"),t.find("table.image-display").addClass("show")}function T(){t.find(".extra-tools").show(),t.find("table.image-display").removeClass("show"),t.find("table.image-edit").addClass("show")}function C(e,t){console.log();var r=n.data("dim");r.width=r.actualWidth*e,r.height=r.actualHeight*t,r.oldWidth=r.width,r.oldHeight=r.height,r.x=-(r.topX*e),r.y=-(r.topY*t),console.log("Dim, called in scale function",r)}function k(){var e=n.data("dim"),t=!0;e.width<e.viewportWidth&&(e.height=parseInt(e.actualHeight*(e.viewportWidth/e.actualWidth)),e.width=e.viewportWidth,t=!1),e.height<e.viewportHeight&&(e.width=parseInt(e.actualWidth*(e.viewportHeight/e.actualHeight)),e.height=e.viewportHeight,t=!1),e.width>e.maxWidth&&(e.height=parseInt(e.height*(e.maxWidth/e.width)),e.width=e.maxWidth,t=!1),n.css({width:e.width+"px",height:e.height+"px"});var r=e.width/(-e.x+e.viewportWidth/2),i=e.height/(-e.y+e.viewportHeight/2);return e.x=e.x-(e.width-e.oldWidth)/r,e.y=e.y-(e.height-e.oldHeight)/i,A(),t}function L(e,t){var r=n.data("dim");return r.x=e,r.y=t,A()}function A(){var t=n.data("dim"),r=-t.width+t.viewportWidth,i=-t.height+t.viewportHeight;t.x>0?t.x=0:t.x<r&&(t.x=r),t.y>0?t.y=0:t.y<i&&(t.y=i),n.css({left:t.x+"px",top:t.y+"px"});var s,o,u=e("#navigator_thumb_img").width(),a=e("#navigator_thumb_img").height();return marker_width=Math.floor(t.viewportWidth/n.width()*u)-4,marker_height=Math.floor(t.viewportHeight/n.height()*a)-4,s=Math.floor(Math.abs(t.x)*u/n.width())+9,o=Math.floor(Math.abs(t.y)*a/n.height())+1,e("#marker").css({left:s+"px",top:o+"px"}),n}function O(){var e=n.data("dim"),t=e.width/e.actualWidth;return e.topX=-e.x/t,e.topY=-e.y/t,e.bottomX=e.topX+e.viewportWidth/t,e.bottomY=e.topY+e.viewportHeight/t,typeof e.callback=="function"&&e.callback(t,e),n}function M(e){e.preventDefault();var t=n.data("dim");t.origoX=e.clientX,t.origoY=e.clientY;var r=e.pageX-n.offset({scroll:!1}).left,i=e.pageY-n.offset({scroll:!1}).top;return t.allowPan&&n.mousemove(D),!1}function _(){n.unbind("mousemove"),O()}function D(e){e.preventDefault();var t=n.data("dim"),r=t.origoX-e.clientX,i=t.origoY-e.clientY;t.origoX=e.clientX,t.origoY=e.clientY;var s=t.x-r,o=t.y-i,u=-t.width+t.viewportWidth,a=-t.height+t.viewportHeight;t.x=s,t.y=o,A()}function P(e){var t=n.data("dim"),r=t.viewportWidth/(t.bottomX-t.topX),i=t.viewportHeight/(t.bottomY-t.topY);t.zoom={minX:r,minY:i,maxX:t.maxZoom/100*r,maxY:t.maxZoom/100*i,currentX:r,currentY:i,current:100},t.startZoom>100&&t.startZoom<=200?H(t.startZoom):C(r,i)}function H(e){var t=n.data("dim"),r=t.zoom,s=e/100,o=r.maxX-r.minX,u=s*o,a=r.maxY-r.minY,f=s*a;C(u,f),r.current=e,r.currentX=u,r.currentY=f,i&&k()}function B(e,t){t.value!=r&&(r=t.value,H(r),F(r),j(r))}function j(t){e("#navigator_zoom").html(+t+"%");var r=t/100,i,s,o,u,a=e("#navigator_thumb_img").width(),f=e("#navigator_thumb_img").height(),l=n.data("dim"),c=l.viewportWidth,h=l.viewportHeight,p=n.width(),d=n.height(),v=Math.abs(parseInt(e("#main_image").css("left"))),m=Math.abs(parseInt(e("#main_image").css("top")));i=Math.floor(c/p*a)-4,s=Math.floor(h/d*f)-4,o=Math.floor(v*a/p)+9,u=Math.floor(m*f/d)+1,e("#marker").css({width:i+"px",height:s+"px",left:o+"px",top:u+"px"})}function F(t){e("a.ui-slider-handle").html("<p>"+t+"%</p>")}function I(){var t=n.data("dim");console.log(t);var r={"image-width":t.width,"image-height":t.height,"crop-width":t.viewportWidth,"crop-height":t.viewportHeight,"crop-x":Math.abs(t.x),"crop-y":Math.abs(t.y),zoom:t.zoom.current,original:n.attr("src"),_:Math.random()};a.addClass("show"),e.ajax({type:"post",url:"/api/user/savecrop",data:{model:JSON.stringify(r)},error:function(e,t,n){console.log("There was an error.",e,t,n)},success:function(t){console.log(t),a.removeClass("show");if(t.exec_data.exec_error==0)q(t.payload.image_path);else{var n='<div id="upload-error">There was an error during the process. Please try again.</div>';e(".panzone").append(n)}}})}function q(e){t.find("img#displayonly").attr("src",e),S()}function W(t){x=parseInt(e("#marker").css("left")),y=parseInt(e("#marker").css("top")),document.all?(U=window.event.clientX-x,z=window.event.clientY-y):(U=t.pageX-x,z=t.pageY-y)}function X(){R=!0}function V(){R=!1}function $(t){if(!R)return;t=t||window.event;var r=t.target||t.srcElement,i=r.id;if(i!="navigator_thumb_img"&&i!="marker")return;x=document.all?window.event.clientX-U:t.pageX-U,y=document.all?window.event.clientY-z:t.pageY-z;var s=n.width(),o=n.height(),u=e("#navigator_thumb_img").width(),a=e("#navigator_thumb_img").height(),f,l,c,h;c=parseInt(e("#marker").css("left")),h=parseInt(e("#marker").css("top")),f=parseInt(e("#marker").css("width")),l=parseInt(e("#marker").css("height"));var p=u-f-4,d=a-l-4;x<0&&(x=9),y<0&&(y=1),x+f>u&&(x=u-f+5),y+l>a&&(y=a-l-3),x<9&&(x=9),y<1&&(y=1),e("#marker").css({left:x+"px",top:y+"px"});var v=s/u,m=Math.floor(-1*(x-9)*v),g=Math.floor(-1*(y-1)*v);L(m,g)}function J(e){var t=null;return typeof e.target!="undefined"?t=e.target:t=e.srcElement,t.nodeName.toLowerCase()=="li"?t:t.parentNode.nodeName.toLowerCase()=="li"?t.parentNode:t}function K(e){var t="";for(var n in e)t+=n+": "+e[n]+"\n"}var t,n,r,i,s=100,o,u,a,f,l,c,h,p={allowZoom:!0,allowPan:!0,viewportWidth:400,viewportHeight:300,maxWidth:2e3,maxZoom:200,topX:-1,topY:-1,bottomX:-1,bottomY:-1,startZoom:100,callback:function(e,t,n,r){}},d={start:function(e){var t=this;return this.each(function(){m(this,e)})},destroy:function(){n.unbind(),i.unbind(),u.empty(),t.unbind()}},E={setup:function(){var e='<div class="nav"></div><div class="submit-contain"></div>';u.html(e)},addTool:function(t,n,r){var i=u.find(".nav"),s=e("<a>",{id:t}).text(t).bind("click",function(){i.find("a").removeClass("selected"),e(this).addClass("selected"),u.find("div.section.show").removeClass("show"),u.find("div#"+t+".section").addClass("show")});i.append(s);var o=e("<div>",{"class":"section",id:t}).html(n);u.append(o),r()},addEdit:function(){},addSave:function(){var e='<div id="save" class="button">Save</div>';u.find(".submit-contain").append(e),u.find("#save.button").bind("click",function(){I()})}},N={zoomSlider:function(){var r='<p class="cent min"></p><div id="zoom-slider"></div><p class="cent max"></p>',u=function(){var r=n.data("dim");i=t.find("#zoom-slider");if(i.length>0){var u=r.startZoom>100&&r.startZoom<=200?r.startZoom:100;o=r.maxZoom,i.slider({range:"min",min:s,max:o,value:u,change:B,slide:B})}e("p.cent.min").text(s.toString()+"%"),e("p.cent.max").text(o.toString()+"%"),F(u)};E.addTool("Zoom",r,u)}};e.fn.iedit=function(t){if(d[t])return d[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return d.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.iedit")};var R=!1,U=0,z=0})(jQuery);