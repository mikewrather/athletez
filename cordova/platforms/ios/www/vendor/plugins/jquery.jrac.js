/* jQuery Resize And Crop (jrac)
 * A jQuery 1.4+ and jQueryUi 1.8+ plugin under GNU GENERAL PUBLIC LICENSE version 2 lisense.
 * Copyright (c) 2011 Cedric Gampert - cgampert@gmail.com
 */

(function(e){e.fn.jrac=function(t){var n={crop_width:200,crop_height:100,crop_x:0,crop_y:0,crop_resize:!0,crop_aspect_ratio:null,image_width:null,image_height:null,zoom_min:100,zoom_max:3e3,viewport_image_surrounding:!1,viewport_width:null,viewport_height:null,viewport_resize:!0,viewport_content_left:0,viewport_content_top:0,viewport_onload:null};return this.each(function(){if(!e(this).is("img"))return;var r=!1;typeof t=="object"?e.extend(n,t):t=="destroy"&&(r=!0);var i=e(this),s=!1;i.parent().hasClass("jrac_viewport")&&(s=!0),s&&r?(i.draggable("destroy"),i.parent().find(".jrac_crop").remove(),i.parent().parent().find(".jrac_zoom_slider").remove(),i.parent().append(i.data("original")),i.parent().unwrap(),i.unwrap(),i.remove()):i.data("original",i.clone());if(r)return;s||i.hide().css("position","absolute").wrap('<div class="jrac_container"><div class="jrac_viewport"></div></div>');var o=i.parent(),u=o.parent(),a=e('<div class="jrac_loading" />');o.append(a);var f=function(){e.extend(i,{scale_proportion_locked:!0,originalWidth:i.width(),originalHeight:i.height()}),i.width(n.image_width).height(n.image_height),n.viewport_image_surrounding?o.width(i.width()).height(i.height()):o.width(n.viewport_width).height(n.viewport_height),i.css({left:n.viewport_content_left,top:n.viewport_content_top});if(!s){var t=e('<div class="jrac_zoom_slider"><div class="ui-slider-handle"></div></div>').width(o.width()).slider({value:i.width(),min:n.zoom_min,max:n.zoom_max,start:function(n,r){e.extend(t,{on_start_width_value:r.value,on_start_height_value:i.height()})},slide:function(e,n){var r=Math.round(t.on_start_height_value*n.value/t.on_start_width_value);i.height(r),i.width(n.value),o.observator.notify("jrac_image_height",r),o.observator.notify("jrac_image_width",n.value)}});u.append(t),n.viewport_resize&&o.resizable({resize:function(e,n){t.width(n.size.width)}}),i.draggable({drag:function(e,t){t.position.left!=t.originalPosition.left&&o.observator.notify("jrac_crop_x",o.observator.crop_position_x()),t.position.top!=t.originalPosition.top&&o.observator.notify("jrac_crop_y",o.observator.crop_position_y())}});var r=e('<div class="jrac_crop"><div class="jrac_crop_drag_handler"></div></div>').css({width:n.crop_width,height:n.crop_height,left:n.crop_x+n.viewport_content_left,top:n.crop_y+n.viewport_content_top}).draggable({containment:o,handle:"div.jrac_crop_drag_handler",drag:function(e,t){t.position.left!=t.originalPosition.left&&o.observator.notify("jrac_crop_x",o.observator.crop_position_x()),t.position.top!=t.originalPosition.top&&o.observator.notify("jrac_crop_y",o.observator.crop_position_y())}});n.crop_resize&&r.resizable({containment:o,aspectRatio:n.crop_aspect_ratio,resize:function(e,t){t.size.width!=t.originalSize.width&&o.observator.notify("jrac_crop_width",r.width()),t.size.height!=t.originalSize.height&&o.observator.notify("jrac_crop_height",r.height())}}),o.append(r)}e.extend(o,{$container:u,$image:i,$crop:r,$zoom_widget:t,observator:{items:{},register:function(e,t,n){e&&t&&(this.items[e]={element:t,callback:n})},unregister:function(e){delete this.items[e]},notify:function(t,n){if(this.items[t]){var r=this.items[t].element,s=this.items[t].callback;r.trigger(t,[o,n]),e.isFunction(s)&&s.call(o,t,r,n)}i.trigger("jrac_events",[o])},notify_all:function(){this.notify("jrac_crop_x",this.crop_position_x()),this.notify("jrac_crop_y",this.crop_position_y()),this.notify("jrac_crop_width",r.width()),this.notify("jrac_crop_height",r.height()),this.notify("jrac_image_width",i.width()),this.notify("jrac_image_height",i.height())},crop_position_x:function(){return r.position().left-i.position().left},crop_position_y:function(){return r.position().top-i.position().top},crop_consistent:function(){return this.crop_position_x()>=0&&this.crop_position_y()>=0&&this.crop_position_x()+r.width()<=i.width()&&this.crop_position_y()+r.height()<=i.height()},set_property:function(e,n){n=parseInt(n);if(isNaN(n))return;switch(e){case"jrac_crop_x":r.css("left",n+i.position().left);break;case"jrac_crop_y":r.css("top",n+i.position().top);break;case"jrac_crop_width":r.width(n);break;case"jrac_crop_height":r.height(n);break;case"jrac_image_width":if(i.scale_proportion_locked){var s=Math.round(i.height()*n/i.width());i.height(s),this.notify("jrac_image_height",s)}i.width(n),t.slider("value",n);break;case"jrac_image_height":if(i.scale_proportion_locked){var o=Math.round(i.width()*n/i.height());i.width(o),this.notify("jrac_image_width",o),t.slider("value",o)}i.height(n)}this.notify(e,n)}}}),a.hide(),a.remove(),i.show(),e.isFunction(n.viewport_onload)&&(n.viewport_onload.call(o),o.observator.notify_all())},l=i.attr("src");/^data:image/.test(l)?f():(l=l+(l.search(/\?/)<0?"?":"&")+"jracrandom="+(new Date).getTime(),e("<img>").attr("src",l).load(f()))})}})(jQuery);