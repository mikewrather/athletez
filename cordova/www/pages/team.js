define(["require","text!team/templates/layout.html","votes/views/vote","facade","controller","models","views","utils","team/models/basics","team/models/addmedia","team/collections/upcoming_schedules","team/collections/recent_schedules","team/collections/competitor_teams","team/collections/rosters","team/collections/videos","team/collections/images","team/collections/comments","profile/collections/commentsof","team/collections/commentson","team/collections/orgs","team/collections/fans","team/views/header","team/views/add-media","sportorg/views/competitorteam-list","team/views/commentof-list","team/views/commenton-list","sportorg/views/roster-list","team/views/video-list","team/views/image-list","team/views/comment-list","team/views/menu","media/models/image","schedules/views/schedule-list","roster/views/roster","profile/views/fans-image-list","common/views/add-media-buttons","text!common/templates/add-media-buttons.html","text!common/templates/add-fans-buttons.html","text!common/templates/add-games-buttons.html","votes/views/vote"],function(e,t,n){var r,i=e("facade"),s=e("controller"),o=e("models"),u=e("views"),a=e("utils"),f=e("team/models/basics"),l=e("team/models/addmedia"),c=e("team/collections/upcoming_schedules"),h=e("team/collections/recent_schedules"),p=e("team/collections/competitor_teams"),d=e("team/collections/orgs"),v=e("team/collections/videos"),m=e("team/collections/images"),g=e("team/collections/fans"),y=e("team/collections/comments"),b=e("profile/collections/commentsof"),w=e("team/collections/commentson"),E=e("team/views/header"),S=e("team/views/add-media"),x=e("schedules/views/schedule-list"),T=e("sportorg/views/competitorteam-list"),N=e("team/views/video-list"),C=e("team/views/image-list"),k=e("sportorg/views/teamroster-list"),L=e("team/views/comment-list"),A=e("team/views/commentof-list"),O=e("team/views/commenton-list"),M=e("profile/views/fans-image-list"),_=e("team/views/menu"),D=e("roster/views/roster"),P=e("media/models/image"),H=e("votes/views/vote"),B=e("common/views/add-media-buttons"),j=e("text!common/templates/add-media-buttons.html"),F=e("text!common/templates/add-fans-buttons.html"),I=e("text!common/templates/add-games-buttons.html"),q=u.LayoutView,R=i.$,U=i._,z=a.debug,W=a.lib.Channel,X=[base_url+"pages/team/team.css"];return r=s.extend({initialize:function(e){var t=this;return W("load:css").publish(X),U.bindAll(t),this.scheme=[],this.handleOptions(e),e.params&&this.setParamsArray(e.params),this.init(),this},handleOptions:function(e){this.id=e.teamId,this.userId=e.userId},init:function(){this.setupLayout().render(),this.createData(),this.handleDeferreds(),this.handleClickEvents()},handleClickEvents:function(){R(document).off("click",".green-left-heading"),R(document).on("click",".green-left-heading",function(){R(this).hasClass("down-arrow-heading")?(R(this).removeClass("down-arrow-heading"),R(this).next().slideUp(),R(this).next().attr("id")=="commenton-wrap"&&R(this).next().next().slideUp(),R(this).next().hasClass("commentson-outer-box-h")&&R(this).next().next().slideUp(),R(this).parent().parent().next().slideUp()):(R(this).addClass("down-arrow-heading"),R(this).next().slideDown(),R(this).next().attr("id")=="commenton-wrap"&&R(this).next().next().slideDown(),R(this).next().hasClass("commentson-outer-box-h")&&R(this).next().next().slideDown(),R(this).parent().parent().next().slideDown())})},createData:function(){function t(t,n,r){if(e.ajaxCalls&&e.ajaxCalls.length){for(var i in e.ajaxCalls)console.error("here"),e.ajaxCalls[i].abort();e.ajaxCalls=[]}e.refreshPage(),e.games=new d,e.games.id=n,e.games.sport_id=t,e.games.targetElement="#games_div",e.ajaxCalls.push(e.games.fetch()),e.images=new m,e.images.team_id=n,e.images.sport_id=t,e.images.targetElement="#image-wrap",e.ajaxCalls.push(e.images.fetch()),e.fans=new g,e.fans.id=n,e.fans.sport_id=t,e.fans.targetElement="#fans-div",e.ajaxCalls.push(e.fans.fetch());var s=e.basics.get("payload").enttypes_id;e.commentson=new w,e.commentson.subject_entity_type=s,e.commentson.savePath="/team/addcomment/"+n,e.commentson.id=n,e.commentson.targetElement="#comment_div",e.setupRosterView(),e.ajaxCalls.push(e.commentson.fetch()),e.handleDeferredsDynamic()}this.basics=new f({id:this.id}),this.basics.targetElement="#main",this.basics.fetch(),this.addmedia=new l,this.addmedia.id=this.id;var e=this;e.ajaxCalls=[],W("new-fan","unique").subscribe(this.refreshFansPage),routing.on("refresh-teampage",function(e,n,r){t(e,n,r)})},refreshFansPage:function(){var e,t=this;this.fansListView&&(R(this.fansListView.destination).html(""),e=R.inArray(this.fansListView,this.scheme),~e&&this.scheme.splice(e,1),this.fans=new g,this.fans.id=this.id,this.fans.sport_id=R("#sports-h").val(),this.fans.targetElement="#fans-div",this.ajaxCalls.push(this.fans.fetch()),R.when(this.fans.request).done(function(e){t.setupFansListView()}))},reloadFans:function(){this.refreshFansPage()},handleDeferreds:function(){var e=this;R.when(this.basics.request).done(function(){e.setupHeaderView(),e.setupRosterView(),e.userId&&e.setUpVoteView()})},setupCommentOfListView:function(){var e;e=new A({collection:this.commentsof,destination:".commentsoff-outer-box-h",name:"team comments off view"})},deleteOldView:function(e){var t=this.scheme.length;for(var n=0;n<t;n++)this.scheme[n].name==e&&this.scheme[n].remove()},setupRosterView:function(e,t){if(!e&&!t)var n=this.basics.get("payload"),e=n.id,t=n.org_sport_link_obj.org.name;this.oldRosterViewName&&this.deleteOldView(this.oldRosterViewName),this.oldRosterViewName="roster images"+Math.random();var r,s=i.Backbone.Collection.extend({});r=new D({model:new s,team_id:e,entityId:this.basics.get("payload").enttypes_id,team_name:t,controllerObject:this,name:this.oldRosterViewName,destination:"#roster-wrap",teamName:this.basics.get("payload").team_name}),this.scheme.push(r),this.layout.render()},setupCommentOnListView:function(){this.commentOnListView=new O({collection:this.commentson,destination:".commentson-outer-box-h",name:"team comments on view "}),this.scheme.push(this.commentOnListView),this.layout.render()},showVote:function(){var e;this.votesView&&(R(this.votesView.destination).unbind().html(""),e=R.inArray(this.votesView,this.scheme),~e&&this.scheme.splice(e,1),this.setUpVoteView())},refreshPage:function(){var e;this.commentOnListView&&(this.commentOnListView.unbind().remove(),R(this.commentOnListView.destination).unbind().html(""),e=R.inArray(this.commentOnListView,this.scheme),~e&&this.scheme.splice(e,1)),this.gamesView&&(R(this.gamesView.destination).html(""),e=R.inArray(this.gamesView,this.scheme),~e&&this.scheme.splice(e,1)),this.fansListView&&(R(this.fansListView.destination).html(""),e=R.inArray(this.fansListView,this.scheme),~e&&this.scheme.splice(e,1)),this.imageListView&&(R(this.imageListView.destination).html(""),e=R.inArray(this.imageListView,this.scheme),~e&&this.scheme.splice(e,1))},handleDeferredsDynamic:function(){var e=this;R.when(e.commentson.request).done(function(){e.setupCommentOnListView()}),R.when(e.games.request).done(function(){e.setupGameView()}),R.when(e.fans.request).done(function(t){e.setupFansListView()}),R.when(this.images.request).done(function(){e.setupImages()})},setupFansListView:function(){this.addmedia.teamName=this.basics.get("payload").team_name,this.addmedia.setData();var e=new B({target:".fans-add-icons-h",heading:"FANS",template:F,controllerObject:this,collection:this.fans,model:this.addmedia,teamName:this.addmedia.teamName,inviteData:{invite_type:"follow",subject_id:this.basics.get("payload").id,enttypes_id:this.basics.get("payload").enttypes_id}});this.fansListView=new M({collection:this.fans,destination:"#fans-div",controllerObject:this,pageName:"team",target_id:this.id,data:this.basics.toJSON(),name:"fansView",teamName:this.addmedia.teamName}),this.scheme.push(this.fansListView),this.layout.render()},setupHeaderView:function(){var e,t=this;e=new E({model:this.basics,name:"Header",controllerObject:t,destination:"#main-header"});var n=new _({model:this.basics,name:"Menu View",headerView:e,controllerObject:t,destination:"#menu-container"});this.scheme.push(n),this.scheme.push(e),this.layout.render()},setupAddMediaView:function(e){var t;this.addMediaView&&(R(this.addMediaView.destination).html(""),t=R.inArray(this.addMediaView,this.scheme),~t&&this.scheme.splice(t,1)),this.addmedia.teamName=this.basics.get("payload").team_name,this.addmedia.setData(),this.addMediaView=new S({model:this.addmedia,team_id:this.basics.id,name:"Add_Media",destination:e}),this.scheme.push(this.addMediaView),this.layout.render()},setUpVoteView:function(){this.votesView=new H({model:this.basics,id:this.id,destination:"#votes-area-h",name:"votes_view"}),this.scheme.push(this.votesView),this.layout.render()},setupUpcomingSchedules:function(){var e;e=TeamScheduleListView.extend({name:"Upcoming_Schedule_List"}),this.upcomingScheduleListView=new e({collection:this.upcoming_schedules,destination:"#upcoming-schedule",name:"upcoming_schedule"}),this.scheme.push(this.upcomingScheduleListView),this.layout.render()},setupRecentSchedules:function(){var e;e=TeamScheduleListView.extend({name:"Recent_Schedule_List"}),this.recentScheduleListView=new e({collection:this.recent_schedules,destination:"#recent-schedule",name:"recent_schedule"}),this.scheme.push(this.recentScheduleListView),this.layout.render()},getOrgData:function(){var e,t=this;this.gamesView&&(R(this.gamesView.destination).html(""),e=R.inArray(this.gamesView,this.scheme),~e&&this.scheme.splice(e,1)),t.games.fetch(),R.when(t.games.request).done(function(){t.setupGameView()})},setupGameView:function(){var e=this.basics.get("payload");this.addmedia.teamName=this.basics.get("payload").team_name,this.addmedia.setData();var t=new B({target:".games-add-icons-h",heading:"GAMES",template:I,model:this.addmedia,teamName:this.addmedia.teamName});if(e.org_sport_link_obj.sport.sport_type_id!="2"){R(".game-green-heading").removeClass("hide");var n=x.extend({tagName:"div"});this.gamesView=new n({teams_id:this.id,controller:this,collection:this.games,destination:"#games_div",teamRecords:!0,teamName:this.addmedia.teamName}),this.scheme.push(this.gamesView),this.layout.render()}},setupCompetitorTeams:function(){this.competitorTeamListView=new T({collection:this.competitor_teams,destination:"#competitor-teams",name:"competitor_teams"}),this.scheme.push(this.competitorTeamListView),this.layout.render()},setupRosters:function(){this.rosterListView=new k({collection:this.rosters,destination:"#roster-wrap",name:"roster_wrap"}),this.scheme.push(this.rosterListView),this.layout.render()},setupVideos:function(){this.videoListView=new N({collection:this.videos,destination:"#video-wrap",name:"video_wrap"}),this.scheme.push(this.videoListView),this.layout.render()},initVoteView:function(){var e=new n({name:"vote View",destination:"#votes-area-h",model:this.basics,userId:this.id});this.scheme.push(e),this.layout.render()},setupImages:function(e){var t=this;this.addmedia.teamName=this.basics.get("payload").team_name,this.addmedia.setData();var n=new B({target:".media-add-icons-h",heading:"PHOTO/VIDEO",template:j,page_base:"team",ent_id:t.id,sports_id:R("#sports-h").val(),controllerObject:t,model:t.addmedia,teamName:this.addmedia.teamName});routing.off("image-upload-success"),routing.on("image-upload-success",function(e){t.updateImages(e)}),routing.off("setup-add-icons"),routing.on("setup-add-icons",function(e){t.setupAddMediaView(e)}),this.imageListView=new C({collection:this.images,destination:"#image-wrap",target_id:this.id,target_url:"/api/team/addimage/",sport_id:R("#sports-h").val(),name:"image_wrap ",user_id:this.userId,media_id:this.media_id,pageName:"team",triggerItem:"setup-add-icons",teamName:t.addmedia.teamName}),this.scheme.push(this.imageListView),this.layout.render()},reloadImages:function(){var e=this,t;this.imageListView&&(R(this.imageListView.destination).html(""),t=R.inArray(this.imageListView,this.scheme),~t&&this.scheme.splice(t,1)),e.images.fetch(),R.when(e.images.request).done(function(){e.setupImages()})},updateImages:function(e){var t=new P;t.processItemFromPayload(e),t.selectImageType(this.imageListView.imagetype),this.imageListView.collection.add(t),this.imageListView.allData&&this.imageListView.allData.push(t.toJSON()),this.imageListView.collection.length==1&&this.reloadImages()},setupComments:function(){this.commentListView=new L({collection:this.comments,destination:"#comment-wrap",name:"comment_wrap"}),this.scheme.push(this.commentListView),this.layout.render()},setupLayout:function(){var e;return e=new q({scheme:this.scheme,destination:"#main",template:t,displayWhen:"ready"}),this.layout=e,this.layout}}),r});