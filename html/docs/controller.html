<!DOCTYPE html>  <html> <head>   <title>controller.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="application.html">                 application.js               </a>                                           <a class="source" href="controller.html">                 controller.js               </a>                                           <a class="source" href="facade.html">                 facade.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               controller.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Controller</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>A controller object should called withing a route handler function, and may 
be responsible for getting relevant state (application models) to generate 
a page (layout), (also responsible for setting state when routes change). 
The controller passes dependent data (models/collections) and constructed 
view objects for a requested page to the layout manager. As a side-effect 
the use of controllers prevents the routes object from becoming bloated and 
tangled. A route should map to a controller which then kicks off the page 
view, keeping the route handling functions lean.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Requires <code>define</code>
Returns <code>{Controller}</code> constructor, abstract object, must extend and define 
an initialize method.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span><span class="p">([</span><span class="s1">&#39;facade&#39;</span><span class="p">,</span> <span class="s1">&#39;collections&#39;</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;utils&#39;</span><span class="p">],</span> 
<span class="kd">function</span><span class="p">(</span><span class="nx">facade</span><span class="p">,</span> <span class="nx">collections</span><span class="p">,</span> <span class="nx">models</span><span class="p">,</span> <span class="nx">utils</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">Controller</span><span class="p">,</span>
        <span class="nx">ApplicationStates</span> <span class="o">=</span> <span class="nx">collections</span><span class="p">.</span><span class="nx">ApplicationStates</span><span class="p">,</span>
        <span class="nx">EventModel</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">EventModel</span><span class="p">,</span>
        <span class="nx">_</span> <span class="o">=</span> <span class="nx">facade</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span>
        <span class="nx">$</span> <span class="o">=</span> <span class="nx">facade</span><span class="p">.</span><span class="nx">$</span><span class="p">,</span>
        <span class="nx">Channel</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">lib</span><span class="p">.</span><span class="nx">Channel</span><span class="p">,</span>
        <span class="nx">extend</span> <span class="o">=</span> <span class="nx">facade</span><span class="p">.</span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Contoller Constructor </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">route</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">route</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">appStates</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">appStates</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ApplicationStates</span><span class="p">();</span> <span class="c1">// is Singleton</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">appStates</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">appStates</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">appStates</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">route</span> <span class="o">&amp;&amp;</span> <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">appStates</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">getStoredState</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Assign Backbone's <code>extend</code> / inherit methods to Controller contructor fn</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Controller prototype </h2>

<p>Use as a template for contrete controller prototypes with 
YourController = Controller.extend({ /<em>...</em>/ });</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Public Methods</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Define your own initialize method in contrete controller, 
this is an example</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">triggerPublishers</span><span class="p">();</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">handleOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>this.getEventData();</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">addSubscribers</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">handleDeferreds</span><span class="p">();</span>

            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Create methods as needed to add views to layout
add Section Views to this.sections['byName'] = sectionView 
(instance object)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <pre><code>setupMySectionView: function() {
    // var viewName = 'myCustomView'
    // this.sections[viewName] = catalogListView;
    // if (this.meta.XXXX === viewName) {
    //     this.meta.activeViews.push(viewName);
    // }
},
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Call custom methods to add sections to layout (active or not)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">setupSections</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>this.setupMySectionView();</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Add active views to layout's scheme option, to setup use 
this.scheme.push(sectionView)
e.g. use custom logic to choose views as active ... 
this.scheme.push(this.sections[activeViews[i]]);</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">setupScheme</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{},</span>

        <span class="nx">setupLayout</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">layoutName</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <pre><code>layoutName = new LayoutView({  
    scheme: this.scheme,  
    destination: "#content",  
    template: layoutTemplate, // use text! prefix for html docs  
    displayWhen: "ready"  
    // defaults...   
    // transitionMethod: "showHide"  
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">layout</span> <span class="o">=</span> <span class="nx">layoutName</span><span class="p">;</span>

            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">;</span> 
        <span class="p">},</span>

        <span class="nx">handleDeferreds</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

            <span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span>
                <span class="kc">null</span> <span class="c1">// (remove null) adding deferred objects, comma separated </span>
            <span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>controller.setupSections(); <br />
controller.setupScheme(); <br />
controller.setupLayout().render(); <br />
setTimeout(function() { <br />
    controller.renderInActiveViews(); <br />
}, 250);</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">});</span>
        <span class="p">},</span>

        <span class="nx">addSubscribers</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Channel("controllerName:routeChange", "nomemory").subscribe(this.routeChange);</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">},</span>

        <span class="nx">removeSubscribers</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Channel("controllerName:routeChange").unsubscribe(this.routeChange);</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">},</span>
        
        <span class="nx">triggerPublishers</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Channel('load:css').publish(cssArr);</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h2>Privileged Properties</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Property: <code>meta</code>
holds data and references used to configure the layout's display strategy <br />
{String} names are added to {Array} <code>viewNames</code> <br />
{String} names for active views are kept in the {Array} <code>activeViews</code> <br />
viewNames can be a superset of activeViews.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">meta</span><span class="o">:</span> <span class="p">{</span> 
            <span class="s2">&quot;activeViews&quot;</span><span class="o">:</span> <span class="p">[],</span>
            <span class="s2">&quot;viewNames&quot;</span><span class="o">:</span> <span class="p">[]</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h2>Priveleged Methods</h2>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">handleOptions</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">handleOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Change or extend the default <code>route</code> change handler</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">routeChange</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">route</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">routeChange</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Redefine with null to ignore the default state change subscribers, 
otherwise do not use this in a contrete controller's prototype</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">addStateChangeSubscriber</span><span class="o">:</span> <span class="kc">null</span>

    <span class="p">};</span> <span class="c1">// end Controller.prototype template</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h2>Properties to treat as privileged</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p><strong>Property:</strong> {Object} <code>data</code> <br />
data is the object which is meta or other data can be set to for persistence</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p><strong>Property:</strong> {Object} <code>layout</code> <br />
There is some coupling between controllers, app states collection and layouts
layout is the view of section views managing the experience for the layout</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">layout</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p><strong>Property:</strong> {Array} <code>scheme</code> <br />
A layout needs one or more sections, the scheme array contains active 
section view instances that a layout view will manage.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">scheme</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><strong>Property:</strong> {Object} <code>sections</code> <br />
Each view that can be used by the controller's package should be named
assign properties by unique names to this object 
e.g. this.sections[viewName] = myView;</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sections</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p><strong>Property:</strong> {String} <code>route</code> <br />
this property should be the route that was first called, a controller should
lookup meta data using this property</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">route</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h2>Methods to treat as Privileged, extend as needed </h2>

<p>Perhaps call prototype as well.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p><strong>Method:</strong> <code>handleOptions</code> <br />
To prevent the initialize method from getting long use this function to
do whatever you need with an {Object} <code>options</code> passed to initialize</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">handleOptions</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">useFixtures</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">useFixturesForWebServices</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p><strong>Method:</strong> <code>transitionActiveViews</code> <br />
Each section in a layout requires a {String} name, each section 
in a layout may have more than one view this utility methods makes
the transition between view instances within a single section 
of the layout.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">transitionActiveViews</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">transitionView</span><span class="p">,</span> 
            <span class="nx">layout</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">,</span> 
            <span class="nx">sectionName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">sectionName</span><span class="p">,</span>
            <span class="nx">activeViews</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">activeViews</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="nx">format</span> <span class="o">=</span> <span class="nx">format</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">presentation</span><span class="p">;</span>
        <span class="nx">transitionView</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">viewName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">viewName</span> <span class="o">===</span> <span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">state</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;not-rendered&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="nx">layout</span><span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">sectionName</span><span class="p">,</span> <span class="nx">view</span><span class="p">);</span>
                <span class="nx">activeViews</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">viewName</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">iterateOverLayoutViews</span><span class="p">(</span><span class="nx">transitionView</span><span class="p">);</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p><strong>Method:</strong> <code>renderInActiveViews</code> <br />
When this.viewNames has a length > this.activeViews then its a good practice
to defer the rendering of the view instances that are not on stage (hidden).
Typically this can be called with a setTimeout call so that the work
is done when the call stack is finsihed to process the layout's initial state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">renderInActiveViews</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">renderCallback</span><span class="p">;</span>

        <span class="nx">renderCallback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">state</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;not-rendered&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">view</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">view</span><span class="p">.</span><span class="nx">state</span><span class="p">(</span><span class="s1">&#39;not-displayed&#39;</span><span class="p">);</span>
                <span class="p">});</span>
                <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">iterateOverLayoutViews</span><span class="p">(</span><span class="nx">renderCallback</span><span class="p">);</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p><strong>Method:</strong> <code>iterateOverLayoutViews</code> <br />
Param {Function} <code>callback</code> <br />
An iteration over this.activeViews, when a viewName is not listed 
in this.activeViews the callback is called with the found view and name</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">iterateOverLayoutViews</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">activeViews</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">activeViews</span><span class="p">,</span> 
            <span class="nx">sections</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sections</span><span class="p">,</span>
            <span class="nx">viewNames</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">viewNames</span><span class="p">,</span>
            <span class="nx">viewName</span><span class="p">,</span> <span class="nx">view</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">viewNames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">viewName</span> <span class="o">=</span> <span class="nx">viewNames</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">activeViews</span><span class="p">,</span> <span class="nx">viewName</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">view</span> <span class="o">=</span> <span class="nx">sections</span><span class="p">[</span><span class="nx">viewName</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">callback</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">viewName</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p><strong>Method:</strong> <code>routeChange</code> <br />
Param {String} <code>route</code> <br />
Param {Object} <code>stateModel</code> with properties <code>name</code> and <code>data</code> <br />
Param {Function} <code>callback</code> that accepts a (layout.state) data argument (or not) <br />
The controller instance should act as a medaitor between all views that
are used in the layout, the section views should not directly handle any
route changes but rather publish a change, the controller subscribes:
e.g. <code>Channel("controllerName:routeChange", "nomemory").subscribe(this.routeChange)</code>;
the publisher should pass at least a route or an object with the route 
and other data e.g. <code>Channel('events:routeChange').publish(link)</code>;</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">routeChange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">stateModel</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">data</span><span class="o">:</span> <span class="p">{}</span> <span class="p">},</span> <span class="nx">msg</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">route</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">route</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;Controller routeChange expects string as 1st argument.&quot;</span><span class="p">;</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">route</span> <span class="o">=</span> <span class="nx">route</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">state</span><span class="p">({</span><span class="s2">&quot;route&quot;</span><span class="o">:</span> <span class="nx">route</span><span class="p">});</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">state</span><span class="p">();</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">stateModel</span> <span class="o">||</span> <span class="p">{});</span>
            <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">appStates</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
            <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
            <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">appStates</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">route</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Controller routeChange method called with: &quot;</span> <span class="o">+</span> <span class="nx">route</span><span class="p">);</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p><strong>Method:</strong> <code>getStoredState</code> <br />
Requires {String} this.route to be defined <br />
Returns {Object} <code>data</code> <br />
Wraps method in ApplicationStates to retrieve data by the route name</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getStoredState</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stored</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Controller does not have route property.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">stored</span> <span class="o">=</span> <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">appStates</span><span class="p">.</span><span class="nx">findInCollectionOrStorage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">stored</span> <span class="o">&amp;&amp;</span> <span class="nx">stored</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="o">?</span> <span class="nx">stored</span><span class="p">.</span><span class="nx">data</span> <span class="o">:</span> <span class="nx">stored</span><span class="p">;</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p><strong>Method:</strong> <code>addStateChangeSubscriber</code> <br />
Param {String} <code>viewName</code> <br />
Param {Function} <code>callback</code> <br />
Subscribes to a view's Channel <code>__viewName__:stageChanged</code> published topic
as a view's stage is changed the layout's state data is updated and stored
to ignore the view's Channel redefine this function and set to null</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addStateChangeSubscriber</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">viewName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">msg</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">viewName</span> <span class="o">||</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">viewName</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">msg</span> <span class="o">=</span> <span class="s2">&quot;controller method addStateChangeSubscriber expected string as 1st argument.&quot;</span><span class="p">;</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">function</span> <span class="nx">stateChangeHandler</span><span class="p">(</span><span class="nx">lastState</span><span class="p">,</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">_viewName</span> <span class="o">=</span> <span class="nx">viewName</span><span class="p">,</span>
                <span class="nx">_callback</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">,</span>
                <span class="nx">_controller</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">,</span>
                <span class="nx">stateData</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">_controller</span><span class="p">.</span><span class="nx">layout</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">stateData</span> <span class="o">=</span> <span class="nx">_controller</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">state</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">stateData</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">appStates</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="nx">_controller</span><span class="p">.</span><span class="nx">route</span><span class="p">,</span>
                        <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="nx">stateData</span><span class="p">,</span>
                        <span class="s2">&quot;expires&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="cm">/*secs*/</span><span class="mi">60</span> <span class="o">*</span> <span class="cm">/*mins*/</span><span class="mi">7</span> <span class="o">*</span> <span class="cm">/*hrs*/</span><span class="mi">24</span> <span class="o">*</span> <span class="cm">/*days*/</span><span class="mi">4</span><span class="p">)),</span>
                        <span class="s2">&quot;storage&quot;</span><span class="o">:</span> <span class="s2">&quot;localStorage&quot;</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_callback</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">_callback</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">_callback</span><span class="p">(</span><span class="nx">lastState</span><span class="p">,</span> <span class="nx">state</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">Channel</span><span class="p">(</span><span class="nx">viewName</span> <span class="o">+</span> <span class="s1">&#39;:stateChanged&#39;</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">stateChangeHandler</span><span class="p">);</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <h2>Methods to treat as Private, please don't mess with these...</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p><strong>Method:</strong> <code>remove</code> <br />
call this to kill this object's properties and prepare for garbage collection
good to use this to prevent memory leaks in a single page application.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="k">this</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">webServices</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>service : "",</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">};</span>

    <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">useFixturesForWebServices</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_webServices</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">_webServices</span><span class="p">,</span> <span class="nx">Controller</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">webServices</span><span class="p">,</span> <span class="p">{</span> </pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>hello: "/test/fixtures/hello"</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">hello</span><span class="o">:</span> <span class="s2">&quot;/api/hello&quot;</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">webServices</span> <span class="o">=</span> <span class="nx">_webServices</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Controller</span><span class="p">;</span>
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 